<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä ‚Äî Falling Items (–ö–ì–ë)</title>

  <style>
    :root{
      --ui-acc:#ffd700;
      --card:#151515;
      --ink:#eee;
      --muted:#b7b7b7;
      --stroke:#2a2a2a;
      --gap:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#0d0d0d; color:var(--ink);
      font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--stroke);
      position:sticky; top:0; background:#0d0d0d; z-index:2;
    }
    header img{height:42px}
    header h1{font-size:20px; margin:0; color:var(--ui-acc); font-weight:800}
    main{display:grid; grid-template-columns: 430px 1fr; gap:22px; padding:20px; max-width:1500px; width:100%; margin:0 auto}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:18px;
      box-shadow:0 0 28px rgba(255,215,0,.06);
    }
    .card h2{margin:0 0 14px; font-size:18px; color:var(--ui-acc)}
    label{display:block; margin:12px 0 8px; font-size:15px; color:#fff; font-weight:600}
    input[type="text"], input[type="number"], input[type="url"], textarea, select{
      width:100%; background:#101010; color:#fff; border:1px solid #3a3a3a; border-radius:10px; padding:12px 14px; font-size:16px;
      outline:none; transition:border-color .15s ease, box-shadow .15s ease;
    }
    textarea{min-height:110px; resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:#4b4b4b; box-shadow:0 0 0 3px rgba(255,215,0,.16)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
    .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap)}
    .inline{display:flex; gap:12px; align-items:center}
    .hint{color:var(--muted); font-size:13px; margin-top:8px}
    .pill{display:inline-block; padding:8px 12px; border:1px dashed #444; border-radius:999px; color:#bbb; font-size:13px}

    button{
      background:linear-gradient(90deg,#ffbf00,#ffd700); color:#000; border:none; border-radius:12px; font-weight:800;
      padding:14px 18px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; font-size:16px;
    }
    button:hover{transform:translateY(-1px); box-shadow:0 8px 26px rgba(255,215,0,.28)}
    .btn-ghost{background:transparent; color:#fff; border:1px solid #444}
    .btn-danger{background:#a80000; color:#fff}
    .stack{display:flex; flex-direction:column; gap:var(--gap)}
    .levels .level{background:#111; border:1px solid #2a2a2a; border-radius:12px; padding:16px}
    .level h3{margin:0 0 10px; font-size:16px; color:#fff; display:flex; align-items:center; justify-content:space-between}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap}
    .right{display:flex; gap:10px; align-items:center; justify-content:flex-end}

    footer{padding:14px 20px; color:#888; border-top:1px solid var(--stroke); display:flex; align-items:center; justify-content:center; gap:8px}
    footer a{color:var(--ui-acc); text-decoration:none}

    /* –ü–†–ï–î–ü–†–û–°–ú–û–¢–† */
    .preview-wrap{display:grid; grid-template-rows:auto 1fr; gap:12px; height:100%}
    .preview-controls{display:grid; grid-template-columns:1fr auto; gap:12px}
    .preview-stage{background:#0a0a0a; border:1px dashed #333; border-radius:12px; display:flex; align-items:center; justify-content:center; padding:24px; min-height:320px}
    .preview-item{
      position:relative; display:inline-flex; align-items:center; justify-content:center;
      min-width:140px; min-height:64px; transition:all .2s ease; isolation:isolate;
      /* –±–µ–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ñ–æ–Ω —Ü–≤–µ—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ —Å—Ç–∞–≤–∏–º –Ω–∞ .bg */
    }
    /* –¥–≤—É—Ö—Å–ª–æ–π–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–∞–∫ –≤ main.html */
    .preview-item .bg{
      position:absolute; inset:0; z-index:0;
      background:transparent; border:0 solid #fff; opacity:1; box-shadow:none;
      transition:filter .15s ease;
    }
    .preview-item .content{
      position:relative; z-index:1; display:flex; align-items:center; justify-content:center;
      padding:20px 26px; max-width:320px; max-height:220px; text-align:center; line-height:1.15;
    }
    .preview-item .content span{
      display:inline-block; font-weight:800; white-space:nowrap;
    }
    .preview-item .content img{
      display:block; max-width:180px; max-height:140px; object-fit:contain; pointer-events:none;
    }

    /* –§–ò–ì–£–†–´ ‚Äî –∫–ª–∏–ø—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ–Ω */
    .shape-rect .bg{ border-radius:10px }
    .shape-rounded .bg{ border-radius:20px }
    .shape-circle .bg{ border-radius:50% }
    .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
    .shape-star .bg{ clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%) }

    /* –≠–§–§–ï–ö–¢–´ (–Ω–∞ —Ñ–æ–Ω-—Å–ª–æ–π) */
    .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
    .fx-3d .bg{ box-shadow:7px 7px 20px rgba(0,0,0,.5), inset -5px -5px 12px rgba(255,255,255,.22) }
    .fx-glow .bg{ box-shadow:0 0 18px var(--glow, #00f0ff) }
    .fx-border .bg{ border-style:solid }

    /* –†–ï–ó–£–õ–¨–¢–ê–¢ */
    .result{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:start}
    .result textarea{height:120px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .status{margin-top:10px; padding:10px 12px; border-radius:10px; background:#0e0e0e; border:1px solid #2a2a2a; color:#c9c9c9; display:none}
    .status.ok{color:#b8ffd6; border-color:#1f6f47}
    .status.bad{color:#ffbbbb; border-color:#7a1f1f}
    .status.warn{color:#ffe3a6; border-color:#6f591f}
  </style>

  <!-- Google Fonts (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –Ω—É–∂–Ω—ã–π) -->
  <link id="gf" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap">
</head>
<body>
  <header>
    <a href="https://kgbgamecorp.ru" target="_blank" rel="noopener">
      <img src="https://con.xl.ru/fnfLZuvpAUiDaqDs8d1-2g/images/kcJYv7OsYUSGt5AfGq5jIw.png" alt="–ö–ì–ë">
    </a>
    <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∏–≥—Ä—ã ¬´–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã¬ª ‚Äî –ö–ì–ë</h1>
  </header>

  <main>
    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <section class="card stack">
      <h2>‚öôÔ∏è –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

      <div class="row">
        <div>
          <label>–Ø–∑—ã–∫ / —Ä–µ–∂–∏–º</label>
          <select id="language"></select>
        </div>
        <div>
          <label>–®—Ä–∏—Ñ—Ç</label>
          <select id="font"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
          <input type="number" id="fontSize" value="24" min="10" max="100">
        </div>
        <div>
          <label>–¶–≤–µ—Ç —à—Ä–∏—Ñ—Ç–∞</label>
          <input type="color" id="textColor" value="#ffffff">
        </div>
      </div>

      <div class="row">
        <div>
          <label>–°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è (1‚Äì10)</label>
          <input type="number" id="speed" value="5" min="1" max="10">
        </div>
        <div>
          <label>–ö–∞—Å—Ç–æ–º–Ω—ã–π –∫—É—Ä—Å–æ—Ä (URL, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="url" id="cursorUrl" placeholder="https://.../cursor.png">
        </div>
      </div>

      <div class="row">
        <div class="inline" style="align-items:end;">
          <input type="checkbox" id="randomLevels"><label for="randomLevels">–†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π</label>
        </div>
      </div>

      <div class="card">
        <h2>üé® –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π)</h2>

        <div class="row">
          <div>
            <label>–§–∏–≥—É—Ä–∞</label>
            <select id="shape">
              <option value="rect">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</option>
              <option value="rounded" selected>–°–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π</option>
              <option value="circle">–ö—Ä—É–≥</option>
              <option value="diamond">–†–æ–º–±</option>
              <option value="star">–ó–≤–µ–∑–¥–∞</option>
            </select>
          </div>
          <div>
            <label>–§–æ–Ω ‚Äî —Ü–≤–µ—Ç</label>
            <input type="color" id="bgColor" value="#1a1a1a">
          </div>
        </div>

        <label>–§–æ–Ω ‚Äî –∫–∞—Ä—Ç–∏–Ω–∫–∞ (URL, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input type="url" id="bgImage" placeholder="https://.../bubble.png">

        <div class="hint">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω URL –∫–∞—Ä—Ç–∏–Ω–∫–∏, —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å URL ‚Äî –≤–µ—Ä–Ω—ë—Ç—Å—è —Ü–≤–µ—Ç.</div>

        <div class="row-3" style="margin-top:6px">
          <div>
            <label>–†–∞–º–∫–∞ (—Ü–≤–µ—Ç)</label>
            <input type="color" id="borderColor" value="#ffffff">
          </div>
          <div>
            <label>–†–∞–º–∫–∞ (—Ç–æ–ª—â–∏–Ω–∞, px)</label>
            <input type="number" id="borderWidth" value="1" min="0">
          </div>
          <div class="inline" style="align-items:end;">
            <label style="width:100%">–†–∞–º–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞?</label>
            <input type="checkbox" id="borderOn" checked>
          </div>
        </div>

        <div class="row">
          <div class="inline">
            <input type="checkbox" id="shadowOn" checked><label for="shadowOn">–¢–µ–Ω—å</label>
          </div>
          <div class="inline">
            <input type="checkbox" id="glowOn"><label for="glowOn">–ü–æ–¥—Å–≤–µ—Ç–∫–∞</label>
            <input type="color" id="glowColor" value="#00f0ff" title="–¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏">
          </div>
        </div>

        <div class="row">
          <div class="inline">
            <input type="checkbox" id="fx3d"><label for="fx3d">3D —ç—Ñ—Ñ–µ–∫—Ç</label>
          </div>
          <div>
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞ (0‚Äì1)</label>
            <input type="text" id="opacity" value="1">
          </div>
        </div>
      </div>

      <div class="card" style="border-style:dashed">
        <h2>üß™ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>

        <div class="preview-controls">
          <input type="text" id="previewValue" placeholder="–¢–µ–∫—Å—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏..." value="Preview">
          <div class="right">
            <button class="btn-ghost" id="btnText">–¢–µ–∫—Å—Ç</button>
            <button class="btn-ghost" id="btnImage">–ö–∞—Ä—Ç–∏–Ω–∫–∞</button>
          </div>
        </div>

        <div class="preview-stage">
          <div id="previewItem" class="preview-item shape-rounded fx-shadow" style="--glow:#00f0ff;">
            <div class="bg"></div>
            <div class="content"><span id="previewText" style="font-weight:800; font-size:24px">Preview</span></div>
          </div>
        </div>

        <div class="hint">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ö–∞—Ä—Ç–∏–Ω–∫–∞-—Ñ–æ–Ω –ø–ª–∞—à–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç + –æ—Ç—Å—Ç—É–ø—ã. –¢–µ–∫—Å—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö.</div>
      </div>
    </section>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: —É—Ä–æ–≤–Ω–∏ + –ø—É–±–ª–∏–∫–∞—Ü–∏—è -->
    <section class="card stack">
      <h2>üéØ –£—Ä–æ–≤–Ω–∏</h2>
      <div class="levels" id="levels"></div>
      <div class="toolbar">
        <button id="addLevel">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
        <span class="pill">–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ —É—Ä–æ–≤–Ω–µ–π</span>
      </div>

      <h2 style="margin-top:8px">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h2>
      <div class="row">
        <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å iframe</button>
        <button id="testBtn" class="btn-ghost">üîç –í–∞–ª–∏–¥–∞—Ü–∏—è JSON</button>
      </div>

      <div class="result" style="margin-top:10px">
        <textarea id="iframeOut" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è iframe –¥–ª—è Genially"></textarea>
        <button id="copyBtn" class="btn-ghost">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="status" id="status"></div>
      <div class="hint">–ü–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–¥–æ–∂–¥–∞—Ç—å 30‚Äì60 —Å–µ–∫—É–Ω–¥ (–∫–µ—à GitHub Pages).</div>
    </section>
  </main>

  <footer>¬© 2025 <a href="https://kgbgamecorp.ru" target="_blank" rel="noopener">–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ë—É–¥—É—â–µ–≥–æ</a></footer>

  <script>
    // ===== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ =====
    // –í–ê–ñ–ù–û: —ç—Ç–æ —Ç–≤–æ–π —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä –∏ –∫–ª—é—á
    const ENDPOINT    = "https://server-kjnn.onrender.com/publish";
    const PUBLISH_KEY = "nika_read_pub_2025";
    // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ò–ú–ï–ù–ù–û falling main:
    const BASE_MAIN   = "https://nikashum93.github.io/falling/main.html";

    // ===== helpers =====
    const $  = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const statusBox = $('#status');
    function setStatus(html, cls=''){ statusBox.style.display='block'; statusBox.className='status '+cls; statusBox.innerHTML=html; }
    function slug(s){return (s||'untitled').toString().toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,40)||'note'}
    function stamp(){const d=new Date(),p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;}
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // ===== –Ø–∑—ã–∫–∏ –∏ —à—Ä–∏—Ñ—Ç—ã =====
    const FONT_MAP = {
      ru: ["PT Sans","Rubik","Lobster","Marck Script","Cormorant","Montserrat","Open Sans","Noto Sans","Inter","Nunito","Comfortaa","Neucha"],
      en: ["Roboto","Open Sans","Montserrat","Inter","Poppins","Playfair Display","Indie Flower","Special Elite","Anton","Rubik","Nunito","Caveat"],
      fr: ["Noto Sans","Playfair Display","Parisienne","Montserrat","Cormorant","Rubik","Inter","Merriweather"],
      es: ["Montserrat","Alegreya","Caveat","Roboto","Open Sans","Rubik","Nunito","PT Sans"],
      de: ["PT Sans","Rubik","Inter","Montserrat","Open Sans","Playfair Display","Source Sans 3"],
      zh: ["Noto Sans SC","ZCOOL XiaoWei","Ma Shan Zheng","Noto Sans"],
      ja: ["Noto Sans JP","Noto Serif JP","Kosugi Maru","Noto Sans"],
      math: ["Latin Modern Math","Rubik"]
    };
    const LANG_LABELS = {
      ru:"–†—É—Å—Å–∫–∏–π", en:"English (Latin)", fr:"Fran√ßais", es:"Espa√±ol",
      de:"Deutsch", zh:"‰∏≠Êñá (Chinese)", ja:"Êó•Êú¨Ë™û (Japanese)", math:"–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (LaTeX)"
    };

    function fillLanguageSelect(){
      const sel = $('#language');
      sel.innerHTML = '';
      Object.keys(FONT_MAP).forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = LANG_LABELS[k];
        sel.appendChild(opt);
      });
      sel.value = 'ru';
    }
    function fillFontsForLanguage(lang){
      const sel = $('#font');
      sel.innerHTML = '';
      (FONT_MAP[lang] || FONT_MAP.en).forEach(f=>{
        const opt = document.createElement('option');
        opt.textContent = f;
        sel.appendChild(opt);
      });
      sel.value = FONT_MAP[lang][0];
      applyGoogleFont(sel.value);
    }

    // Google Fonts –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞
    function applyGoogleFont(fontName){
      const gf = document.getElementById('gf');
      const family = fontName.replace(/ /g, '+');
      gf.href = `https://fonts.googleapis.com/css2?family=${family}:wght@400;700&display=swap`;
      const text = $('#previewText');
      text.style.fontFamily = fontName + ", system-ui, sans-serif";
      text.style.fontSize = (parseInt($('#fontSize').value,10)||24) + 'px';
    }

    // ===== –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä =====
    // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚Äî .preview-item –≤–Ω—É—Ç—Ä–∏: .bg (—Ñ–æ–Ω) –∏ .content (–∫–æ–Ω—Ç–µ–Ω—Ç)
    function updatePreview(){
      const item    = $('#previewItem');
      const bg      = item.querySelector('.bg');
      const content = item.querySelector('.content');
      const text    = $('#previewText');
      const val     = $('#previewValue').value.trim();

      // —Ä–µ–∂–∏–º
      const asImage = item.dataset.mode === 'image' || /^https?:\/\//i.test(val);

      // —Å–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤ –∏ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      item.className = 'preview-item';
      item.style.removeProperty('--glow');

      // —Ñ–∏–≥—É—Ä–∞
      const shape = $('#shape').value;
      item.classList.add('shape-' + shape);

      // —ç—Ñ—Ñ–µ–∫—Ç—ã
      item.classList.toggle('fx-shadow', $('#shadowOn').checked);
      item.classList.toggle('fx-3d',     $('#fx3d').checked);
      item.classList.toggle('fx-glow',   $('#glowOn').checked);
      item.style.setProperty('--glow', $('#glowColor').value);

      // —Ä–∞–º–∫–∞ –Ω–∞ bg-—Å–ª–æ–µ
      const borderOn = $('#borderOn').checked && Number($('#borderWidth').value) > 0;
      item.classList.toggle('fx-border', borderOn);
      if(borderOn){
        bg.style.borderColor = $('#borderColor').value;
        bg.style.borderWidth = Number($('#borderWidth').value) + 'px';
      } else {
        bg.style.borderWidth = '0px';
        bg.style.borderColor = 'transparent';
      }

      // —Ñ–æ–Ω-—Ü–≤–µ—Ç / —Ñ–æ–Ω-–∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ
      const bgImg = $('#bgImage').value.trim();
      const bgCol = $('#bgColor').value;
      if(bgImg){
        // –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≥–ª–∞–≤–Ω–∞—è, —Ü–≤–µ—Ç —É–±–∏—Ä–∞–µ–º
        bg.style.background = `url(${bgImg}) center/contain no-repeat`;
      } else {
        // —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç
        bg.style.background = bgCol;
      }
      // –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞/–æ–±–ª–∞–∫–∞
      const op = clamp(parseFloat($('#opacity').value||'1'), 0, 1);
      bg.style.opacity = op;

      // —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      text.style.color      = $('#textColor').value;
      text.style.fontSize   = (parseInt($('#fontSize').value,10)||24) + 'px';
      text.style.fontFamily = $('#font').value + ", system-ui, sans-serif";

      // –∫–æ–Ω—Ç–µ–Ω—Ç
      // —Å–Ω–∞—á–∞–ª–∞ —É–±–µ—Ä—ë–º –∫–∞—Ä—Ç–∏–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
      const oldImg = content.querySelector('img');
      if(oldImg) oldImg.remove();

      if(asImage){
        // —Ä–µ–∂–∏–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∑–∞–¥–∞–Ω–∏—è (–∫–æ–Ω—Ç–µ–Ω—Ç)
        text.style.display = 'none';
        const img = document.createElement('img');
        img.src = val || 'https://via.placeholder.com/200x140?text=Image';
        content.appendChild(img);
      } else {
        // —Ä–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è (–∫–æ–Ω—Ç–µ–Ω—Ç)
        text.style.display = 'inline-block';
        text.textContent = val || 'Preview';
      }

      // –ü–æ–¥–≥–æ–Ω —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–ª–∞—à–∫–∏ –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç + –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–ª—è ¬´–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö¬ª —Ñ–∏–≥—É—Ä
      fitGeometryBox(item);
      autoFitText(item, parseInt($('#fontSize').value, 10) || 24, 12);
      // –ø–æ–≤—Ç–æ—Ä–Ω—ã–π fit –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∞—Å—å –∫–∞—Ä—Ç–∏–Ω–∫–∞
      fitGeometryBox(item);
    }

    // –∫–≤–∞–¥—Ä–∞—Ç/–∫—Ä—É–≥/–∑–≤–µ–∑–¥–∞/—Ä–æ–º–± ‚Äî –¥–µ–ª–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç –ø–æ –±–æ–ª—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ + –ø–æ–ª—è; –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ ‚Äî –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É
    function fitGeometryBox(item){
      const bg      = item.querySelector('.bg');
      const content = item.querySelector('.content');
      if(!bg || !content) return;

      // —Å–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–º–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —á—Ç–æ–±—ã –∏–∑–º–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
      item.style.width  = '';
      item.style.height = '';

      // –∏–∑–º–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
      const r = content.getBoundingClientRect();
      const padX = 10;  // ¬´–≤–æ–∑–¥—É—Ö¬ª –≤–æ–∫—Ä—É–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–¥–æ–±–∞–≤–∫–∞ –∫ —Ñ–æ–Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ)
      const padY = 10;

      // –¥–µ—Ñ–æ–ª—Ç: —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç
      let w = Math.max(140, Math.ceil(r.width))  + padX*2;
      let h = Math.max(64,  Math.ceil(r.height)) + padY*2;

      const shape = $('#shape').value;
      if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
        const size = Math.max(w, h) + 30; // –¥–æ–ø. –≤–æ–∑–¥—É—Ö, —á—Ç–æ–±—ã —Ñ–∏–≥—É—Ä—ã –Ω–µ –∫–∞–∑–∞–ª–∏—Å—å –ø—Ä–∏–ø–ª—é—Å–Ω—É—Ç—ã–º–∏
        w = size; h = size;
      }

      item.style.width  = w + 'px';
      item.style.height = h + 'px';
    }

    // –∞–≤—Ç–æ—É–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —É–º–µ—Å—Ç–∏–ª—Å—è –≤ –ø–ª–∞—à–∫—É
    function autoFitText(item, startPx, minPx){
      const span = item.querySelector('.content span');
      if(!span) return;
      let fs = startPx;
      const maxW = item.clientWidth  - 24;
      const maxH = item.clientHeight - 24;

      const fits = ()=>{
        const r = span.getBoundingClientRect();
        return (r.width <= maxW && r.height <= maxH);
      };
      while(fs > minPx){
        span.style.fontSize = fs + 'px';
        if(fits()) break;
        fs -= 1;
      }
    }

    // ===== –£—Ä–æ–≤–Ω–∏ =====
    function levelTemplate(idx){
      const wrap = document.createElement('div');
      wrap.className = 'level';
      wrap.innerHTML = `
        <h3>–£—Ä–æ–≤–µ–Ω—å <span class="num">${idx+1}</span>
          <span class="right">
            <button type="button" class="btn-ghost up"   title="–í—ã—à–µ">‚ñ≤</button>
            <button type="button" class="btn-ghost down" title="–ù–∏–∂–µ">‚ñº</button>
            <button type="button" class="btn-danger del">–£–¥–∞–ª–∏—Ç—å</button>
          </span>
        </h3>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è / Target</label>
        <input type="text" class="target" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±—É–∫–≤–∞ S –∏–ª–∏ Animals">
        <div class="row">
          <div>
            <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ)</label>
            <textarea class="correct" placeholder="sun\nstar\nsnake\nhttps://.../cat.png\n\\frac{3}{4}"></textarea>
          </div>
          <div>
            <label>–û—Ç–≤–ª–µ–∫–∞—é—â–∏–µ –æ–±—ä–µ–∫—Ç—ã</label>
            <textarea class="wrong" placeholder="dog\napple\ncar\nhttps://.../car.png\n\\log_{2}{8}"></textarea>
          </div>
        </div>
        <div class="row">
          <div>
            <label>–¢–∞–π–º–µ—Ä —É—Ä–æ–≤–Ω—è (—Å–µ–∫.)</label>
            <input type="number" class="timer" value="30" min="5">
          </div>
          <div class="hint" style="align-self:end">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: —Å–ª–æ–≤–∞, URL –∫–∞—Ä—Ç–∏–Ω–æ–∫, LaTeX-—Ñ–æ—Ä–º—É–ª—ã (—Ä–µ–∂–∏–º Math).</div>
        </div>
      `;
      wrap.querySelector('.del').onclick = () => { wrap.remove(); renumber(); };
      wrap.querySelector('.up').onclick  = () => { const p=wrap.previousElementSibling; if(p){ wrap.parentNode.insertBefore(wrap,p); renumber(); } };
      wrap.querySelector('.down').onclick= () => { const n=wrap.nextElementSibling; if(n){ wrap.parentNode.insertBefore(n,wrap); renumber(); } };
      return wrap;
    }
    function renumber(){ $$('#levels .level .num').forEach((el,i)=> el.textContent = i+1); }
    function addLevel(){ const levels=$('#levels'); const idx=levels.querySelectorAll('.level').length; levels.appendChild(levelTemplate(idx)); renumber(); }

    // ===== –°–±–æ—Ä —Ñ–æ—Ä–º—ã ‚Üí JSON =====
    function collectConfig(){
      const levels = [];
      $$('#levels .level').forEach(div=>{
        levels.push({
          target: div.querySelector('.target').value.trim(),
          correct: div.querySelector('.correct').value.split('\n').map(s=>s.trim()).filter(Boolean),
          wrong:   div.querySelector('.wrong').value.split('\n').map(s=>s.trim()).filter(Boolean),
          timer:   Math.max(5, parseInt(div.querySelector('.timer').value||'30',10))
        });
      });

      const cfg = {
        language: $('#language').value,
        font: $('#font').value,
        fontSize: Math.max(10, parseInt($('#fontSize').value||'24',10)),
        textColor: $('#textColor').value,
        speed: clamp(parseInt($('#speed').value||'5',10), 1, 10),
        style: {
          shape: $('#shape').value,
          bgColor: $('#bgColor').value,
          bgImage: $('#bgImage').value.trim(),
          borderOn: $('#borderOn').checked,
          borderColor: $('#borderColor').value,
          borderWidth: Math.max(0, parseInt($('#borderWidth').value||'0', 10)),
          shadow: $('#shadowOn').checked,
          glow: $('#glowOn').checked,
          glowColor: $('#glowColor').value,
          fx3d: $('#fx3d').checked,
          opacity: clamp(parseFloat($('#opacity').value||'1'), 0, 1)
        },
        cursor: $('#cursorUrl').value.trim(),
        randomLevels: $('#randomLevels').checked,
        levels
      };
      return cfg;
    }

    // ===== –í–∞–ª–∏–¥–∞—Ü–∏—è =====
    function validate(cfg){
      if(!cfg.levels.length) return '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å.';
      for(const [i,lv] of cfg.levels.entries()){
        if(!lv.target) return `–£—Ä–æ–≤–µ–Ω—å ${i+1}: —É–∫–∞–∂–∏—Ç–µ target.`;
        if(lv.correct.length===0 && lv.wrong.length===0) return `–£—Ä–æ–≤–µ–Ω—å ${i+1}: –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç.`;
      }
      return null;
    }

    // ===== –ü—É–±–ª–∏–∫–∞—Ü–∏—è ‚Üí Render ‚Üí texts/data/*.json =====
    async function publish(){
      try{
        const cfg = collectConfig();
        const err = validate(cfg);
        if(err){ alert(err); return; }

        setStatus("üîÆ –ü—É–±–ª–∏–∫—É—é‚Ä¶","warn");

        // id = slug(title/timestamp) ‚Äî –ø—É—Å—Ç—å –±–µ—Ä—ë–º –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏–ª–∏ shape, –µ—Å–ª–∏ target –ø—É—Å—Ç
        const rootTitle = (cfg.levels[0]?.target || 'falling').toString();
        const id = `${slug(rootTitle)}-${stamp()}`;

        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–≤–Ω–æ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–≥—Ä—ã
        const res = await fetch(ENDPOINT, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "X-Publish-Key": PUBLISH_KEY
          },
          body: JSON.stringify({
            id,               // texts/data/${id}.json
            mode:"json",
            folder:"data",
            content: JSON.stringify(cfg, null, 2)
          })
        });

        if(!res.ok){
          const msg = await res.text().catch(()=>res.statusText);
          throw new Error(msg);
        }

        // iframe –Ω–∞ FALLING main
        const iframe = `<iframe src="${BASE_MAIN}?id=${encodeURIComponent(id)}" width="900" height="640" style="border:0;" allow="autoplay; microphone" allowfullscreen></iframe>`;
        $('#iframeOut').value = iframe;

        setStatus(`‚úÖ –ì–æ—Ç–æ–≤–æ! ID: <b>${id}</b><br>–ï—Å–ª–∏ JSON –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø–æ–¥–æ–∂–¥–∏ 30‚Äì60 —Å–µ–∫ (–∫–µ—à GitHub Pages).`, "ok");
        alert('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! –ü–æ–¥–æ–∂–¥–∏ 30‚Äì60 —Å–µ–∫—É–Ω–¥ (–∫–µ—à GitHub Pages).');
      }catch(e){
        setStatus('‚ò† –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: '+e.message, 'bad');
        alert('–°–µ—Ç—å/—Å–µ—Ä–≤–µ—Ä: '+e.message);
      }
    }

    // ===== UI —Å–æ–±—ã—Ç–∏—è =====
    // —è–∑—ã–∫ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à—Ä–∏—Ñ—Ç–æ–≤
    $('#language').addEventListener('change', e=>{ fillFontsForLanguage(e.target.value); updatePreview(); });

    // —Å–º–µ–Ω–∞ —à—Ä–∏—Ñ—Ç–∞ / —Ä–∞–∑–º–µ—Ä–∞
    $('#font').addEventListener('change', e=> { applyGoogleFont(e.target.value); updatePreview(); });
    $('#fontSize').addEventListener('input', ()=> { applyGoogleFont($('#font').value); updatePreview(); });

    // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: –ª—é–±—ã–µ –ø–æ–ª—è
    ;['textColor','opacity','shape','bgColor','bgImage','borderColor','borderWidth','borderOn','shadowOn','glowOn','glowColor','fx3d','cursorUrl','randomLevels','previewValue','speed']
      .forEach(id => {
        const el = $('#'+id);
        el.addEventListener('input', updatePreview);
        el.addEventListener('change', updatePreview);
      });

    // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    $('#btnText').onclick = (e)=>{ e.preventDefault(); const it=$('#previewItem'); it.dataset.mode='text'; updatePreview(); }
    $('#btnImage').onclick= (e)=>{ e.preventDefault(); const it=$('#previewItem'); it.dataset.mode='image'; updatePreview(); }

    // —É—Ä–æ–≤–Ω–∏
    $('#addLevel').addEventListener('click', (e)=>{ e.preventDefault(); addLevel(); });

    // –ø—É–±–ª–∏–∫–∞—Ü–∏—è
    $('#saveBtn').addEventListener('click', publish);

    // —Ç–µ—Å—Ç
    $('#testBtn').addEventListener('click', ()=> {
      const cfg = collectConfig();
      const err = validate(cfg);
      if(err){ alert(err); return; }
      alert('JSON –≤–∞–ª–∏–¥–µ–Ω. –£—Ä–æ–≤–Ω–µ–π: '+cfg.levels.length);
      console.log(cfg);
    });

    // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ iframe
    $('#copyBtn').addEventListener('click', ()=> {
      const ta = $('#iframeOut');
      if(!ta.value.trim()){ alert('–°–Ω–∞—á–∞–ª–∞ –æ–ø—É–±–ª–∏–∫—É–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å iframe.'); return; }
      navigator.clipboard.writeText(ta.value.trim())
        .then(()=> setStatus("üìù iframe —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω","ok"))
        .catch(err => { console.error(err); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.'); });
    });

    // ===== init =====
    fillLanguageSelect();
    fillFontsForLanguage($('#language').value);
    addLevel(); // –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    applyGoogleFont($('#font').value);
    updatePreview();
  </script>
</body>
</html>
