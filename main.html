<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falling Items ‚Äî Game (–ö–ì–ë)</title>

<!--
  –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞:
  1) –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–≤–æ–π —Å—Ü–µ–Ω—ã (–¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ Genially).
  2) –í–∏–∑—É–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ HUD/–æ–≤–µ—Ä–ª–µ–µ–≤ –±–µ—Ä—ë—Ç—Å—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ¬´—Ä–∞–º–∫–∏¬ª —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.
     - –ï—Å–ª–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –≤—ã–±—Ä–∞–Ω —Ü–≤–µ—Ç —Ä–∞–º–∫–∏ ‚Üí –æ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è Primary –¥–ª—è HUD.
     - –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ä–∞–º–∫–∏ ‚Üí Secondary/–ø–æ–¥–ª–æ–∂–∫–∏.
     - –ï—Å–ª–∏ –≤–º–µ—Å—Ç–æ ¬´—Ä–∞–º–∫–∏¬ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —É–∫–∞–∑–∞–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ñ–æ–Ω–æ–≤–∞—è
       —Ç–µ–∫—Å—Ç—É—Ä–∞ –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ (–Ω–æ HUD –≤—Å—ë —Ä–∞–≤–Ω–æ –∫—Ä–∞—Å–∏—Ç—Å—è –∏–∑ —Ü–≤–µ—Ç–æ–≤ —Ä–∞–º–∫–∏).
  3) –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω + –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (RU/EN/ES/FR/DE/JA/ZH/AR). –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–æ ?language=.
  4) –ü–æ–ø—Ä–∞–≤–ª–µ–Ω —Ö–∏—Ç–±–æ–∫—Å: –∫–ª–∏–∫–∏ –ø–æ –ø–∞–¥–∞—é—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è (z-index, pointer-events).
  5) –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä: –∑–≤–µ–∑–¥–∞/—Ä–æ–º–±/–∫—Ä—É–≥ –Ω–µ –ø—Ä–∏–ø–ª—é—â–∏–≤–∞—é—Ç—Å—è, –±–ª–æ–∫ –∫–≤–∞–¥—Ä–∞—Ç–∏—Ç—Å—è –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç.
  6) –°–≤–µ—Ä—Ö—É ‚Äî ¬´–º—è–≥–∫–∏–π¬ª –≥—Ä–∞–¥–∏–µ–Ω—Ç –∑–∞–¥–Ω–∏–∫–∞ —Å—Ü–µ–Ω—ã, –Ω–æ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏.
  7) –ü–æ–ª–Ω—ã–π –∫–æ–¥ –±–µ–∑ –≤—ã—Ä–µ–∑–æ–∫, >500 —Å—Ç—Ä–æ–∫.
-->

<style>
/* ===== CSS-–ü–ï–†–ï–ú–ï–ù–ù–´–ï –¢–ï–ú–´ (–ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –∏–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤) ===== */
:root{
  /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å (HUD/–æ–≤–µ—Ä–ª–µ–∏) ‚Äî –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º –∏–∑ ¬´—Ä–∞–º–∫–∏¬ª —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
  --ui-primary: #ffd700;    /* –æ—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç (–±–µ—Ä—ë–º –∏–∑ borderColor) */
  --ui-on-primary: #000;    /* —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∞–∫—Ü–µ–Ω—Ç–µ */
  --ui-bg: #151515;         /* —Ñ–æ–Ω –ø–∞–Ω–µ–ª–µ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–±–µ—Ä—ë–º –∏–∑ bgColor) */
  --ui-stroke: #2a2a2a;     /* —Ç–æ–Ω –≥—Ä–∞–Ω–∏—Ü */
  --ui-ink: #e9e9e9;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç HUD */
  --ui-muted: #bdbdbd;      /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç */
  --ui-shadow: rgba(0,0,0,.38);

  /* –¢–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å–ª–æ–≤–∞) */
  --text-color: #ffffff;
  --text-font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  --text-size-px: 24px;

  /* –≠—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –ø–∞–¥–∞—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  --glow: #00f0ff;

  /* –†–∞–¥–∏—É—Å—ã –ø–∞–Ω–µ–ª–µ–π */
  --r-s: 10px;
  --r-m: 12px;
  --r-l: 16px;
}

/* ===== –ë–ê–ó–û–í–ê–Ø –°–¶–ï–ù–ê (–≤—Å—ë –≤–æ–∫—Ä—É–≥ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ) ===== */
html, body{
  height:100%;
  margin:0;
  background: transparent;   /* —á—Ç–æ–±—ã –≤ iFrame –≤–æ–∫—Ä—É–≥ –±—ã–ª–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ */
}
body{
  color: var(--ui-ink);
  font-family: var(--text-font);
  overflow: hidden;          /* –∏–≥—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–µ–Ω */
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ü–µ–Ω—ã; —Ñ–æ–Ω —Å—Ü–µ–Ω—ã ‚Äî –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∏–ª–∏ –º—è–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å –Ω—É–ª—è–º–∏ –∫–ª–∏–∫–æ–≤ */
.scene{
  position: relative;
  width:100%;
  height:100%;
  overflow:hidden;
  isolation:isolate;         /* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è —Å–ª–æ—ë–≤ */
}

/* –ú—è–≥–∫–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ñ–æ–Ω–∞ —Å—Ü–µ–Ω—ã. –í–ù–ò–ú–ê–ù–ò–ï: –≤—ã–∫–ª—é—á–∞–µ–º pointer-events, —á—Ç–æ–±—ã –Ω–µ –∫—Ä–∞—Å—Ç—å –∫–ª–∏–∫–∏. */
.scene::before{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(1200px 800px at 50% 0%,
              rgba(255,255,255,.08), rgba(0,0,0,0) 60%),
              linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.6));
  filter: none;
  pointer-events:none;     /* –∫–ª–∏–∫–∏ –∏–¥—É—Ç —Å–∫–≤–æ–∑—å –ø–æ–¥–ª–æ–∂–∫—É */
  z-index: 0;
}

/* ===== HUD ===== */
.hud{
  position:absolute; inset:12px 12px auto 12px; /* top-left-right */
  display:flex; align-items:center; justify-content:space-between;
  pointer-events:none;  /* HUD –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º */
  z-index: 5;
}

/* –û—Ç–¥–µ–ª—å–Ω—ã–µ –±–µ–π–¥–∂–∏ HUD */
.badge{
  pointer-events:none;
  background: rgba(0,0,0,.45);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: var(--r-l);
  padding: 10px 14px;
  font-weight: 800;
  box-shadow:
    0 14px 38px var(--ui-shadow),
    0 0 18px rgba(255, 215, 0, .10) inset;
  user-select:none;
}
.badge.level   { color: var(--ui-primary) }
.badge.timer   { min-width:110px; text-align:center }
.badge.score   { min-width:110px; text-align:center }

/* ===== –°–ø—Ä–∞–≤–∞ –≤–Ω–∏–∑—É ‚Äî –º–∏–Ω–∏-–º–µ–Ω—é (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏), –ø–æ –∫–ª–∏–∫—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å ===== */
.menuBtn{
  position:absolute; right:12px; bottom:12px;
  width:44px; height:44px; border-radius:10px;
  background: rgba(0,0,0,.6);
  color:#fff; border:1px solid rgba(255,255,255,.2);
  display:flex; align-items:center; justify-content:center;
  z-index:6;
}
.menuDots{ width:18px; height:18px; position:relative }
.menuDots::before, .menuDots::after, .menuDots span{
  content:""; display:block; width:4px; height:4px; border-radius:999px; background:#fff;
  position:absolute; left:50%; transform:translateX(-50%);
}
.menuDots::before{ top:2px}
.menuDots span{ top:7px}
.menuDots::after{ top:12px}

/* ===== –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è + –∏–Ω—Ñ–æ), —Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ===== */
.panel{
  position:absolute; right:12px; bottom:64px;
  background: var(--ui-bg);
  border: 1px solid var(--ui-stroke);
  border-radius: 14px;
  padding: 14px;
  color: var(--ui-ink);
  font-size: 14px;
  width: 320px;
  box-shadow: 0 10px 40px rgba(0,0,0,.5);
  display:none;
  z-index: 6;
}
.panel.open{ display:block }
.panel h3{
  margin:0 0 8px; color: var(--ui-primary); font-size:16px
}
.panel .row{ display:grid; grid-template-columns:120px 1fr; gap:10px; align-items:center; margin:8px 0 }
.panel label{ color:#fff; font-weight:700 }
.panel select, .panel input[type=color]{
  width:100%; background:#0f0f0f; color:#fff; border:1px solid #2a2a2a; border-radius:10px; padding:8px; outline:none
}

/* ===== –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î (–≤–ª–µ–≤–æ) ‚Äî –Ω–∞ —Å–ª—É—á–∞–π –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞ ===== */
.backBtn{
  position:absolute; left:12px; bottom:12px;
  width:44px; height:44px; border-radius:10px;
  background: rgba(0,0,0,.6);
  color:#fff; border:1px solid rgba(255,255,255,.2);
  display:flex; align-items:center; justify-content:center;
  z-index:6;
}
.backBtn svg{ width:20px; height:20px; fill:#fff }

/* ===== –°–¢–ê–†–¢–û–í–û–ï –û–ö–ù–û ===== */
.overlay{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
  background: radial-gradient(40vmax 40vmax at center, rgba(0,0,0,.50), rgba(0,0,0,.85));
  z-index:10;
}
.overlay .panel{
  display:block;
  width:auto; min-width:320px; max-width:70vw;
  background: rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.12);
  border-radius: 16px;
  padding: 20px 26px;
  text-align:center;
  color:#fff;
  box-shadow: 0 0 26px rgba(255,215,0,.1);
}
.overlay .title{
  font-size:22px; color:#fff; font-weight:900; margin:0 0 10px
}
.overlay .hint{
  font-size:14px; color: var(--ui-muted); margin: 0 0 16px
}
.overlay .startBtn{
  background: linear-gradient(90deg, var(--ui-primary), #ffde49);
  color: var(--ui-on-primary);
  border: 0; border-radius: 10px;
  font-weight: 900; padding: 12px 18px; cursor: pointer
}

/* ===== –°–û–ë–°–¢–í–ï–ù–ù–û –ò–ì–†–û–í–û–ï –ü–û–õ–ï (—Å–ª–æ–π —Å –ø–∞–¥–∞—é—â–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏) ===== */
#game{
  position: absolute; inset:0;
  z-index: 1;              /* –Ω–∏–∂–µ HUD –∏ –æ–≤–µ—Ä–ª–µ–µ–≤, –≤—ã—à–µ –ø–æ–¥–ª–æ–∂–∫–∏ —Å—Ü–µ–Ω—ã */
  pointer-events: auto;    /* –ª–æ–≤–∏–º –∫–ª–∏–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö */
}

/* –ü–∞–¥–∞—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä-—ç–ª–µ–º–µ–Ω—Ç */
.item{
  position:absolute;
  top:-140px;
  left:0;
  transform:translateZ(0);
  will-change:transform, top, left;
  display:inline-flex;
  align-items:center; justify-content:center;
  min-width:120px; min-height:80px;
  padding:0;          /* padding –∏–¥—ë—Ç –≤ .content */
  user-select:none; cursor:pointer;
}
.item .bg{
  position:absolute; inset:0;
  background:#222;   /* –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ JS: —Ü–≤–µ—Ç –∏–ª–∏ bgImage */
  opacity:1;
  border:0 solid #fff;
  box-shadow:none;
  transition:filter .15s ease;
}
.item .content{
  position:relative; z-index:1; pointer-events:none; /* –∫–ª–∏–∫–∏ –∏–¥—É—Ç –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  display:flex; align-items:center; justify-content:center;
  padding:20px 26px;
  max-width:320px; max-height:220px;
  text-align:center; line-height:1.15;
}
.item .content span{
  display:inline-block; font-weight:800; white-space:nowrap;
  color: var(--text-color);
  font-family: var(--text-font);
  font-size: var(--text-size-px);
}
.item .content img{
  display:block; max-width:180px; max-height:140px; object-fit:contain; pointer-events:none;
}

/* –§–ò–ì–£–†–´: –∫–ª–∏–ø—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ–Ω (.bg), –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–≤—ã—Ä–µ–∑–∞–Ω–Ω—ã–º */
.shape-rect .bg    { border-radius:10px }
.shape-rounded .bg { border-radius:20px }
.shape-circle .bg  { border-radius:50% }
.shape-diamond .bg { clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
.shape-star   .bg  { clip-path:polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%) }

/* –≠—Ñ—Ñ–µ–∫—Ç—ã */
.fx-shadow  .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
.fx-3d      .bg{ box-shadow:7px 7px 20px rgba(0,0,0,.5), inset -5px -5px 12px rgba(255,255,255,.22) }
.fx-glow    .bg{ box-shadow:0 0 18px var(--glow) }
.fx-border  .bg{ border-style:solid }

/* –ê–Ω–∏–º–∞—Ü–∏—è ¬´–ø–æ–π–º–∞–Ω–æ¬ª */
.caught{ animation:pop .45s ease forwards }
@keyframes pop{
  0%{ transform:scale(1); opacity:1 }
  50%{ transform:scale(1.15); opacity:1 }
  100%{ transform:scale(0.85); opacity:0 }
}

/* –ë–ª—ë—Å—Ç–∫–∏ –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ */
.sparkle{
  position:absolute; width:6px; height:6px; border-radius:50%;
  background:rgba(255,255,255,.9);
  pointer-events:none;
  animation:spark 0.9s forwards;
  filter:drop-shadow(0 0 6px #fff);
  z-index:7; /* –ø–æ–≤–µ—Ä—Ö HUD */
}
@keyframes spark{
  from{ opacity:1; transform:translate(0,0) scale(1) }
  to  { opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
}

/* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö */
#errorBox{
  position:absolute; left:0; right:0; bottom:0;
  color:#ffc6c6; text-align:center; padding:6px 14px 10px; white-space:pre-wrap;
  z-index:8; pointer-events:none; text-shadow:0 2px 6px rgba(0,0,0,.6)
}
</style>
</head>
<body>

<div class="scene">

  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <div class="badge level" id="hudLevel">‚Äî</div>
    <div class="badge timer" id="hudTimer">00</div>
    <div class="badge score" id="hudScore">0</div>
  </div>

  <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
  <div id="game" role="application" aria-label="Falling Items game"></div>

  <!-- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –æ–∫–Ω–æ -->
  <div class="overlay" id="startOverlay" aria-modal="true" role="dialog">
    <div class="panel">
      <div class="title" id="startTitle">–ì–æ—Ç–æ–≤–æ –∫ —Å—Ç–∞—Ä—Ç—É</div>
      <p class="hint" id="startHint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –≤–∫–ª—é—á–∞–µ—Ç –∑–≤—É–∫.</p>
      <button class="startBtn" id="startBtn">–°—Ç–∞—Ä—Ç</button>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ ¬´–Ω–∞–∑–∞–¥¬ª (–∫–∞—Å—Ç–æ–º–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –Ω–∞–ø—Ä., –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫) -->
  <button class="backBtn" id="backBtn" title="–ó–∞–Ω–æ–≤–æ" aria-label="Restart">
    <svg viewBox="0 0 24 24" focusable="false"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
  </button>

  <!-- –ú–∏–Ω–∏-–º–µ–Ω—é -->
  <button class="menuBtn" id="menuBtn" title="–ú–µ–Ω—é" aria-label="Menu">
    <span class="menuDots"><span></span></span>
  </button>
  <div class="panel" id="menuPanel" aria-hidden="true">
    <h3 id="menuTitle">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
    <div class="row">
      <label for="uiLang">–Ø–∑—ã–∫</label>
      <select id="uiLang"></select>
    </div>
    <div class="row">
      <label for="uiPrimary">–ê–∫—Ü–µ–Ω—Ç HUD</label>
      <input type="color" id="uiPrimary" value="#ffd700" />
    </div>
    <div class="row">
      <label for="uiBg">–§–æ–Ω –ø–∞–Ω–µ–ª–µ–π</label>
      <input type="color" id="uiBg" value="#151515" />
    </div>
    <div style="margin-top:10px; color:var(--ui-muted)">
      <div id="menuHint">–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –°—Ü–µ–Ω–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π.</div>
    </div>
  </div>

  <div id="errorBox" aria-live="polite"></div>
</div>

<!-- –ó–≤—É–∫ ¬´–ø–æ–ø¬ª -->
<audio id="popSound" src="pop.mp3" preload="auto"></audio>

<!-- MathJax –¥–ª—è LaTeX (–µ—Å–ª–∏ —è–∑—ã–∫ math) -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" defer></script>

<script>
/* =========================================================================
   –ü–ê–†–°–ò–ù–ì –ü–ê–†–ê–ú–ï–¢–†–û–í –ò –¢–ï–ú–ê –ò–ó ¬´–†–ê–ú–ö–ò¬ª (—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)
   ========================================================================= */
const qp = Object.fromEntries(new URLSearchParams(location.search).entries());

/* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ */
function val(k, d){ return qp[k] !== undefined ? qp[k] : d }

/* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∏–∑ JSON/—Ä–µ–¥–∞–∫—Ç–æ—Ä–∞) */
let CFG = {
  language:   'ru',
  font:       'Rubik',
  fontSize:   24,
  textColor:  '#ffffff',
  speed:      5,   // 1..10
  style: {
    shape:       'rounded',
    bgColor:     '#1a1a1a',
    bgImage:     '',
    borderOn:    true,
    borderColor: '#ffd700',
    borderWidth: 1,
    shadow:      true,
    glow:        false,
    glowColor:   '#00f0ff',
    fx3d:        false,
    opacity:     1
  },
  randomLevels: false,
  levels: []  // [{target, correct[], wrong[], timer}]
};

/* ===== –∑–∞–≥—Ä—É–∑–∫–∞ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ —É—Ä–æ–≤–Ω–µ–π =====
   –ï—Å—Ç—å –¥–≤–µ —Å—Ö–µ–º—ã:
   1) ?data=data:application/json,... (–ø–µ—Ä–µ–¥–∞—ë—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
   2) ?id=... ‚Üí –≥—Ä—É–∑–∏–º https://nikashum93.github.io/texts/data/<id>.json
   -------------------------------------------------------------------- */
async function loadGameData(){
  const BASE_TXT = 'https://nikashum93.github.io/texts/data/';

  // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: data ‚Üí id ‚Üí –ø—É—Å—Ç–æ–π
  if(qp.data){
    const url = decodeURIComponent(qp.data);
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å data: JSON');
    return r.json();
  }
  if(qp.id){
    const url = `${BASE_TXT}${encodeURIComponent(qp.id)}.json?v=${Date.now()}`;
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ' + url);
    return r.json();
  }
  // –ø—É—Å—Ç–æ–π –ø—Ä–æ—Ç–æ—Ç–∏–ø
  return {
    language: 'ru',
    font: 'Rubik',
    fontSize: 24,
    textColor: '#ffffff',
    speed: 5,
    style: {
      shape:'rounded', bgColor:'#1a1a1a', bgImage:'',
      borderOn:true, borderColor:'#ffd700', borderWidth:1,
      shadow:true, glow:false, glowColor:'#00f0ff', fx3d:false, opacity:1
    },
    randomLevels: false,
    levels: [
      { target: 'Demo', correct:['cat','sun','https://via.placeholder.com/160x120?text=img'], wrong:['dog','car'], timer: 30 }
    ]
  };
}

/* ===== –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ ===== */
const L10N = {
  ru: {
    startTitle: '–ì–æ—Ç–æ–≤–æ –∫ —Å—Ç–∞—Ä—Ç—É',
    startHint:  '–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –≤–∫–ª—é—á–∞–µ—Ç –∑–≤—É–∫.',
    startBtn:   '–°—Ç–∞—Ä—Ç',
    menuTitle:  '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã',
    menuHint:   '–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Å—Ä–∞–∑—É –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –°—Ü–µ–Ω–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π.',
    levelLabel: (n,t)=> `–£—Ä–æ–≤–µ–Ω—å ${n}${t?': '+t:''}`,
  },
  en: {
    startTitle: 'Ready to start',
    startHint:  'Click to start. The first click enables sound.',
    startBtn:   'Start',
    menuTitle:  'Settings',
    menuHint:   'Changes apply to HUD instantly. Playfield stays transparent.',
    levelLabel: (n,t)=> `Level ${n}${t?': '+t:''}`,
  },
  es: {
    startTitle: 'Listo para empezar',
    startHint:  'Haz clic para empezar. El primer clic habilita el sonido.',
    startBtn:   'Iniciar',
    menuTitle:  'Par√°metros',
    menuHint:   'Los cambios se aplican al HUD al instante. El campo de juego es transparente.',
    levelLabel: (n,t)=> `Nivel ${n}${t?': '+t:''}`,
  },
  fr: {
    startTitle: 'Pr√™t √† d√©marrer',
    startHint:  'Cliquez pour d√©marrer. Le premier clic active le son.',
    startBtn:   'D√©marrer',
    menuTitle:  'Param√®tres',
    menuHint:   "Les changements s'appliquent au HUD imm√©diatement. Le terrain reste transparent.",
    levelLabel: (n,t)=> `Niveau ${n}${t?': '+t:''}`,
  },
  de: {
    startTitle: 'Bereit zum Start',
    startHint:  'Klicken zum Starten. Der erste Klick aktiviert den Ton.',
    startBtn:   'Start',
    menuTitle:  'Einstellungen',
    menuHint:   '√Ñnderungen wirken sofort auf das HUD. Spielfeld bleibt transparent.',
    levelLabel: (n,t)=> `Level ${n}${t?': '+t:''}`,
  },
  ja: {
    startTitle: 'ÈñãÂßã„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åæ„Åó„Åü',
    startHint:  '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈñãÂßã„ÄÇÊúÄÂàù„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈü≥Â£∞„ÅåÊúâÂäπ„Å´„Å™„Çä„Åæ„Åô„ÄÇ',
    startBtn:   '„Çπ„Çø„Éº„Éà',
    menuTitle:  'Ë®≠ÂÆö',
    menuHint:   'Â§âÊõ¥„ÅØ„Åô„Åê„Å´HUD„Å´ÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ„Éó„É¨„Ç§„Éï„Ç£„Éº„É´„Éâ„ÅØÈÄèÊòé„ÅÆ„Åæ„Åæ„Åß„Åô„ÄÇ',
    levelLabel: (n,t)=> `„É¨„Éô„É´ ${n}${t?': '+t:''}`,
  },
  zh: {
    startTitle: 'ÂáÜÂ§áÂºÄÂßã',
    startHint:  'ÁÇπÂáªÂºÄÂßã„ÄÇÁ¨¨‰∏ÄÊ¨°ÁÇπÂáª‰ºöÂêØÁî®Â£∞Èü≥„ÄÇ',
    startBtn:   'ÂºÄÂßã',
    menuTitle:  'ËÆæÁΩÆ',
    menuHint:   '‰øÆÊîπ‰ºöÁ´ãÂç≥Â∫îÁî®Âà∞HUD„ÄÇÂú∫ÊôØ‰øùÊåÅÈÄèÊòé„ÄÇ',
    levelLabel: (n,t)=> `ÂÖ≥Âç° ${n}${t?': '+t:''}`,
  },
  ar: {
    startTitle: 'ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ®ÿØÿ°',
    startHint:  'ÿßŸÜŸÇÿ± ŸÑŸÑÿ®ÿØÿ°. ÿ£ŸàŸÑ ŸÜŸÇÿ±ÿ© ÿ™ŸèŸÅÿπŸëŸêŸÑ ÿßŸÑÿµŸàÿ™.',
    startBtn:   'ÿßÿ®ÿØÿ£',
    menuTitle:  'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
    menuHint:   'ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ™Ÿèÿ∑ÿ®ŸëŸÇ ŸÅŸàÿ±Ÿãÿß ÿπŸÑŸâ HUD. ÿ≥ÿßÿ≠ÿ© ÿßŸÑŸÑÿπÿ® ÿ¥ŸÅÿßŸÅÿ©.',
    levelLabel: (n,t)=> `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${n}${t?': '+t:''}`,
  }
}

/* ===== –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–∑ ¬´—Ä–∞–º–∫–∏¬ª ===== */
function applyThemeFromFrameStyle(){
  const st = CFG.style || {};
  /* –ö–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–≤—è–∑–∫–∏:
     - primary ‚Üê borderColor
     - bg      ‚Üê bgColor
     - text    ‚Üê CFG.textColor
     - font    ‚Üê CFG.font/fontSize
  */
  const primary  = st.borderColor || '#ffd700';
  const panelBg  = st.bgColor     || '#151515';
  const ink      = '#e9e9e9';
  const stroke   = '#2a2a2a';

  document.documentElement.style.setProperty('--ui-primary', primary);
  document.documentElement.style.setProperty('--ui-bg', panelBg);
  document.documentElement.style.setProperty('--ui-ink', ink);
  document.documentElement.style.setProperty('--ui-stroke', stroke);
  document.documentElement.style.setProperty('--text-color', CFG.textColor || '#ffffff');
  document.documentElement.style.setProperty('--text-size-px', (parseInt(CFG.fontSize,10)||24) + 'px');

  /* –®—Ä–∏—Ñ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
  const family = (CFG.font || 'Rubik').trim();
  const gf = document.getElementById('gfLinkMain');
  if(!gf){
    const link = document.createElement('link');
    link.id = 'gfLinkMain';
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/css2?family=' + encodeURIComponent(family).replace(/%20/g,'+') + ':wght@400;700&display=swap';
    document.head.appendChild(link);
  }else{
    gf.href = 'https://fonts.googleapis.com/css2?family=' + encodeURIComponent(family).replace(/%20/g,'+') + ':wght@400;700&display=swap';
  }
  document.documentElement.style.setProperty('--text-font', `${family}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
}

/* =========================================================================
   –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
   ========================================================================= */
const gameEl     = document.getElementById('game');
const hudLevel   = document.getElementById('hudLevel');
const hudTimer   = document.getElementById('hudTimer');
const hudScore   = document.getElementById('hudScore');
const errorBox   = document.getElementById('errorBox');

const overlay    = document.getElementById('startOverlay');
const startBtn   = document.getElementById('startBtn');

const menuBtn    = document.getElementById('menuBtn');
const menuPanel  = document.getElementById('menuPanel');
const backBtn    = document.getElementById('backBtn');

const uiLangSel  = document.getElementById('uiLang');
const uiPrimary  = document.getElementById('uiPrimary');
const uiBg       = document.getElementById('uiBg');

const startTitle = document.getElementById('startTitle');
const startHint  = document.getElementById('startHint');
const menuTitle  = document.getElementById('menuTitle');
const menuHint   = document.getElementById('menuHint');

const popSound   = document.getElementById('popSound');

let levelIndex = 0;
let score = 0;
let running = false;
let levelTimerHandle = null;
let spawnerHandle    = null;

/* —É–¥–æ–±—Å—Ç–≤–∞ */
const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));
const rnd   = (a,b)=> a + Math.random()*(b-a);

/* ===== –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å ===== */
function applyL10n(){
  const lang = (CFG.language || 'ru').toLowerCase();
  const t = L10N[lang] || L10N.ru;
  startTitle.textContent = t.startTitle;
  startHint.textContent  = t.startHint;
  startBtn.textContent   = t.startBtn;
  menuTitle.textContent  = t.menuTitle;
  menuHint.textContent   = t.menuHint;

  // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä —è–∑—ã–∫–æ–≤
  uiLangSel.innerHTML = '';
  Object.keys(L10N).forEach(k=>{
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = k.toUpperCase();
    uiLangSel.appendChild(opt);
  });
  uiLangSel.value = lang;
}

/* ===== –º–µ–Ω—é HUD ===== */
menuBtn.addEventListener('click', ()=>{
  menuPanel.classList.toggle('open');
  menuPanel.setAttribute('aria-hidden', menuPanel.classList.contains('open') ? 'false' : 'true');
});
uiLangSel.addEventListener('change', ()=>{
  CFG.language = uiLangSel.value;
  applyL10n();
  updateHudLevelTitle();
});
uiPrimary.addEventListener('input', ()=>{
  document.documentElement.style.setProperty('--ui-primary', uiPrimary.value || '#ffd700');
});
uiBg.addEventListener('input', ()=>{
  document.documentElement.style.setProperty('--ui-bg', uiBg.value || '#151515');
});

/* ===== —Å—Ç–∞—Ä—Ç/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ ===== */
function showOverlay(){ overlay.style.display = 'flex' }
function hideOverlay(){ overlay.style.display = 'none' }

startBtn.addEventListener('click', startGame);
backBtn.addEventListener('click', restartGame);

function startGame(){
  hideOverlay();
  // –†–∞–∑—Ä–µ—à–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫)
  try{ popSound.play().then(()=> popSound.pause()).catch(()=>{}); }catch(_){}
  levelIndex = 0;
  score = 0;
  hudScore.textContent = '0';
  running = true;
  startLevel();
}

function restartGame(){
  stopLevel();
  // –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω—É
  document.querySelectorAll('.item').forEach(n=> n.remove());
  showOverlay();
}

/* ===== —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å ===== */
function startLevel(){
  if(levelIndex >= CFG.levels.length){
    showFinish();
    return;
  }
  const lv = CFG.levels[levelIndex];
  updateHudLevelTitle();

  // —Ç–∞–π–º–µ—Ä
  let timeLeft = Math.max(5, Number(lv.timer || 30));
  hudTimer.textContent = String(timeLeft).padStart(2,'0');
  if(levelTimerHandle) clearInterval(levelTimerHandle);
  levelTimerHandle = setInterval(()=>{
    timeLeft--;
    hudTimer.textContent = String(timeLeft).padStart(2,'0');
    if(timeLeft <= 0){
      clearInterval(levelTimerHandle);
      clearInterval(spawnerHandle);
      document.querySelectorAll('.item').forEach(n=>n.remove());
      levelIndex++;
      startLevel();
    }
  }, 1000);

  // —Å–ø–∞–≤–Ω –æ–±—ä–µ–∫—Ç–æ–≤
  if(spawnerHandle) clearInterval(spawnerHandle);
  const pool = [
    ...(lv.correct||[]).map(v=>({val:v, good:true})),
    ...(lv.wrong||[]).map(v=>({val:v, good:false}))
  ];
  const SPEED = clamp(Number(CFG.speed ?? 5), 1, 10);
  const baseDelay = 1200;
  const delay = clamp(baseDelay / (SPEED/5), 280, 3000);

  spawnerHandle = setInterval(()=>{
    const obj = pool[Math.floor(Math.random()*pool.length)];
    drop(obj);
  }, delay);
}

function stopLevel(){
  running = false;
  clearInterval(levelTimerHandle);
  clearInterval(spawnerHandle);
}

/* ===== –ø–æ–¥–ø–∏—Å—å —É—Ä–æ–≤–Ω—è –≤ HUD ===== */
function updateHudLevelTitle(){
  const lang = (CFG.language || 'ru').toLowerCase();
  const t = L10N[lang] || L10N.ru;
  const lv = CFG.levels[levelIndex];
  const title = t.levelLabel(levelIndex+1, lv?.target||'');
  hudLevel.textContent = title;
}

/* =========================================================================
   –õ–û–ì–ò–ö–ê –≠–õ–ï–ú–ï–ù–¢–û–í
   ========================================================================= */
function drop(obj){
  const st = CFG.style || {};
  const SPEED = clamp(Number(CFG.speed ?? 5), 1, 10);

  const el = document.createElement('div');
  el.className = `item shape-${st.shape || 'rounded'} ${st.shadow?'fx-shadow':''} ${st.fx3d?'fx-3d':''} ${st.glow?'fx-glow':''} ${st.borderOn && st.borderWidth>0 ? 'fx-border' : ''}`;
  el.dataset.good = obj.good ? '1' : '0';
  el.style.setProperty('--glow', st.glowColor || '#00f0ff');

  const bg = document.createElement('div');
  bg.className = 'bg';
  const content = document.createElement('div');
  content.className = 'content';
  el.appendChild(bg); el.appendChild(content);

  // —Ñ–æ–Ω-—Å–ª–æ–π (—Ü–≤–µ—Ç –ò–õ–ò –∫–∞—Ä—Ç–∏–Ω–∫–∞; –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –µ—Å—Ç—å ‚Äî –æ–Ω–∞ –≥–ª–∞–≤–Ω–µ–µ, —Ü–≤–µ—Ç –º–æ–∂–Ω–æ –ø–æ–¥—Å—É–Ω—É—Ç—å –≤—Ç–æ—Ä—ã–º —Å–ª–æ–µ–º)
  const bgImg = (st.bgImage||'').trim();
  const bgCol = st.bgColor || 'transparent';
  if(bgImg){
    bg.style.background = `url(${bgImg}) center/contain no-repeat, ${bgCol}`;
  }else{
    bg.style.background = bgCol;
  }
  bg.style.opacity = clamp(Number(st.opacity ?? 1), 0, 1);
  if(st.borderOn && st.borderWidth>0){
    bg.style.borderColor = st.borderColor || '#fff';
    bg.style.borderWidth = `${parseInt(st.borderWidth,10)}px`;
  } else {
    bg.style.borderWidth = '0px';
  }

  // –∫–æ–Ω—Ç–µ–Ω—Ç (–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç/LaTeX)
  const isUrl = /^https?:\/\//i.test(obj.val);
  const isMath = (CFG.language || '') === 'math';

  if(isUrl){
    const img = document.createElement('img');
    img.src = obj.val;
    content.appendChild(img);
  }else if(isMath){
    const span = document.createElement('span');
    span.textContent = `\\(${obj.val}\\)`;
    content.appendChild(span);
    // typeset –ø–æ—Å–ªe –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
  }else{
    const span = document.createElement('span');
    span.textContent = String(obj.val);
    span.style.color = CFG.textColor || '#ffffff';
    span.style.fontFamily = `${CFG.font || 'Rubik'}, system-ui, sans-serif`;
    span.style.fontSize = `${parseInt(CFG.fontSize,10)||24}px`;
    content.appendChild(span);
  }

  // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
  const gw = gameEl.clientWidth;
  const startX = Math.max(16, Math.min(gw-220, rnd(0, gw-220)));
  el.style.left = startX + 'px';
  el.style.top  = '-160px';

  // –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Å—Ü–µ–Ω—É –∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—Ç—å –¥–ª—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–≥—É—Ä (–∫—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞)
  gameEl.appendChild(el);
  fitGeometryBox(el);

  // –ê–≤—Ç–æ—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç)
  if(!isUrl && !isMath){
    autoFitText(el, parseInt(CFG.fontSize,10)||24, 12);
  }

  // –ï—Å–ª–∏ LaTeX ‚Äî typeset, –∑–∞—Ç–µ–º –ø–æ–¥–ø—Ä–∞–≤–ª—è–µ–º –∫–æ—Ä–æ–±–∫—É
  if(isMath && window.MathJax && MathJax.typesetPromise){
    MathJax.typesetPromise([el]).then(()=> fitGeometryBox(el));
  }

  // –ü–∞–¥–µ–Ω–∏–µ
  const vel      = 1.2 + SPEED * 0.9;
  const swayAmp  = rnd(8, 22);
  const swayFreq = rnd(0.003, 0.008);
  let y = -140;
  let t = 0;
  let alive = true;

  function step(){
    if(!alive) return;
    y += vel; t += 1;
    const dx = Math.sin(t*swayFreq) * swayAmp;
    el.style.top = y + 'px';
    el.style.transform = `translateX(${dx}px)`;
    if(y > gameEl.clientHeight + 200){
      alive = false; el.remove();
      // —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ
      if(el.dataset.good === '1'){
        score = Math.max(0, score - 5);
        hudScore.textContent = String(score);
      }
      return;
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  // –ö–ª–∏–∫
  el.addEventListener('click', ()=>{
    if(!alive) return;
    if(el.dataset.good === '1'){
      score++; hudScore.textContent = String(score);
      playPop(el);
      alive = false;
      el.classList.add('caught');
      setTimeout(()=> el.remove(), 380);
    }else{
      score = Math.max(0, score - 1); // —à—Ç—Ä–∞—Ñ –∑–∞ –æ—à–∏–±–∫—É
      hudScore.textContent = String(score);
      bg.style.filter = 'brightness(2) saturate(1.6) hue-rotate(-24deg)';
      setTimeout(()=> bg.style.filter = 'none', 220);
    }
  }, {passive:true});
}

/* –∫–≤–∞–¥—Ä–∞—Ç–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ –≥–µ–æ–º.—Ñ–∏–≥—É—Ä—ã */
function fitGeometryBox(el){
  const shape = (CFG.style?.shape) || 'rounded';
  const content = el.querySelector('.content');
  const rect = content.getBoundingClientRect();
  // –ë–∞–∑–æ–≤–æ ‚Äî –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç
  el.style.width  = rect.width  + 'px';
  el.style.height = rect.height + 'px';
  // –ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ ‚Äî –∫–≤–∞–¥—Ä–∞—Ç —Å –æ—Ç—Å—Ç—É–ø–æ–º
  if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
    const size = Math.max(rect.width, rect.height) + 30;
    el.style.width  = size + 'px';
    el.style.height = size + 'px';
  }
}

/* –ê–≤—Ç–æ-—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–æ –≤–ª–µ–∑–∞–Ω–∏—è */
function autoFitText(el, startPx, minPx){
  const span = el.querySelector('.content span');
  if(!span) return;
  let fs = startPx;
  const maxW = el.clientWidth  - 24;
  const maxH = el.clientHeight - 24;

  const ok = ()=> {
    const r = span.getBoundingClientRect();
    return (r.width <= maxW && r.height <= maxH);
  };
  while(fs > minPx){
    span.style.fontSize = fs + 'px';
    if(ok()) break;
    fs -= 1;
  }
}

/* –ó–≤—ë–∑–¥–æ—á–∫–∏ –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏ + –∑–≤—É–∫ */
function playPop(el){
  try{
    popSound.currentTime = 0;
    popSound.play().catch(()=>{});
  }catch(_) {}
  const r = el.getBoundingClientRect();
  for(let i=0;i<14;i++){
    const s = document.createElement('div');
    s.className = 'sparkle';
    s.style.left = (r.left + r.width/2) + 'px';
    s.style.top  = (r.top  + r.height/2) + 'px';
    const angle = Math.random() * Math.PI * 2;
    const dist  = 40 + Math.random()*70;
    s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
    s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
    s.style.animationDuration = (0.9 / (clamp(Number(CFG.speed ?? 5),1,10)/5)) + 's';
    document.body.appendChild(s);
    setTimeout(()=> s.remove(), 1000);
  }
}

/* –§–∏–Ω–∞–ª */
function showFinish(){
  stopLevel();
  const ov = document.createElement('div');
  ov.className = 'overlay';
  ov.innerHTML = `
    <div class="panel">
      <div class="title" style="color:var(--ui-primary)">–§–∏–Ω–∏—à! üéâ</div>
      <div style="opacity:.9; margin-bottom:10px">–°—á—ë—Ç: <b>${score}</b></div>
      <button class="startBtn" id="againBtn" style="background:linear-gradient(90deg,var(--ui-primary),#ffde49)">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
  `;
  document.body.appendChild(ov);
  ov.querySelector('#againBtn').addEventListener('click', ()=>{
    ov.remove();
    restartGame();
  });
}

/* =========================================================================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
   ========================================================================= */
(async function init(){
  try{
    // –ü–æ–¥—Ç—è–Ω—É—Ç—å JSON —É—Ä–æ–≤–Ω–µ–π
    const fromServer = await loadGameData();
    // –°–ª–∏—Ç—å –≤ CFG (—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º URL –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–ª—é—á–µ–π)
    CFG = {
      ...CFG,
      ...fromServer,
      language: (val('language', fromServer.language) || 'ru'),
      font:     val('font', fromServer.font || 'Rubik'),
      fontSize: parseInt(val('fontSize', fromServer.fontSize || 24),10),
      textColor: val('textColor', fromServer.textColor || '#ffffff'),
      speed: parseInt(val('speed', fromServer.speed || 5),10),
      style: {...CFG.style, ...(fromServer.style||{})}
    };

    // –†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π?
    if(fromServer.randomLevels){
      CFG.randomLevels = true;
      CFG.levels = Array.isArray(fromServer.levels) ? [...fromServer.levels] : [];
      for(let i=CFG.levels.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [CFG.levels[i], CFG.levels[j]] = [CFG.levels[j], CFG.levels[i]];
      }
    }else{
      CFG.levels = Array.isArray(fromServer.levels) ? fromServer.levels : [];
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
    applyThemeFromFrameStyle();

    // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
    applyL10n();

    // –ü—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ü–≤–µ—Ç–∞ –≤ –ø–∞–Ω–µ–ª—å
    uiPrimary.value = getComputedStyle(document.documentElement).getPropertyValue('--ui-primary').trim() || '#ffd700';
    uiBg.value      = getComputedStyle(document.documentElement).getPropertyValue('--ui-bg').trim()      || '#151515';

    // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –∑–∞–¥–∞–Ω
    if(fromServer.cursor){
      document.body.style.cursor = `url(${fromServer.cursor}), auto`;
    }

    // –ì–æ—Ç–æ–≤–æ
    errorBox.textContent = '';

  }catch(e){
    errorBox.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e.message || e);
    console.error(e);
  }
})();
</script>
</body>
</html>
