<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falling Items ‚Äî Game</title>

<!--
  main.html ‚Äî –ü–û–õ–ù–´–ô –§–ê–ô–õ
  –í–ê–ñ–ù–û: –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ GitHub Pages:
  https://nikashum93.github.io/texts/data/<id>.json
  –≥–¥–µ <id> –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?id=...
-->

<style>
  :root{
    /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä—É–µ–º—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã (–ø–µ—Ä–µ–∫—Ä–∞—Å–∏–º –∏–∑ cfg.style.borderColor) */
    --ui:#ffd700;
    --ink:#ffffff;
    --hud-bg: rgba(0,0,0,.45);
    --hud-stroke: rgba(255,255,255,.12);
    --glow:#00f0ff;
  }

  /* –ë–∞–∑–æ–≤–∞—è —Å—Ü–µ–Ω–∞ ‚Äî –≤—Å—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  html,body{height:100%}
  body{
    margin:0;
    background:transparent; /* –ü–†–û–ó–†–ê–ß–ù–û */
    color:var(--ink);
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  #game{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden; /* —ç–ª–µ–º–µ–Ω—Ç—ã —É–ª–µ—Ç–µ–≤—à–∏–µ –≤–Ω–∏–∑ —Å–∫—Ä—ã–≤–∞–µ–º */
  }

  /* HUD (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å) ‚Äî —Ü–≤–µ—Ç –∑–∞–≤—è–∑–∞–Ω –Ω–∞ --ui */
  .hud{
    position:fixed; inset:12px 12px auto 12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    font-weight:700; z-index:10; pointer-events:none;
  }
  .badge{
    pointer-events:none;
    background:var(--hud-bg);
    border:1px solid var(--hud-stroke);
    border-radius:12px;
    padding:10px 14px;
    box-shadow:
      0 8px 24px rgba(0,0,0,.35),
      0 0 22px color-mix(in srgb, var(--ui) 18%, transparent) inset;
  }
  .levelTitle{ color: var(--ui); }
  .timer{min-width:110px; text-align:center}
  .score{min-width:110px; text-align:center}

  /* –ö–Ω–æ–ø–∫–∏ (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –Ω–∞ –ø–∞—É–∑–∞—Ö –∏ —Ç.–ø.) */
  .btn{
    background:linear-gradient(90deg, color-mix(in srgb, var(--ui) 72%, #fff 0%), var(--ui));
    color:#000; border:0; border-radius:12px; font-weight:900; padding:12px 16px; cursor:pointer;
    box-shadow:0 8px 26px color-mix(in srgb, var(--ui) 28%, transparent);
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é ‚Äî —Ü–µ–Ω—Ç—Ä —Å—Ü–µ–Ω—ã */
  .start-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20;
    pointer-events:auto;
  }
  .start-panel{
    background:rgba(0,0,0,.62);
    border:1px solid var(--hud-stroke);
    border-radius:18px;
    padding:26px 28px;
    color:#fff;
    box-shadow:0 0 30px color-mix(in srgb, var(--ui) 18%, transparent);
    min-width: min(86vw, 520px);
    text-align:center;
  }
  .start-title{
    font-size: clamp(20px, 3.4vw, 32px);
    margin: 0 0 6px;
    color: var(--ui);
    font-weight: 900;
    text-shadow: 0 0 16px color-mix(in srgb, var(--ui) 55%, transparent);
  }
  .start-sub{
    opacity:.9;
    margin:0 0 12px;
  }
  .start-controls{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:14px;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px dashed #444; border-radius:999px; color:#bbb; font-size:13px
  }

  /* –ü–∞–¥–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–≤–Ω–µ—à–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç JS —á–µ—Ä–µ–∑ fitGeometryBox) */
  .item{
    position:absolute;
    top:-140px;
    left:0;
    transform:translateZ(0);
    will-change:transform, top, left, width, height;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:120px;
    min-height:80px;
    padding:0; /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã –¥–µ—Ä–∂–∏–º –≤ .content */
    user-select:none;
    cursor:pointer;
    pointer-events:auto;  /* –≤–∞–∂–Ω–æ: –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ */
  }

  /* –§–æ–Ω-—Å–ª–æ–π (–∫–ª–∏–ø–∞–µ—Ç—Å—è, –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ —Ü–≤–µ—Ç, —Ç–æ–ª—å–∫–æ –û–î–ù–û –∏–∑ –¥–≤—É—Ö) */
  .item .bg{
    position:absolute; inset:0;
    /* –¶–≤–µ—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∏–∑ JS, –ø—Ä–∏—á—ë–º –í–ó–ê–ò–ú–û–ò–°–ö–õ–Æ–ß–ê–Æ–©–ï */
    background: transparent;
    opacity:1;
    border:0 solid #fff; /* –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–∑ JS */
    box-shadow:none;     /* —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ JS */
    transition:filter .12s ease;
    z-index:0;
    background-repeat:no-repeat;
    background-position:center;
    background-size:contain; /* –∫–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∫–∞ –≤–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è */
  }

  /* –°–ª–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ç–µ–∫—Å—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è) ‚Äî –ù–ï –∫–ª–∏–ø–∞–µ—Ç—Å—è —Ñ–∏–≥—É—Ä–∞–º–∏, –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–±–µ–ª–µ–Ω */
  .item .content{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    padding:20px 26px; /* –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏-—Ä–∞–º–∫–∏ */
    max-width:420px;   /* –∑–∞—â–∏—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã */
    max-height:260px;
    text-align:center;
    line-height:1.1;
  }
  .item .content span{
    display:inline-block;
    font-weight:800;
    white-space:nowrap;
  }
  .item .content img{
    display:block;
    max-width:210px;
    max-height:160px;
    object-fit:contain;
    pointer-events:none;
  }

  /* –§–ò–ì–£–†–´ ‚Äî clip-path / —Ä–∞–¥–∏—É—Å—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –¢–û–õ–¨–ö–û –∫ .bg (–∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∏—Å–∫–∞–∂–∞–µ—Ç—Å—è) */
  .shape-rect   .bg{ border-radius: 10px }
  .shape-rounded .bg{ border-radius: 20px }
  .shape-circle .bg{ border-radius: 50% }
  .shape-diamond .bg{ clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
  .shape-star .bg{
    clip-path: polygon(
      50% 0%,
      61% 35%,
      98% 35%,
      68% 57%,
      79% 91%,
      50% 70%,
      21% 91%,
      32% 57%,
      2% 35%,
      39% 35%
    );
  }

  /* –≠–§–§–ï–ö–¢–´ (—Ç–µ–Ω—å/–ø–æ–¥—Å–≤–µ—Ç–∫–∞/3D/—Ä–∞–º–∫–∞) –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ .bg */
  .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
  .fx-3d .bg{ box-shadow:
      7px 7px 20px rgba(0,0,0,.5),
      inset -5px -5px 12px rgba(255,255,255,.22) }
  .fx-glow .bg{ box-shadow:0 0 18px var(--glow, #00f0ff) }
  .fx-border .bg{ border-style:solid }

  /* –ü–æ–ø-–∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –ª–æ–≤–ª–µ */
  .caught{ animation:pop .45s ease forwards }
  @keyframes pop{
    0%{ transform:scale(1); opacity:1 }
    50%{ transform:scale(1.15); opacity:1 }
    100%{ transform:scale(0.85); opacity:0 }
  }

  /* –ë–ª—ë—Å—Ç–∫–∏-–≤–∑—Ä—ã–≤ */
  .sparkle{
    position:fixed; /* –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –∏ –æ—Ç –æ–∫–Ω–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ñ–∏–∫—Å–∏—Ä—É–µ–º) */
    width:6px; height:6px; border-radius:50%;
    background:rgba(255,255,255,.95);
    pointer-events:none;
    animation:spark 0.9s forwards;
    filter:drop-shadow(0 0 6px #fff);
    z-index:25;
  }
  @keyframes spark{
    from{ opacity:1; transform:translate(0,0) scale(1) }
    to{ opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
  }

  /* –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω */
  .overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.6)); /* –ª—ë–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ */
    color:#fff; z-index:30; gap:18px;
  }
  .overlay .panel{
    background:rgba(0,0,0,.55);
    border:1px solid var(--hud-stroke);
    border-radius:16px;
    padding:20px 26px;
    text-align:center;
    box-shadow:0 0 26px color-mix(in srgb, var(--ui) 18%, transparent);
  }
  .overlay .panel .title{
    font-size:22px; color:var(--ui); font-weight:900; margin-bottom:8px
  }

  /* –ó–∞—â–∏—Ç–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã */
  .hidden{ display:none !important }
</style>
</head>
<body>

<!-- HUD -->
<div class="hud" aria-hidden="true">
  <div class="badge levelTitle" id="hudLevel">‚Äî</div>
  <div style="display:flex; gap:12px; align-items:center">
    <div class="badge timer" id="hudTimer">00</div>
    <div class="badge score" id="hudScore">0</div>
  </div>
</div>

<!-- –ò–≥—Ä–æ–≤–∞—è —Å—Ü–µ–Ω–∞ -->
<div id="game" aria-live="off" aria-atomic="false"></div>

<!-- –ó–≤—É–∫ ¬´–ø–æ–ø¬ª -->
<audio id="popSound" src="pop.mp3" preload="auto"></audio>

<!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π) -->
<div class="start-overlay" id="startOverlay">
  <div class="start-panel">
    <h2 class="start-title" id="startTitle">Falling Items</h2>
    <p class="start-sub" id="startSub">–ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å¬ª, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫ –∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å</p>
    <div class="start-controls">
      <button class="btn" id="startBtn" type="button">–ù–∞—á–∞—Ç—å</button>
      <span class="pill" id="targetInfo">–¶–µ–ª—å: ‚Äî</span>
    </div>
  </div>
</div>

<!-- –ò—Ç–æ–≥–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
<div class="overlay hidden" id="finishOverlay">
  <div class="panel">
    <div class="title">–§–∏–Ω–∏—à! üéâ</div>
    <div style="opacity:.92; margin-bottom:10px">–°—á—ë—Ç: <b id="finalScore">0</b></div>
    <button class="btn" id="btnAgain" type="button">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  </div>
</div>

<!-- MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
(async function(){

  /* ============================ –£–¢–ò–õ–ò–¢–´ ============================ */
  const $ = sel => document.querySelector(sel);
  const rnd = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  function isUrl(x){ return /^https?:\/\//i.test(x||''); }
  function px(n){ return (parseInt(n,10)||0) + 'px'; }
  function toRGBA(hex, a){
    let s=(hex||'').trim();
    if(!s) return `rgba(0,0,0,${a})`;
    if(s[0]==='#') s=s.slice(1);
    if(s.length===3) s=s.split('').map(c=>c+c).join('');
    const n = parseInt(s,16);
    const r=(n>>16)&255,g=(n>>8)&255,b=n&255;
    return `rgba(${r},${g},${b},${a})`;
  }

  /* ============================ –ó–ê–ì–†–£–ó–ö–ê CFG ============================ */
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id){
    alert('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (?id=...)');
    return;
  }

  const jsonUrl = `https://nikashum93.github.io/texts/data/${encodeURIComponent(id)}.json?v=${Date.now()}`;
  let cfg;
  try{
    const res = await fetch(jsonUrl, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    cfg = await res.json();
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message);
    return;
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (—Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –¥–µ—Ñ–æ–ª—Ç–∞–º–∏)
  const SPEED      = clamp(Number(cfg.speed ?? 5), 1, 10);     // 1‚Äì10
  const FONT       = cfg.font || 'Rubik';
  const FONT_SIZE  = Number(cfg.fontSize || 24);
  const TEXT_COLOR = cfg.textColor || '#ffffff';
  const STYLE      = cfg.style || {};
  const CURSOR     = cfg.cursor || '';
  const LANGUAGE   = cfg.language || 'ru';
  const RANDOM     = !!cfg.randomLevels;

  // –ø–µ—Ä–µ–∫—Ä–∞—Å–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ —Ü–≤–µ—Ç–∞ —Ä–∞–º–∫–∏ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å),
  // –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ–Ω –∑–∞–º–µ–Ω—ë–Ω –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
  const uiColor = (STYLE.borderColor || '#ffd700');
  document.documentElement.style.setProperty('--ui', uiColor);

  // glow
  document.documentElement.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

  // –ü–æ–¥–≥—Ä—É–∑–∏–º —à—Ä–∏—Ñ—Ç
  const gf = document.createElement('link');
  gf.rel = 'stylesheet';
  gf.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(FONT).replace(/%20/g,'+')}%3Awght@400;700&display=swap`;
  document.head.appendChild(gf);

  // –ö—É—Ä—Å–æ—Ä
  if(CURSOR) document.body.style.cursor = `url(${CURSOR}), auto`;

  // –†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π (–Ω–µ –ø–æ—Ä—Ç–∏–º –∏—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤)
  const levels = Array.isArray(cfg.levels) ? [...cfg.levels] : [];
  if(RANDOM){
    for(let i=levels.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [levels[i], levels[j]] = [levels[j], levels[i]];
    }
  }

  // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—ã —Å—Ç—Ä–æ–∫ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
  const i18n = {
    ru: { start: '–ù–∞—á–∞—Ç—å',  target: '–¶–µ–ª—å', score:'–°—á—ë—Ç', finish:'–§–∏–Ω–∏—à! üéâ', loading:'–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶' },
    en: { start: 'Start',   target: 'Target', score:'Score', finish:'Finish! üéâ', loading:'Loading‚Ä¶' },
    es: { start: 'Iniciar', target: 'Meta',   score:'Puntos', finish:'¬°Meta! üéâ', loading:'Cargando‚Ä¶' },
    fr: { start: 'D√©marrer',target: 'Cible',  score:'Score', finish:'Termin√© ! üéâ', loading:'Chargement‚Ä¶' },
    de: { start: 'Starten', target: 'Ziel',   score:'Punkte', finish:'Ziel! üéâ', loading:'Laden‚Ä¶' },
    ja: { start: 'ÈñãÂßã',     target: 'ÁõÆÊ®ô',    score:'„Çπ„Ç≥„Ç¢', finish:'„Éï„Ç£„Éã„ÉÉ„Ç∑„É•ÔºÅüéâ', loading:'Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶' },
    zh: { start: 'ÂºÄÂßã',     target: 'ÁõÆÊ†á',    score:'ÂàÜÊï∞', finish:'ÂÆåÊàêÔºÅüéâ', loading:'Âä†ËΩΩ‰∏≠‚Ä¶' }
  };
  const L = i18n[LANGUAGE] || i18n.ru;

  // –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é (—Ü–µ–Ω—Ç—Ä)
  const startOverlay = $('#startOverlay');
  const startBtn     = $('#startBtn');
  const startTitle   = $('#startTitle');
  const startSub     = $('#startSub');
  const targetInfo   = $('#targetInfo');

  startTitle.textContent = 'Falling Items';
  startSub.textContent   = '–ù–∞–∂–º–∏ ¬´'+L.start+'¬ª, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–≤—É–∫ –∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å';
  startBtn.textContent   = L.start;
  const firstTarget = (levels[0]?.target || '‚Äî');
  targetInfo.textContent = `${L.target}: ${firstTarget}`;

  // HUD
  const hudLevel = $('#hudLevel');
  const hudTimer = $('#hudTimer');
  const hudScore = $('#hudScore');

  // –ò—Ç–æ–≥
  const finishOverlay = $('#finishOverlay');
  const finalScoreEl  = $('#finalScore');
  $('#btnAgain').onclick = ()=> location.reload();

  // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  const game   = $('#game');
  const popSound = $('#popSound');

  let score = 0;
  let current = 0;
  let levelTimerHandle = null;
  let spawnerHandle = null;
  let running = false;       // –∏–≥—Ä–∞ –∏–¥—ë—Ç
  let audioPrimed = false;   // —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –ª–∏ –∑–≤—É–∫ –∫–ª–∏–∫–æ–º

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ñ–æ–∫—É—Å –Ω–∞ —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –∫–ª–∏–∫–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —à–ª–∏ –≤ –Ω–µ—ë
  game.tabIndex = 0;

  // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ HUD –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É
  hudScore.textContent = '0';
  hudTimer.textContent = '00';
  hudLevel.textContent = '‚Äî';

  // –°—Ç–∞—Ä—Ç –ø–æ –∫–Ω–æ–ø–∫–µ
  startBtn.addEventListener('click', async () => {
    // –ü—ã—Ç–∞–µ–º—Å—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –ø–æ–ª–∏—Ç–∏—Ç–∏
    try{
      popSound.muted = false;
      await popSound.play().catch(()=>{});
      popSound.pause();
      popSound.currentTime = 0;
      audioPrimed = true;
    }catch(_){}
    startOverlay.classList.add('hidden');
    running = true;
    game.focus();
    startLevel();
  });

  /* ============================ –°–¢–ê–†–¢ –£–†–û–í–ù–Ø ============================ */
  function startLevel(){
    if(current >= levels.length){
      showFinish();
      return;
    }
    const lv = levels[current];

    // –û–±–Ω–æ–≤–∏–º HUD
    hudLevel.textContent = `–£—Ä–æ–≤–µ–Ω—å ${current+1}: ${lv.target || ''}`;

    // –¢–∞–π–º–µ—Ä —É—Ä–æ–≤–Ω—è
    let timeLeft = Math.max(5, Number(lv.timer || 30));
    hudTimer.textContent = timeLeft.toString().padStart(2,'0');
    if(levelTimerHandle) clearInterval(levelTimerHandle);
    levelTimerHandle = setInterval(()=>{
      if(!running) return;
      timeLeft--;
      hudTimer.textContent = timeLeft.toString().padStart(2,'0');
      if(timeLeft <= 0){
        clearInterval(levelTimerHandle);
        clearInterval(spawnerHandle);
        // –ß—É—Ç—å-—á—É—Ç—å –æ—á–∏—Å—Ç–∏–º —Å—Ü–µ–Ω—É
        document.querySelectorAll('.item').forEach(n=>n.remove());
        current++;
        startLevel();
      }
    }, 1000);

    // –°–ø–∞–≤–Ω –æ–±—ä–µ–∫—Ç–æ–≤
    if(spawnerHandle) clearInterval(spawnerHandle);
    const pool = [
      ...(lv.correct||[]).map(v=>({val:v, good:true})),
      ...(lv.wrong||[]).map(v=>({val:v, good:false}))
    ];
    // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    if(pool.length === 0){
      clearInterval(levelTimerHandle);
      current++;
      startLevel();
      return;
    }

    const baseDelay = 1200; // –±–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞
    const delay = clamp(baseDelay / (SPEED/5), 240, 3000); // –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º SPEED
    spawnerHandle = setInterval(()=>{
      if(!running) return;
      const obj = pool[Math.floor(Math.random()*pool.length)];
      drop(obj);
    }, delay);
  }

  /* ============================ –°–û–ó–î–ê–ù–ò–ï –ò –ü–ê–î–ï–ù–ò–ï ============================ */
  function drop(obj){
    const el = document.createElement('div');
    el.className =
      `item ` +
      `shape-${STYLE.shape || 'rounded'} ` +
      `${STYLE.shadow ? 'fx-shadow' : ''} ` +
      `${STYLE.fx3d ? 'fx-3d' : ''} ` +
      `${STYLE.glow ? 'fx-glow' : ''} ` +
      `${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;

    el.dataset.good = obj.good ? '1' : '0';
    el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

    // –°–ª–æ–∏
    const bg = document.createElement('div');
    bg.className = 'bg';

    const content = document.createElement('div');
    content.className = 'content';

    el.appendChild(bg);
    el.appendChild(content);

    // –§–û–ù-—Å–ª–æ–π (–≤–∞–∂–Ω–æ: –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ò–õ–ò —Ü–≤–µ—Ç, –æ–¥–Ω–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –¥—Ä—É–≥–æ–µ!)
    const bgImg = (STYLE.bgImage||'').trim();
    const bgCol = (STYLE.bgColor||'transparent'); // –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç

    if(bgImg){
      // —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –±–µ–∑ ¬´–ø–æ–¥–ª–æ–∂–∫–∏¬ª —Ü–≤–µ—Ç–æ–º (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —á—ë—Ä–Ω—ã—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)
      bg.style.backgroundImage = `url(${bgImg})`;
      bg.style.backgroundColor = 'transparent';
    } else {
      // —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç ‚Äî ¬´—Ä–∞–º–∫–∞-–ø–ª–∞—à–∫–∞¬ª —Ü–≤–µ—Ç–Ω–∞—è
      bg.style.backgroundImage = 'none';
      bg.style.backgroundColor = bgCol;
    }

    // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞
    const bgOpacity = clamp(Number(STYLE.opacity ?? 1), 0, 1);
    bg.style.opacity = bgOpacity;

    // –†–∞–º–∫–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
    if(STYLE.borderOn && STYLE.borderWidth>0){
      bg.style.borderColor = STYLE.borderColor || '#fff';
      bg.style.borderWidth = px(STYLE.borderWidth);
    } else {
      bg.style.borderWidth = '0px';
    }

    // –ö–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞/Math)
    if(isUrl(obj.val)){
      const img = document.createElement('img');
      img.src = obj.val;
      content.appendChild(img);
    } else if((cfg.language||'') === 'math'){
      const span = document.createElement('span');
      // LaTeX –∏–Ω–ª–∞–π–Ω–æ–≤–æ, —á—Ç–æ–±—ã —Ä–µ–Ω–¥–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª –±—ã—Å—Ç—Ä–æ
      span.textContent = `\\(${obj.val}\\)`;
      span.style.color      = TEXT_COLOR;
      span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
      span.style.fontSize   = px(FONT_SIZE);
      content.appendChild(span);
    } else {
      const span = document.createElement('span');
      span.textContent = String(obj.val);
      span.style.color      = TEXT_COLOR;
      span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
      span.style.fontSize   = px(FONT_SIZE);
      content.appendChild(span);
    }

    // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ X
    const gw = game.clientWidth;
    const startX = Math.max(24, Math.min(gw-220, rnd(0, gw-220)));
    el.style.left = startX + 'px';
    el.style.top  = '-160px';

    // –í—Å—Ç–∞–≤–∏–º –≤ —Å—Ü–µ–Ω—É –î–û –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
    game.appendChild(el);

    // –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã (–∑–≤–µ–∑–¥–∞/–∫—Ä—É–≥/—Ä–æ–º–±) –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–∂–∏–º–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç:
    fitGeometryBox(el);

    // –ê–≤—Ç–æ—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –≤–ª–µ–∑–∞–µ—Ç)
    autoFitText(el, FONT_SIZE, 12);

    // –ï—Å–ª–∏ math ‚Äî –¥–æ–∂–∏–¥–∞–µ–º—Å—è —Ä–µ–Ω–¥–µ—Ä–∞ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —Ä–∞—Å—á–∏—Ç–∞–µ–º —Ä–∞–º–∫—É
    if((cfg.language||'') === 'math'){
      MathJax.typesetPromise([el]).then(()=> {
        fitGeometryBox(el);
        autoFitText(el, FONT_SIZE, 12);
      });
    }

    // –ü–∞–¥–µ–Ω–∏–µ + –º—è–≥–∫–æ–µ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ
    const vel = 1.2 + SPEED * 0.9;
    const swayAmp = rnd(8, 22);
    const swayFreq = rnd(0.003, 0.008);
    let y = -140;
    let t = 0;
    let alive = true;

    function step(){
      if(!alive) return;
      y += vel; t += 1;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if(y > game.clientHeight + 240){
        // —É—à—ë–ª –∑–∞ –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω—å ‚Äî —à—Ç—Ä–∞—Ñ, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
        alive = false;
        if(el.dataset.good === '1'){
          score = Math.max(0, score - 5);
          hudScore.textContent = String(score);
        }
        el.remove();
        return;
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    // –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É
    el.addEventListener('click', ()=>{
      if(!alive || !running) return;

      if(el.dataset.good === '1'){
        score += 1;
        hudScore.textContent = String(score);
        playPop(el);
        alive = false;
        el.classList.add('caught');
        setTimeout(()=> el.remove(), 380);
      } else {
        // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Äî —à—Ç—Ä–∞—Ñ –∏ –∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞
        score = Math.max(0, score - 1);
        hudScore.textContent = String(score);
        bg.style.filter = 'brightness(2) saturate(1.6) hue-rotate(-30deg)';
        setTimeout(()=> bg.style.filter = 'none', 220);
      }
    }, {passive:true});
  }

  /* ============================ GEOMETRY (—Ñ–æ—Ä–º—ã) ============================ */
  function fitGeometryBox(el){
    const shape = STYLE.shape || 'rounded';
    const content = el.querySelector('.content');

    // –ß–∏—Ç–∞–µ–º ¬´–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ¬ª —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const rect = content.getBoundingClientRect();
    const padX = 26, padY = 20; // —Ç–µ –∂–µ, —á—Ç–æ –≤ .content (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ ¬´–∫–æ—Ä–æ–±–∞¬ª)

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ—Ä–æ–± = (–∫–æ–Ω—Ç–µ–Ω—Ç + –ø–∞–¥–¥–∏–Ω–≥–∏)
    let W = rect.width  + padX*2;
    let H = rect.height + padY*2;

    // –î–ª—è –∫—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞ ‚Äî –∫–≤–∞–¥—Ä–∞—Ç —Å –∑–∞–ø–∞—Å–æ–º –≤–æ–∑–¥—É—Ö–∞, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–ª–∞—Å—å
    if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
      const S = Math.max(W, H);
      W = S; H = S; // —Å—Ç—Ä–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç
      // –¥–æ–±–∞–≤–∏–º –Ω–µ–º–Ω–æ–≥–æ –≤–æ–∑–¥—É—Ö–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞)
      const b = Math.max(20, Math.min(42, Math.floor(S * 0.08)));
      W += b; H += b;
    }

    el.style.width  = Math.ceil(W) + 'px';
    el.style.height = Math.ceil(H) + 'px';
  }

  /* ============================ AUTO-FIT —Ç–µ–∫—Å—Ç–∞ ============================ */
  function autoFitText(el, startPx, minPx){
    const span = el.querySelector('.content span');
    if(!span) return; // –∫–∞—Ä—Ç–∏–Ω–∫–∞/Math ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    let fs = startPx;
    const maxW = el.clientWidth  - 24;
    const maxH = el.clientHeight - 24;

    const ok = ()=>{
      const r = span.getBoundingClientRect();
      return (r.width <= maxW && r.height <= maxH);
    };

    // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —à—Ä–∏—Ñ—Ç ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –ø–æ —à–∞–≥—É 1px
    while(fs > minPx){
      span.style.fontSize = fs + 'px';
      if(ok()) break;
      fs -= 1;
    }
  }

  /* ============================ POP-—ç—Ñ—Ñ–µ–∫—Ç ============================ */
  function playPop(el){
    // –∑–≤—É–∫
    if(audioPrimed){
      try{
        popSound.currentTime = 0;
        popSound.play().catch(()=>{});
      }catch(_){}
    }
    // –±–ª—ë—Å—Ç–∫–∏
    const r = el.getBoundingClientRect();
    for(let i=0;i<12;i++){
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.left = (r.left + r.width/2) + 'px';
      s.style.top  = (r.top  + r.height/2) + 'px';
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*70;
      s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
      s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
      s.style.animationDuration = (0.9 / (SPEED/5)) + 's';
      document.body.appendChild(s);
      setTimeout(()=> s.remove(), 1000);
    }
  }

  /* ============================ –§–ò–ù–ò–® ============================ */
  function showFinish(){
    running = false;
    finalScoreEl.textContent = String(score);
    finishOverlay.classList.remove('hidden');
  }

  /* ============================ –î–û–ü. –ó–ê–©–ò–¢–´ ============================ */
  // –ï—Å–ª–∏ —Ä–µ—Å–∞–π–∑ ‚Äî –æ–±–Ω–æ–≤–∏–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å—Ç–∞—Ä—ã–µ –ø—É—Å—Ç—å ¬´–∂–∏–≤—É—Ç¬ª –∫–∞–∫ –µ—Å—Ç—å)
  window.addEventListener('resize', ()=>{/* no-op */}, {passive:true});

})();
</script>
</body>
</html>
