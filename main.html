<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Falling Items — Main</title>
<style>
  body {
    margin:0;
    background:#000;
    overflow:hidden;
    height:100vh;
    width:100vw;
    font-family:sans-serif;
    position:relative;
  }
  .item {
    position:absolute;
    top:-100px;
    left:50%;
    transform:translateX(-50%);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:20px 30px;
    min-width:80px;
    min-height:50px;
    color:#fff;
    font-weight:bold;
    user-select:none;
    cursor:pointer;
    transition:transform .2s;
  }
  .item img {
    max-width:160px;
    max-height:120px;
    object-fit:contain;
    display:block;
    pointer-events:none;
  }
  .sparkle {
    position:absolute;
    width:6px;
    height:6px;
    border-radius:50%;
    background:rgba(255,255,255,0.8);
    pointer-events:none;
    animation: explode 0.8s forwards;
  }
  @keyframes explode {
    to { transform:translate(var(--dx), var(--dy)) scale(0.2); opacity:0; }
  }
</style>
</head>
<body>

<audio id="popSound" src="pop.mp3" preload="auto"></audio>

<script>
(async function(){

  // ====== Загружаем JSON конфиг ======
  const params = new URLSearchParams(location.search);
  const id = params.get("id") || "demo";
  const url = `https://nikashum93.github.io/texts/data/${id}.json`;

  let cfg;
  try {
    const res = await fetch(url);
    cfg = await res.json();
  } catch(e){
    alert("Ошибка загрузки JSON: " + e.message);
    return;
  }

  const stageW = window.innerWidth;
  const stageH = window.innerHeight;

  // Параметры из редактора
  const styleCfg = cfg.style || {};
  const fallSpeed = cfg.fallSpeed || 5; // 1–10
  const speedFactor = 0.5 + (fallSpeed/10)*2; 

  const items = (cfg.levels?.[0]?.correct || []).concat(cfg.levels?.[0]?.wrong || []);

  // === Создание элемента ===
  function createItem(content){
    const div = document.createElement("div");
    div.className = "item";

    // Shape
    div.classList.add("shape-"+(styleCfg.shape||"rect"));

    // Base styles
    div.style.fontSize = (cfg.fontSize||24)+"px";
    div.style.color = cfg.textColor||"#fff";
    div.style.opacity = styleCfg.opacity ?? 1;
    div.style.fontFamily = cfg.font+", sans-serif";

    // Background
    if(styleCfg.bgImage){
      div.style.background = `url(${styleCfg.bgImage}) center/contain no-repeat`;
      div.style.padding = "40px 50px"; // extra padding
    } else {
      div.style.background = styleCfg.bgColor || "#222";
    }

    // Border
    if(styleCfg.borderOn){
      div.style.border = `${styleCfg.borderWidth||1}px solid ${styleCfg.borderColor||"#fff"}`;
    }

    // Shadow & effects
    if(styleCfg.shadow){ div.style.boxShadow = "0 8px 18px rgba(0,0,0,0.5)"; }
    if(styleCfg.glow){ div.style.boxShadow = `0 0 18px ${styleCfg.glowColor||"#0ff"}`; }
    if(styleCfg.fx3d){ div.style.boxShadow = "7px 7px 20px rgba(0,0,0,.5), inset -5px -5px 12px rgba(255,255,255,.22)"; }

    // Content
    if(/^https?:\/\//.test(content)){
      const img = document.createElement("img");
      img.src = content;
      div.appendChild(img);
    } else {
      div.textContent = content || "???";
    }

    // Position
    div.style.left = Math.random() * (stageW-200) + "px";
    div.style.top = "-120px";

    // Click (catch)
    div.addEventListener("click", ()=>{
      playPop(div);
      div.remove();
    });

    document.body.appendChild(div);

    animateFall(div);
  }

  // === Анимация падения ===
  function animateFall(el){
    let y = -100;
    const fall = ()=>{
      y += speedFactor;
      el.style.top = y + "px";
      if(y < stageH-80){
        requestAnimationFrame(fall);
      } else {
        el.remove();
      }
    };
    fall();
  }

  // === Эффект при клике ===
  function playPop(el){
    // звук
    const snd = document.getElementById("popSound");
    snd.currentTime=0; snd.play();

    // блёстки
    const rect = el.getBoundingClientRect();
    for(let i=0;i<12;i++){
      const sp = document.createElement("div");
      sp.className="sparkle";
      sp.style.left = (rect.left+rect.width/2)+"px";
      sp.style.top = (rect.top+rect.height/2)+"px";
      const angle = Math.random()*2*Math.PI;
      const dist = 50+Math.random()*50;
      sp.style.setProperty("--dx", Math.cos(angle)*dist+"px");
      sp.style.setProperty("--dy", Math.sin(angle)*dist+"px");
      document.body.appendChild(sp);
      sp.addEventListener("animationend", ()=> sp.remove());
    }
  }

  // === Старт игры ===
  let idx=0;
  function spawn(){
    if(idx<items.length){
      createItem(items[idx++]);
      setTimeout(spawn, 1000);
    }
  }
  spawn();

})();
</script>
</body>
</html>
