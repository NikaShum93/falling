<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falling Items ‚Äî Game</title>
<style>
  :root{
    --ui:#ffd700;           /* –±–µ—Ä—ë–º –∏–∑ cfg.style.borderColor */
    --ink:#ffffff;
    --glow:#00f0ff;

    /* —Å–∫–æ—Ä–æ—Å—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ—á–∫–æ–≤ */
    --score-pop-dur: 900ms;

    /* –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
    --font:"Rubik", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    --font-size:24px;
    --text-color:#ffffff;
  }

  html,body{height:100%}
  body{
    margin:0;
    background:transparent;          /* —Ñ—Ä–µ–π–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
    color:var(--ink);
    overflow:hidden;
    font-family:var(--font);
  }

  /* —Å—Ü–µ–Ω–∞ */
  #game{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
    background:transparent;          /* –Ω–∏–∫–∞–∫–∏—Ö –ø–æ–¥–ª–æ–∂–µ–∫ */
  }

  /* ===== HUD ===== */
  .hud{
    position:fixed; left:12px; top:12px; right:12px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    font-weight:700; z-index:10; pointer-events:none;
  }
  .badge{
    pointer-events:none;
    background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:10px 14px;
    box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 18px rgba(255,215,0,.08) inset;
  }
  .levelTitle{color:var(--ui)}
  .timer{min-width:110px; text-align:center}
  .score{min-width:110px; text-align:center}

  /* ===== —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é ===== */
  .start-wrap{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20;
    background:radial-gradient(ellipse at center, rgba(0,0,0,.30), rgba(0,0,0,.65));
    padding:20px;
  }
  .start-panel{
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:22px 26px;
    box-shadow:0 0 26px rgba(255,215,0,.12);
    min-width:280px;
    max-width:min(92vw, 560px);
    color:#fff;
  }
  .start-title{
    margin:0 0 8px;
    font-size:clamp(22px,3.2vw,30px);
    color:var(--ui);
    font-weight:900;
    text-align:center;
  }
  .start-desc{ opacity:.9; margin:0 0 16px; text-align:center }
  .start-row{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px }
  .btn{
    background:linear-gradient(90deg,#ffbf00,#ffd700);
    color:#000; border:0; border-radius:12px; font-weight:900;
    padding:12px 16px; cursor:pointer; font-size:16px;
    box-shadow:0 10px 26px rgba(255,215,0,.22);
  }

  /* ===== –ø–∞–¥–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç =====
     –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –¥–≤–∞ —Å–ª–æ—è:
      - .bg ‚Äî —Ñ–æ–Ω/–∫–ª–∏–ø/—Ä–∞–º–∫–∞/–ø–æ–¥—Å–≤–µ—Ç–∫–∞
      - .content ‚Äî —Ç–µ–∫—Å—Ç/–∏–∫–æ–Ω–∫–∞ –ø–æ–≤–µ—Ä—Ö, –Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è
  */
  .item{
    position:absolute;
    top:-160px;
    left:0;
    transform:translateZ(0);
    will-change:transform, top, left, width, height;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:120px;      /* –±–∞–∑–æ–≤—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
    min-height:80px;
    padding:0;
    user-select:none;
    cursor:pointer;
  }
  .item .bg{
    position:absolute; inset:0;
    background:#222;         /* –µ—Å–ª–∏ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî —Ü–≤–µ—Ç */
    opacity:1;
    border:0 solid var(--ui);
    box-shadow:none;
    transition:filter .15s ease;
    background-position:center !important;
    background-repeat:no-repeat !important;
    background-size:contain !important;   /* –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ */
  }
  .item .content{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    padding:22px 26px;    /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
    max-width:360px;
    max-height:240px;
    text-align:center;
    line-height:1.15;
  }
  .item .content span{
    display:inline-block;
    font-weight:800;
    white-space:nowrap;
    color:var(--text-color);
    font-family:var(--font);
    font-size:var(--font-size);
    text-shadow:0 0 0 rgba(0,0,0,0);
  }
  .item .content img{
    display:block;
    max-width:180px;
    max-height:140px;
    object-fit:contain;
    pointer-events:none;
  }

  /* —Ñ–æ—Ä–º—ã ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –ö –ö–û–ù–¢–ï–ô–ù–ï–†–£ —á–µ—Ä–µ–∑ —Ñ–æ–Ω-—Å–ª–æ–π .bg */
  .shape-rect .bg{ border-radius:10px }
  .shape-rounded .bg{ border-radius:20px }
  .shape-circle .bg{ border-radius:50% }
  .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
  .shape-star .bg{ clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%) }

  /* —ç—Ñ—Ñ–µ–∫—Ç—ã */
  .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
  .fx-3d .bg{ box-shadow:
      7px 7px 20px rgba(0,0,0,.5),
      inset -5px -5px 12px rgba(255,255,255,.22) }
  .fx-glow .bg{ box-shadow:0 0 18px var(--glow, #00f0ff) }
  .fx-border .bg{ border-style:solid }

  /* –∫–ª–∏–∫-–ø–æ–ø –∞–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è */
  .caught{ animation:pop .45s ease forwards }
  @keyframes pop{
    0%{ transform:scale(1); opacity:1 }
    50%{ transform:scale(1.15); opacity:1 }
    100%{ transform:scale(0.85); opacity:0 }
  }

  /* –±–ª—ë—Å—Ç–∫–∏ –Ω–∞ –∫–ª–∏–∫ */
  .sparkle{
    position:fixed;     /* –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    width:6px; height:6px; border-radius:50%;
    background:rgba(255,255,255,.95);
    pointer-events:none;
    animation:spark 0.9s forwards;
    filter:drop-shadow(0 0 6px #fff);
    z-index:50;
  }
  @keyframes spark{
    from{ opacity:1; transform:translate(0,0) scale(1) }
    to{ opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
  }

  /* –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ—á–∫–∏ –Ω–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–µ */
  .score-float{
    position:fixed;
    font-weight:900;
    font-size:18px;
    color:#fff;
    text-shadow:0 0 8px var(--ui), 0 0 20px var(--ui);
    transform:translate(-50%,-50%);
    pointer-events:none;
    animation:scorePop var(--score-pop-dur) ease-out forwards;
    z-index:60;
  }
  @keyframes scorePop{
    0%{ opacity:0; transform:translate(-50%,-20%) scale(.9) }
    20%{ opacity:1; transform:translate(-50%,-40%) scale(1.05) }
    100%{ opacity:0; transform:translate(-50%,-90%) scale(1.0) }
  }

  /* —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π */
  .overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.9));
    color:#fff; z-index:40; gap:18px; padding:20px;
  }
  .overlay .panel{
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:20px 26px;
    text-align:center;
    box-shadow:0 0 26px rgba(255,215,0,.1);
    min-width:280px; max-width:min(92vw, 560px);
  }
  .overlay .panel h2{ margin:0 0 8px; font-size:clamp(22px,3.2vw,30px); color:var(--ui) }
  .overlay .panel .stat{ margin:6px 0; opacity:.92 }
  .overlay .panel .title{ margin-top:12px; font-size:18px; color:#ffeaa7; font-weight:900 }

  /* –º–∏–Ω–∏-—Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏ (—É—Ä–æ–≤–µ–Ω—å –∑–∞–≤–µ—Ä—à—ë–Ω) */
  .fw{
    position:fixed; width:6px; height:6px; border-radius:50%;
    background:var(--ui);
    pointer-events:none; z-index:55; opacity:0;
    animation:fw 900ms ease-out forwards;
    box-shadow:0 0 12px var(--ui), 0 0 22px var(--ui);
  }
  @keyframes fw{
    0%{ opacity:0; transform:translate(var(--x),var(--y)) scale(.5) }
    10%{ opacity:1 }
    100%{ opacity:0; transform:translate(var(--x2),var(--y2)) scale(.2) }
  }
</style>
</head>
<body>

<!-- HUD -->
<div class="hud">
  <div class="badge levelTitle" id="hudLevel">‚Äî</div>
  <div class="badge timer" id="hudTimer">00</div>
  <div class="badge score" id="hudScore">0</div>
</div>

<!-- —Å—Ü–µ–Ω–∞ -->
<div id="game" aria-live="polite"></div>

<!-- —Å—Ç–∞—Ä—Ç -->
<div class="start-wrap" id="startWrap" hidden>
  <div class="start-panel">
    <h3 class="start-title" id="startTitle">Falling Items</h3>
    <p class="start-desc" id="startDesc"></p>
    <div class="start-row">
      <button class="btn" id="btnStart">Start</button>
    </div>
  </div>
</div>

<!-- –∑–≤—É–∫–∏ -->
<audio id="popSound" src="pop.mp3" preload="auto"></audio>
<audio id="winSound" src="win.mp3" preload="auto"></audio>

<!-- MathJax –¥–ª—è LaTeX -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
(async function(){

  // ===== –∫–æ—Ä–æ—Ç–∫–∏–µ —É—Ç–∏–ª—ã
  const $  = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  const rnd   = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  // ===== –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
  const L = {
    ru: {
      startTitle: "–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
      startDesc:  "–õ–æ–≤–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã. –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫. –£–¥–∞—á–∏!",
      startBtn:   "–ù–∞—á–∞—Ç—å",
      hudLevel:   (n,t)=>`–£—Ä–æ–≤–µ–Ω—å ${n}: ${t||''}`,
      finished:   "–§–∏–Ω–∏—à! üéâ",
      statScore:  s => `–°—á—ë—Ç: <b>${s}</b>`,
      statHit:    n => `–ü–æ–ø–∞–¥–∞–Ω–∏–π: <b>${n}</b>`,
      statMiss:   n => `–ü—Ä–æ–º–∞—Ö–æ–≤: <b>${n}</b>`,
      statSkip:   n => `–ü—Ä–æ–ø—É—â–µ–Ω–æ: <b>${n}</b>`,
      again:      "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ",

      titles: [
        {min:0,    name:"–ù–æ–≤–∏—á–æ–∫"},
        {min:100,  name:"–£–≤–µ—Ä–µ–Ω–Ω—ã–π"},
        {min:300,  name:"–õ–æ–≤–∫–∞—á"},
        {min:700,  name:"–ú–∞—Å—Ç–µ—Ä –ª–æ–≤–ª–∏"},
        {min:1200, name:"–ì—Ä–∏–º-–ª–µ–≥–µ–Ω–¥–∞"}
      ],
      scorePlus: v=>`+${v}`
    },
    en: {
      startTitle: "Falling Items",
      startDesc:  "Catch only the correct items. Speed depends on settings. Good luck!",
      startBtn:   "Start",
      hudLevel:   (n,t)=>`Level ${n}: ${t||''}`,
      finished:   "Finish! üéâ",
      statScore:  s => `Score: <b>${s}</b>`,
      statHit:    n => `Hits: <b>${n}</b>`,
      statMiss:   n => `Misses: <b>${n}</b>`,
      statSkip:   n => `Skipped: <b>${n}</b>`,
      again:      "Play again",

      titles: [
        {min:0,    name:"Beginner"},
        {min:100,  name:"Steady"},
        {min:300,  name:"Quick Hands"},
        {min:700,  name:"Catcher Pro"},
        {min:1200, name:"Legend"}
      ],
      scorePlus: v=>`+${v}`
    },
    fr: {
      startTitle:"Objets tombants",
      startDesc:"Attrape seulement les bons objets. La vitesse d√©pend des r√©glages.",
      startBtn:"Commencer",
      hudLevel:(n,t)=>`Niveau ${n} : ${t||''}`,
      finished:"Termin√© ! üéâ",
      statScore:s=>`Score : <b>${s}</b>`,
      statHit:n=>`R√©ussites : <b>${n}</b>`,
      statMiss:n=>`Erreurs : <b>${n}</b>`,
      statSkip:n=>`Oubli√©s : <b>${n}</b>`,
      again:"Rejouer",
      titles:[
        {min:0,name:"D√©butant"},
        {min:100,name:"Assur√©"},
        {min:300,name:"Rapide"},
        {min:700,name:"Ma√Ætre"},
        {min:1200,name:"L√©gende"}
      ],
      scorePlus:v=>`+${v}`
    },
    es: {
      startTitle:"Elementos que caen",
      startDesc:"Atrap√° solo los correctos. La velocidad depende de los ajustes.",
      startBtn:"Empezar",
      hudLevel:(n,t)=>`Nivel ${n}: ${t||''}`,
      finished:"¬°Final! üéâ",
      statScore:s=>`Puntuaci√≥n: <b>${s}</b>`,
      statHit:n=>`Aciertos: <b>${n}</b>`,
      statMiss:n=>`Fallos: <b>${n}</b>`,
      statSkip:n=>`Perdidos: <b>${n}</b>`,
      again:"Jugar de nuevo",
      titles:[
        {min:0,name:"Principiante"},
        {min:100,name:"Seguro"},
        {min:300,name:"R√°pido"},
        {min:700,name:"Maestro"},
        {min:1200,name:"Leyenda"}
      ],
      scorePlus:v=>`+${v}`
    },
    de: {
      startTitle:"Fallende Objekte",
      startDesc:"Fang nur die richtigen. Die Geschwindigkeit h√§ngt von den Einstellungen ab.",
      startBtn:"Start",
      hudLevel:(n,t)=>`Level ${n}: ${t||''}`,
      finished:"Geschafft! üéâ",
      statScore:s=>`Punkte: <b>${s}</b>`,
      statHit:n=>`Treffer: <b>${n}</b>`,
      statMiss:n=>`Fehlklicks: <b>${n}</b>`,
      statSkip:n=>`Verpasst: <b>${n}</b>`,
      again:"Nochmal",
      titles:[
        {min:0,name:"Anf√§nger"},
        {min:100,name:"Sicher"},
        {min:300,name:"Schnell"},
        {min:700,name:"Meister"},
        {min:1200,name:"Legende"}
      ],
      scorePlus:v=>`+${v}`
    },
    ja: {
      startTitle:"ËêΩ„Å°Áâ©„Ç≠„É£„ÉÉ„ÉÅ",
      startDesc:"Ê≠£„Åó„ÅÑ„ÇÇ„ÅÆ„Å†„Åë„Çí„Ç≠„É£„ÉÉ„ÉÅ„ÄÇÈÄüÂ∫¶„ÅØË®≠ÂÆö„Å´„Çà„Çä„Åæ„Åô„ÄÇ",
      startBtn:"„Çπ„Çø„Éº„Éà",
      hudLevel:(n,t)=>`„É¨„Éô„É´ ${n}: ${t||''}`,
      finished:"„Ç¥„Éº„É´ÔºÅ üéâ",
      statScore:s=>`„Çπ„Ç≥„Ç¢: <b>${s}</b>`,
      statHit:n=>`„Éí„ÉÉ„Éà: <b>${n}</b>`,
      statMiss:n=>`„Éü„Çπ: <b>${n}</b>`,
      statSkip:n=>`Ë¶ãÈÄÉ„Åó: <b>${n}</b>`,
      again:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶",
      titles:[
        {min:0,name:"„Éì„ÇÆ„Éä„Éº"},
        {min:100,name:"ÂÆâÂÆö"},
        {min:300,name:"‰øäÊïè"},
        {min:700,name:"Âêç‰∫∫"},
        {min:1200,name:"„É¨„Ç∏„Çß„É≥„Éâ"}
      ],
      scorePlus:v=>`+${v}`
    },
    zh: {
      startTitle:"‰∏ãËêΩÁâ©‰Ωì",
      startDesc:"Âè™Êé•‰ΩèÊ≠£Á°ÆÁöÑ„ÄÇÈÄüÂ∫¶Áî±ËÆæÁΩÆÂÜ≥ÂÆö„ÄÇ",
      startBtn:"ÂºÄÂßã",
      hudLevel:(n,t)=>`Á¨¨ ${n} ÂÖ≥Ôºö${t||''}`,
      finished:"ÁªìÊùüÔºÅüéâ",
      statScore:s=>`ÂæóÂàÜÔºö<b>${s}</b>`,
      statHit:n=>`ÂëΩ‰∏≠Ôºö<b>${n}</b>`,
      statMiss:n=>`ËØØÂáªÔºö<b>${n}</b>`,
      statSkip:n=>`ÊºèÊé•Ôºö<b>${n}</b>`,
      again:"ÂÜçÊù•‰∏ÄÊ¨°",
      titles:[
        {min:0,name:"Êñ∞Êâã"},
        {min:100,name:"Á®≥ÂÅ•"},
        {min:300,name:"ÊïèÊç∑"},
        {min:700,name:"Â§ßÂ∏à"},
        {min:1200,name:"‰º†Â•á"}
      ],
      scorePlus:v=>`+${v}`
    }
  };

  // ===== –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id){ alert('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id'); return; }

  const jsonUrl = `https://nikashum93.github.io/texts/data/${id}.json`;
  let cfg;
  try{
    const res = await fetch(jsonUrl, { cache:'no-store' });
    cfg = await res.json();
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message);
    return;
  }

  // ===== –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const lang = (cfg.language||'ru');
  const T = L[lang] || L.ru;

  const SPEED = clamp(Number(cfg.speed ?? 5), 1, 10);           // 1‚Äì10
  const FONT  = cfg.font || 'Rubik';
  const FONT_SIZE = Number(cfg.fontSize || 24);
  const TEXT_COLOR = cfg.textColor || '#ffffff';
  const STYLE = cfg.style || {};
  const CURSOR = cfg.cursor || '';

  // –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–Ω—ã–π —Ü–≤–µ—Ç ‚Äî –∏–∑ borderColor (–¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è —Ä–∞–º–∫–∏)
  const UI_COLOR = STYLE.borderColor || '#ffd700';

  // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞ –∫–æ—Ä–µ–Ω—å
  document.documentElement.style.setProperty('--ui', UI_COLOR);
  document.documentElement.style.setProperty('--font', `"${FONT}", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
  document.documentElement.style.setProperty('--font-size', `${FONT_SIZE}px`);
  document.documentElement.style.setProperty('--text-color', TEXT_COLOR);

  // –ø–æ–¥–≥—Ä—É–∑–∏–º —à—Ä–∏—Ñ—Ç
  const gf = document.createElement('link');
  gf.rel = 'stylesheet';
  gf.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(FONT).replace(/%20/g,'+')}%3Awght@400;700&display=swap`;
  document.head.appendChild(gf);

  // –∫—É—Ä—Å–æ—Ä
  if(CURSOR) document.body.style.cursor = `url(${CURSOR}), auto`;

  // —Ä–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π (–µ—Å–ª–∏ –Ω–∞–¥–æ)
  const levels = Array.isArray(cfg.levels) ? [...cfg.levels] : [];
  if(cfg.randomLevels){
    for(let i=levels.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [levels[i], levels[j]] = [levels[j], levels[i]];
    }
  }
  if(!levels.length){
    levels.push({ target:'‚Äî', correct:['A','B'], wrong:['C'], timer:20 });
  }

  // ===== DOM
  const game = $('#game');
  const popSound = $('#popSound');
  const winSound = $('#winSound');
  const hudLevel = $('#hudLevel');
  const hudTimer = $('#hudTimer');
  const hudScore = $('#hudScore');

  // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
  const startWrap = $('#startWrap');
  const startTitle = $('#startTitle');
  const startDesc  = $('#startDesc');
  const btnStart   = $('#btnStart');
  startTitle.textContent = T.startTitle;
  startDesc.textContent  = T.startDesc;
  btnStart.textContent   = T.startBtn;

  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç
  startWrap.hidden = false;

  // ===== —Å–æ—Å—Ç–æ—è–Ω–∏—è
  let score = 0;
  let hits = 0;
  let misses = 0;    // –∫–ª–∏–∫–∏ –ø–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
  let skipped = 0;   // —É–ª–µ—Ç–µ–≤—à–∏–µ –∑–∞ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π
  let current = 0;

  // —Å—Ç—Ä–∏–∫ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –æ—á–∫–æ–≤
  let streak = 0;          // —Ü–µ–ø–æ—á–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π –ø–æ–¥—Ä—è–¥
  const baseForSpeed = s => 6 + Math.round(s*6); // 1=>12, 5=>36, 10=>66
  const perHitPoints = () => {
    // —Ä–∞—Å—Ç—ë—Ç —Å –∫–∞–∂–¥–æ–π —É–¥–∞—á–Ω–æ–π –ø–æ —Ü–µ–ø–æ—á–∫–µ; –¥–∞—ë–º –ø–æ—Ç–æ–ª–æ–∫ –¥–ª—è –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç–∏
    const base = baseForSpeed(SPEED);
    const add  = Math.min(12, Math.floor(streak*0.6)); // –∑–∞ —Å—Ç—Ä–∏–∫
    return base + add;
  };

  // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è: 1 ‚Äî –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, 10 ‚Äî –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ
  // –ø–µ—Ä–µ–≤–æ–¥–∏–º 1..10 –≤ –ø–∏–∫—Å/–∫–∞–¥—Ä
  const velForSpeed = s => {
    const t = (s-1)/9;               // 0..1
    return 0.6 + t*(6.0-0.6);        // 0.6 .. 6.0 px/frame
  };

  // –∫–∞—á–∞–Ω–∏–µ
  const swayAmpForSpeed = s => lerp(8, 28, (s-1)/9);
  const swayFreqForSpeed= s => lerp(0.0025, 0.010, (s-1)/9);
  function lerp(a,b,t){ return a + (b-a)*t; }

  // –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è HUD
  function setLevelHud(n, t){
    hudLevel.textContent = T.hudLevel(n, t);
  }

  // ===== —Å—Ç–∞—Ä—Ç –ø–æ –∫–Ω–æ–ø–∫–µ (—Ä–∞–∑—Ä–µ—à–∏—Ç –∑–≤—É–∫)
  btnStart.addEventListener('click', ()=>{
    startWrap.hidden = true;
    startLevel();
  });

  // ===== –∑–∞–ø—É—Å–∫ —É—Ä–æ–≤–Ω—è
  let levelTimerHandle = null;
  let spawnerHandle = null;
  let running = false;

  function startLevel(){
    if(current >= levels.length){ showFinish(); return; }

    running = true;
    const lv = levels[current];
    setLevelHud(current+1, lv.target || '');

    // —Ç–∞–π–º–µ—Ä
    let timeLeft = Math.max(5, Number(lv.timer || 30));
    hudTimer.textContent = timeLeft.toString().padStart(2,'0');
    clearInterval(levelTimerHandle);
    levelTimerHandle = setInterval(()=>{
      if(!running) return;
      timeLeft--;
      hudTimer.textContent = timeLeft.toString().padStart(2,'0');
      if(timeLeft <= 0){
        clearInterval(levelTimerHandle);
        clearInterval(spawnerHandle);
        // —Ñ–∏–Ω–∞–ª —É—Ä–æ–≤–Ω—è ‚Äî —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫
        burstFirework(UI_COLOR);
        try{ winSound.currentTime = 0; winSound.play().catch(()=>{}); }catch(_){}
        // –ø–æ–¥—á–∏—Å—Ç–∏–º –ø–æ–ª–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
        setTimeout(()=>{
          document.querySelectorAll('.item').forEach(n=>n.remove());
          current++;
          startLevel();
        }, 900);
      }
    }, 1000);

    // –ø—É–ª –æ–±—ä–µ–∫—Ç–æ–≤
    const pool = [
      ...(lv.correct||[]).map(v=>({val:v, good:true})),
      ...(lv.wrong||[]).map(v=>({val:v, good:false}))
    ];
    if(!pool.length) pool.push({val:'A', good:true}, {val:'B', good:false});

    // —Å–ø–∞–≤–Ω
    clearInterval(spawnerHandle);
    const baseDelay = 1200; // —á–µ–º –±–æ–ª—å—à–µ —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî —Ç–µ–º —á–∞—â–µ
    const delay = clamp(baseDelay / (SPEED/5), 280, 2400);
    spawnerHandle = setInterval(()=>{
      if(!running) return;
      const obj = pool[Math.floor(Math.random()*pool.length)];
      drop(obj, lv);
    }, delay);
  }

  // ===== —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–∞–¥–µ–Ω–∏–µ
  function drop(obj, lv){
    const el = document.createElement('div');
    el.className = `item shape-${STYLE.shape || 'rounded'} ${STYLE.shadow?'fx-shadow':''} ${STYLE.fx3d?'fx-3d':''} ${STYLE.glow?'fx-glow':''} ${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;
    el.dataset.good = obj.good ? '1' : '0';
    el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

    // —Å–ª–æ–∏
    const bg = document.createElement('div');
    bg.className = 'bg';
    const content = document.createElement('div');
    content.className = 'content';
    el.appendChild(bg); el.appendChild(content);

    // —Ñ–æ–Ω-—Å–ª–æ–π:
    // ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å bgImage => –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –≤–º–µ—à–∏–≤–∞–µ—Ç—Å—è)
    // ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç bgImage => –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç STYLE.bgColor + (opacity)
    const bgImg = (STYLE.bgImage||'').trim();
    const hasImage = !!bgImg;
    if (hasImage) {
      bg.style.backgroundImage = `url(${bgImg})`;
      bg.style.backgroundColor = 'transparent';
    } else {
      bg.style.backgroundImage = 'none';
      bg.style.backgroundColor = STYLE.bgColor || 'transparent';
    }
    bg.style.opacity = clamp(Number(STYLE.opacity ?? 1), 0, 1);

    // —Ä–∞–º–∫–∞ –Ω–∞ –∞–π—Ç–µ–º–∞—Ö: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ–Ω–∞-–∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –≤–∫–ª—é—á–µ–Ω–∞ —Ä–∞–º–∫–∞
    if(!hasImage && STYLE.borderOn && STYLE.borderWidth>0){
      bg.style.borderColor = UI_COLOR;
      bg.style.borderWidth = `${parseInt(STYLE.borderWidth,10)||1}px`;
    } else {
      bg.style.borderWidth = '0px';
    }

    // –∫–æ–Ω—Ç–µ–Ω—Ç: URL => –∏–∫–æ–Ω–∫–∞, math => LaTeX, –∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç
    if(/^https?:\/\//i.test(obj.val)){
      const img = document.createElement('img');
      img.src = obj.val;
      content.appendChild(img);
    } else if((cfg.language||'') === 'math'){
      const span = document.createElement('span');
      span.textContent = `\\(${obj.val}\\)`;
      content.appendChild(span);
    } else {
      const span = document.createElement('span');
      span.textContent = String(obj.val);
      span.style.color = TEXT_COLOR;
      span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
      span.style.fontSize = `${FONT_SIZE}px`;
      content.appendChild(span);
    }

    // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
    const gw = game.clientWidth;
    const startX = Math.max(16, Math.min(gw-220, rnd(0, gw-220)));
    el.style.left = startX + 'px';
    el.style.top = '-160px';

    // –≤ DOM ‚Äî —á—Ç–æ–±—ã –º–µ—Ä–∏—Ç—å
    game.appendChild(el);

    // –∞–≤—Ç–æ-–ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç:
    // ‚Äî –¥–ª—è rect/rounded: –∫–æ–Ω—Ç–µ–Ω—Ç + –ø–æ–ª—è
    // ‚Äî –¥–ª—è circle/diamond/star: –∫–≤–∞–¥—Ä–∞—Ç, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–µ—â–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç + –ø–æ–ª—è
    fitGeometryBox(el);

    // –∞–≤—Ç–æ—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞ (—É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –≤–ª–∞–∑–∏—Ç)
    autoFitText(el, FONT_SIZE, 12);

    // MathJax (–µ—Å–ª–∏ math)
    if((cfg.language||'') === 'math') {
      MathJax.typesetPromise([el]).then(()=> {
        fitGeometryBox(el);
      });
    }

    // –ø–∞–¥–µ–Ω–∏–µ
    const vel = velForSpeed(SPEED);
    const swayAmp = swayAmpForSpeed(SPEED);
    const swayFreq = swayFreqForSpeed(SPEED);
    let y = -160;
    let t = 0;
    let alive = true;

    function step(){
      if(!alive) return;
      y += vel; t += 1;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if(y > game.clientHeight + 220){
        alive = false;
        // –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ‚Äî —Å—á–∏—Ç–∞–µ–º –∫–∞–∫ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π (–Ω–æ –æ—á–∫–∏ –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ–º)
        if(el.dataset.good === '1') skipped++;
        el.remove();
        return;
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    // –∫–ª–∏–∫
    el.addEventListener('click', (ev)=>{
      if(!alive) return;
      const rect = el.getBoundingClientRect();
      if(el.dataset.good === '1'){
        hits++;
        streak++;
        const pts = perHitPoints();
        score += pts;
        hudScore.textContent = score;
        showScoreFloat(rect.left + rect.width/2, rect.top + rect.height/2, T.scorePlus(pts));
        playPop(el);
        alive = false;
        el.classList.add('caught');
        setTimeout(()=> el.remove(), 420);
      } else {
        // –ø—Ä–æ–º–∞—Ö –ø–æ –Ω–µ–≤–µ—Ä–Ω–æ–º—É
        misses++;
        streak = 0; // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∏–∫
        // –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        bg.style.filter = 'brightness(2) saturate(1.6) hue-rotate(-30deg)';
        setTimeout(()=> bg.style.filter = 'none', 220);
      }
    }, {passive:true});
  }

  // ===== –ø—Ä–∏–≤–µ—Å—Ç–∏ –±–æ–∫—Å —Ñ–æ—Ä–º—ã –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç
  function fitGeometryBox(el){
    const shape = STYLE.shape || 'rounded';
    const content = el.querySelector('.content');
    const rect = content.getBoundingClientRect();

    // –ø–æ–ª—è –≤–æ–∫—Ä—É–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∞ –±—ã–ª–∞ –±–æ–ª—å—à–µ —Ç–µ–∫—Å—Ç–∞)
    const pad = 28; // –≤–∏–∑—É–∞–ª—å–Ω—ã–π ¬´–≤–æ–∑–¥—É—Ö¬ª
    const w = rect.width + pad;
    const h = rect.height + pad;

    if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
      const size = Math.max(w, h);
      el.style.width = (size) + 'px';
      el.style.height= (size) + 'px';
    } else {
      el.style.width = (w) + 'px';
      el.style.height= (h) + 'px';
    }
  }

  // ===== –∞–≤—Ç–æ-—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏–ª—Å—è
  function autoFitText(el, startPx, minPx){
    const span = el.querySelector('.content span');
    if(!span) return;
    let fs = startPx;
    const maxW = el.clientWidth - 24;
    const maxH = el.clientHeight - 24;
    // –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –≤–ª–∞–∑–∏—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
    if (span.getBoundingClientRect().width <= maxW && span.getBoundingClientRect().height <= maxH) return;

    while(fs > minPx){
      span.style.fontSize = fs + 'px';
      const r = span.getBoundingClientRect();
      if(r.width <= maxW && r.height <= maxH) break;
      fs -= 1;
    }
  }

  // ===== —ç—Ñ—Ñ–µ–∫—Ç—ã
  function playPop(el){
    // –∑–≤—É–∫
    try{ popSound.currentTime = 0; popSound.play().catch(()=>{}); }catch(_){}
    // –±–ª—ë—Å—Ç–∫–∏
    const r = el.getBoundingClientRect();
    for(let i=0;i<14;i++){
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.left = (r.left + r.width/2) + 'px';
      s.style.top  = (r.top  + r.height/2) + 'px';
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*70;
      s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
      s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
      s.style.animationDuration = (0.9 / (SPEED/5)) + 's';
      document.body.appendChild(s);
      setTimeout(()=> s.remove(), 1000);
    }
  }

  function showScoreFloat(x, y, label){
    const n = document.createElement('div');
    n.className = 'score-float';
    n.textContent = label;
    n.style.left = x + 'px';
    n.style.top  = y + 'px';
    document.body.appendChild(n);
    setTimeout(()=> n.remove(), 1000);
  }

  function burstFirework(color){
    for(let i=0;i<24;i++){
      const p = document.createElement('div');
      p.className = 'fw';
      p.style.background = color;
      const x = rnd(20, window.innerWidth-20);
      const y = rnd(20, window.innerHeight-20);
      p.style.setProperty('--x', x+'px');
      p.style.setProperty('--y', y+'px');
      const dx = rnd(-140, 140);
      const dy = rnd(-160, 80);
      p.style.setProperty('--x2', (x+dx)+'px');
      p.style.setProperty('--y2', (y+dy)+'px');
      document.body.appendChild(p);
      setTimeout(()=> p.remove(), 1100);
    }
  }

  // ===== —Ñ–∏–Ω–∞–ª –≤—Å–µ–π –∏–≥—Ä—ã
  function showFinish(){
    running = false;
    const ov = document.createElement('div');
    ov.className = 'overlay';
    ov.innerHTML = `
      <div class="panel" style="--ui:${UI_COLOR}">
        <h2>${T.finished}</h2>
        <div class="stat">${T.statScore(score)}</div>
        <div class="stat">${T.statHit(hits)}</div>
        <div class="stat">${T.statMiss(misses)}</div>
        <div class="stat">${T.statSkip(skipped)}</div>
        <div class="title">${pickTitle(T.titles, score)}</div>
        <div style="margin-top:12px">
          <button class="btn" id="btnAgain">${T.again}</button>
        </div>
      </div>
    `;
    document.body.appendChild(ov);
    $('#btnAgain').onclick = ()=> location.reload();
  }

  function pickTitle(list, s){
    let last = list[0]?.name || "";
    for(const t of list){
      if(s >= t.min) last = t.name;
      else break;
    }
    return last;
  }

})(); // IIFE
</script>
</body>
</html>
