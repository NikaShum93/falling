<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falling Items ‚Äî Game</title>

  <!--
    ==========================================================================================
    –û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ö–ò (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ id/json):
    - –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω iframe —Ü–µ–ª–∏–∫–æ–º.
    - –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é —Ä–æ–≤–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É.
    - –í–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–π —Ñ–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–∞: –ª–∏–±–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∫–∞, –ª–∏–±–æ —Å–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç (–Ω–µ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è).
    - –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä –Ω–µ ¬´–ø—Ä–∏–ø–ª—é—Å–Ω—É—Ç–∞¬ª (–∫—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞ = –∫–≤–∞–¥—Ä–∞—Ç –ø–æ –≤–Ω–µ—à–Ω–µ–º—É –±–æ–∫—Å—É).
    - –ö–ª–∏–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.
    - –¶–≤–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (=–∞–∫—Ü–µ–Ω—Ç HUD/–º–µ–Ω—é) –±–µ—Ä—ë—Ç—Å—è –∏–∑ style.borderColor –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–∞–º–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞/–∑–∞–º–µ–Ω–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.
    - –°–∫–æ—Ä–æ—Å—Ç—å: 1 ‚Äî –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ; 10 ‚Äî –±—ã—Å—Ç—Ä–æ. –ü–ª–∞–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–¥–µ–Ω–∏—è/—Å–ø–∞–≤–Ω–∞.
    - –û—á–∫–∏: –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ + –∫–æ–º–±–æ (streak). –ü—Ä–æ–º–∞—Ö –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ—Ç –æ—á–∫–∏, –Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–º–±–æ.
    - –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω: –ø–æ–ø–∞–¥–∞–Ω–∏—è/–º–∏–º–æ/—É—à–µ–¥—à–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ/–∏—Ç–æ–≥, –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ cfg.finalFeedback (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω).
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MathJax (language:'math').
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏ —É—Ä–æ–≤–Ω–µ–π (cfg.randomLevels === true).
    ==========================================================================================
  -->

  <style>
   :root{
  --ui: #ffd700;
  --ui-soft: rgba(255,215,0,.14);
  --glow: #00f0ff;
  --text-color: #ffffff; /* ‚Üê –¥–µ—Ñ–æ–ª—Ç, –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—Ç—Å—è –∏–∑ cfg.textColor */
}


      /* –¶–≤–µ—Ç –Ω–µ–æ–Ω–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω cfg.style.glow) */
      --glow: #00f0ff;
    }

    /* –ë–ê–ó–ê */
    html,body{height:100%}
    body{
      margin:0;
      background: transparent;          /* –í–ê–ñ–ù–û: —Ñ–æ–Ω –≤—Å–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
      color:#fff;
      overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    /* –°—Ü–µ–Ω–∞ */
    #game{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      /* –Ω–∏–∫–∞–∫–∏—Ö —Ñ–æ–Ω–æ–≤ ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–æ –≥—Ä–∞–Ω–∏—Ü iframe */
    }

    /* HUD */
    .hud{
      position:fixed; left:12px; top:12px; right:12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      font-weight:700; z-index:10; pointer-events:none;
    }
 .badge{
  background: var(--ui);   /* —Ñ–æ–Ω = uiColor */
  border:1px solid var(--ui-soft);
  border-radius:12px;
  padding:10px 14px;
  box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 18px var(--ui-soft) inset;
  color: var(--text-color); /* —Ç–µ–∫—Å—Ç = textColor */
}

    .levelTitle{ color:var(--ui) }
    .timer{min-width:110px; text-align:center}
    .score{min-width:110px; text-align:center}

    /* –û–≤–µ—Ä–ª–µ–∏ (—Å—Ç–∞—Ä—Ç/–º–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã–π/—Ñ–∏–Ω–∞–ª) */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background: none;                /* –ù–∏–∫–∞–∫–∏—Ö –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–π ‚Äî —Ñ—Ä–µ–π–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
      color:#fff; z-index:20; gap:18px;
      pointer-events:auto;
    }
.overlay .panel{
  background: var(--ui);      /* —Ñ–æ–Ω = uiColor */
  padding:36px 28px;
  border-radius:16px;
  border:1px solid var(--ui-soft);
  max-width:400px;
  margin:auto;
  text-align:center;
  box-shadow:0 8px 32px rgba(0,0,0,.45), 0 0 22px var(--ui-soft);
  color: var(--text-color);   /* —Ç–µ–∫—Å—Ç = textColor */
}
.overlay .panel h2{
  margin:0 0 12px;
  color: var(--text-color);   /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ = textColor */
  font-size:24px;
  text-shadow:0 0 20px var(--ui-soft);
}

    .overlay p{ margin:0 0 8px; opacity:.9 }
    .overlay .row{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap }
    
    .overlay button{
  background: var(--ui);        /* —Ñ–æ–Ω = uiColor */
  color: var(--text-color);     /* —Ç–µ–∫—Å—Ç = textColor */
transition:transform .12s ease, box-shadow .12s ease;
    }
    .overlay button:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(255,215,0,.35) }

    /* –ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    .item{
      position:absolute;
      top:-160px; left:0;
      transform:translateZ(0);
      will-change:transform, top, left, width, height;
      display:inline-flex;
      align-items:center; justify-content:center;
      min-width:120px; min-height:80px;
      padding:0;                          /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã ‚Äî –≤ .content */
      user-select:none; cursor:pointer;
    }
    .item .bg{
      position:absolute; inset:0;
      background: transparent;            /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π */
      opacity:1;
      border:0 solid #fff;                /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏–∑ cfg.style */
      box-shadow:none;                    /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—é–¥–∞ */
      transition:filter .15s ease;
      background-position:center !important;
      background-repeat:no-repeat !important;
      background-size: contain !important;/* –ö–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –±–æ–∫—Å */
    }
    .item .content{
      position:relative; z-index:1;
      display:flex; align-items:center; justify-content:center;
      padding:22px 28px;                  /* ¬´–≤–æ–∑–¥—É—Ö¬ª –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞/–∏–∫–æ–Ω–∫–∏ */
      text-align:center;
      line-height:1.15;
      max-width:520px; max-height:300px;  /* –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å; –¥–∞–ª—å—à–µ –∞–≤—Ç–æ—Ñ–∏—Ç –ø–æ–¥—Ä–µ–∂–µ—Ç */
    }
    .item .content span{
      display:inline-block;
      font-weight:800;
      white-space:nowrap;
    }
    .item .content img{
      display:block;
      max-width:180px; max-height:140px;
      object-fit:contain;
      pointer-events:none;
    }

    /* –§–∏–≥—É—Ä—ã ‚Äî –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ .bg (—Ñ–æ–Ω-—Å–ª–æ–π), –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è */
    .shape-rect    .bg{ border-radius:10px }
    .shape-rounded .bg{ border-radius:20px }
    .shape-circle  .bg{ border-radius:50% }
    .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
    .shape-star    .bg{
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%,
        68% 57%, 79% 91%, 50% 70%,
        21% 91%, 32% 57%, 2% 35%, 39% 35%
      );
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
    .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.55) }
    .fx-3d     .bg{ box-shadow: 7px 7px 20px rgba(0,0,0,.55), inset -5px -5px 12px rgba(255,255,255,.22) }
    .fx-glow   .bg{ box-shadow:0 0 18px var(--glow, #00f0ff), 0 0 28px rgba(0,0,0,.25) }
    .fx-border .bg{ border-style:solid }

    /* –ü–æ–ø –ø—Ä–∏ –ª–æ–≤–ª–µ */
    .caught{ animation:pop .45s ease forwards }
    @keyframes pop{
      0%{ transform:scale(1); opacity:1 }
      50%{ transform:scale(1.14); opacity:1 }
      100%{ transform:scale(0.85); opacity:0 }
    }

    /* –ë–ª—ë—Å—Ç–∫–∏ */
    .sparkle{
      position:absolute; width:6px; height:6px; border-radius:50%;
      background:rgba(255,255,255,.9); pointer-events:none;
      animation:spark 0.9s forwards;
      filter:drop-shadow(0 0 6px #fff); z-index:5;
    }
    @keyframes spark{
      from{ opacity:1; transform:translate(0,0) scale(1) }
      to  { opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ—á–∫–∏ */
    .score-float{
      position:fixed; z-index:30;
      font-weight:900;
      text-shadow: 0 0 10px rgba(255,255,255,.5), 0 0 20px var(--ui-soft);
      animation:floatUp .85s ease-out forwards;
      pointer-events:none;
    }
    @keyframes floatUp{
      0%  { transform:translate(-50%,-10px); opacity:0 }
      10% { opacity:1; }
      100%{ transform:translate(-50%,-60px); opacity:0 }
    }

    /* –§–µ–π–µ—Ä–≤–µ—Ä–∫ (—Ñ–∏–Ω–∞–ª/–º–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã–π) */
    .firework{
      position:fixed; width:4px; height:4px; border-radius:50%;
      background:#fff; pointer-events:none; z-index:40; animation:fw 900ms ease-out forwards;
    }
    @keyframes fw{
      from{ transform:translate(0,0) scale(1); opacity:1 }
      to  { transform:translate(var(--tx), var(--ty)) scale(0.1); opacity:0 }
    }
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="hud">
    <div class="badge levelTitle" id="hudLevel">‚Äî</div>
    <div class="badge timer" id="hudTimer">00</div>
    <div class="badge score" id="hudScore">0</div>
  </div>

  <!-- –°—Ü–µ–Ω–∞ -->
  <div id="game" aria-live="polite"></div>

  <!-- –ó–≤—É–∫–∏ -->
  <audio id="popSound" src="pop.mp3" preload="auto"></audio>
  <audio id="winSound" src="win.mp3" preload="auto"></audio>

  <!-- MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script>
    /* ===================== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ===================== */
    const I18N = {
  ru:{
    startTitle:"–ò–≥—Ä–∞ ¬´–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã¬ª",
    startBtn:"–ù–∞—á–∞—Ç—å",
    contBtn:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
    nextBtn:"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
    restartBtn:"–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞",
    level:n=>`–£—Ä–æ–≤–µ–Ω—å ${n}`,
    levelOf:(n,t)=>`–£—Ä–æ–≤–µ–Ω—å ${n} –∏–∑ ${t}`,
    time:"–í—Ä–µ–º—è",
    score:"–°—á—ë—Ç",
    levelComplete:"–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!",
    gameComplete:"–ò–≥—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!",
    hits:"–ü–æ–ø–∞–¥–∞–Ω–∏–π",
    wrong:"–ú–∏–º–æ",
    missed:"–£—à–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö",
    total:"–ò—Ç–æ–≥–æ",
    finalFeedbackTitle:"–ú–æ–ª–æ–¥–µ—Ü!",
    defaultFinalFeedback:"–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!",
    catchAll:"–ü–æ–π–º–∞–π –≤—Å–µ"
  },
  en:{
    startTitle:"Falling Items",
    startBtn:"Start",
    contBtn:"Continue",
    nextBtn:"Next level",
    restartBtn:"Play again",
    level:n=>`Level ${n}`,
    levelOf:(n,t)=>`Level ${n} of ${t}`,
    time:"Time",
    score:"Score",
    levelComplete:"Level complete!",
    gameComplete:"Game complete!",
    hits:"Hits",
    wrong:"Wrong clicks",
    missed:"Missed correct",
    total:"Total",
    finalFeedbackTitle:"Well done!",
    defaultFinalFeedback:"Great job!",
    catchAll:"Catch all"
  },
  fr:{
    startTitle:"Objets Tombants",
    startBtn:"Commencer",
    contBtn:"Continuer",
    nextBtn:"Niveau suivant",
    restartBtn:"Rejouer",
    level:n=>`Niveau ${n}`,
    levelOf:(n,t)=>`Niveau ${n} sur ${t}`,
    time:"Temps",
    score:"Score",
    levelComplete:"Niveau termin√© !",
    gameComplete:"Jeu termin√© !",
    hits:"Touch√©s",
    wrong:"Faux clics",
    missed:"Justes rat√©s",
    total:"Total",
    finalFeedbackTitle:"Bravo !",
    defaultFinalFeedback:"Excellent travail !",
    catchAll:"Attrape tous"
  },
  es:{
    startTitle:"Elementos Cayendo",
    startBtn:"Comenzar",
    contBtn:"Continuar",
    nextBtn:"Siguiente nivel",
    restartBtn:"Jugar de nuevo",
    level:n=>`Nivel ${n}`,
    levelOf:(n,t)=>`Nivel ${n} de ${t}`,
    time:"Tiempo",
    score:"Puntuaci√≥n",
    levelComplete:"¬°Nivel completado!",
    gameComplete:"¬°Juego completado!",
    hits:"Aciertos",
    wrong:"Clics err√≥neos",
    missed:"Correctos perdidos",
    total:"Total",
    finalFeedbackTitle:"¬°Bien hecho!",
    defaultFinalFeedback:"¬°Gran trabajo!",
    catchAll:"Atrapa todos"
  },
  de:{
    startTitle:"Fallende Elemente",
    startBtn:"Start",
    contBtn:"Weiter",
    nextBtn:"N√§chste Stufe",
    restartBtn:"Nochmals spielen",
    level:n=>`Level ${n}`,
    levelOf:(n,t)=>`Level ${n} von ${t}`,
    time:"Zeit",
    score:"Punkte",
    levelComplete:"Level geschafft!",
    gameComplete:"Spiel beendet!",
    hits:"Treffer",
    wrong:"Falsche Klicks",
    missed:"Verpasste Richtige",
    total:"Gesamt",
    finalFeedbackTitle:"Gut gemacht!",
    defaultFinalFeedback:"Weiter so!",
    catchAll:"Fange alle"
  },
  zh:{
    startTitle:"‰∏ãËêΩÂÖÉÁ¥†",
    startBtn:"ÂºÄÂßã",
    contBtn:"ÁªßÁª≠",
    nextBtn:"‰∏ã‰∏ÄÂÖ≥",
    restartBtn:"ÂÜçÁé©‰∏ÄÊ¨°",
    level:n=>`Á¨¨ ${n} ÂÖ≥`,
    levelOf:(n,t)=>`Á¨¨ ${n}/${t} ÂÖ≥`,
    time:"Êó∂Èó¥",
    score:"ÂàÜÊï∞",
    levelComplete:"ÂÖ≥Âç°ÈÄöËøáÔºÅ",
    gameComplete:"Ê∏∏ÊàèÂÆåÊàêÔºÅ",
    hits:"ÂëΩ‰∏≠",
    wrong:"ËØØÁÇπ",
    missed:"ÈîôËøáÊ≠£Á°Æ",
    total:"ÊÄªÂàÜ",
    finalFeedbackTitle:"ÂÅöÂæóÂ•ΩÔºÅ",
    defaultFinalFeedback:"ÁªßÁª≠Âä™ÂäõÔºÅ",
    catchAll:"Êäì‰ΩèÊâÄÊúâ"
  },
  ja:{
    startTitle:"ËêΩ‰∏ã„Ç¢„Ç§„ÉÜ„É†",
    startBtn:"„Çπ„Çø„Éº„Éà",
    contBtn:"„Å§„Å•„Åë„Çã",
    nextBtn:"Ê¨°„ÅÆ„É¨„Éô„É´",
    restartBtn:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶",
    level:n=>`„É¨„Éô„É´ ${n}`,
    levelOf:(n,t)=>`${t} ‰∏≠ ${n} „É¨„Éô„É´`,
    time:"ÊôÇÈñì",
    score:"„Çπ„Ç≥„Ç¢",
    levelComplete:"„É¨„Éô„É´„ÇØ„É™„Ç¢ÔºÅ",
    gameComplete:"„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ",
    hits:"„Éí„ÉÉ„Éà",
    wrong:"„Éü„Çπ„ÇØ„É™„ÉÉ„ÇØ",
    missed:"Ë¶ãÈÄÉ„Åó„ÅüÊ≠£Ëß£",
    total:"ÂêàË®à",
    finalFeedbackTitle:"„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ",
    defaultFinalFeedback:"„Åù„ÅÆË™øÂ≠êÔºÅ",
    catchAll:"ÂÖ®ÈÉ®„Ç≠„É£„ÉÉ„ÉÅ"
  },
math:{
  startTitle:"–ò–≥—Ä–∞ ¬´–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã¬ª (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)",
  startBtn:"–ù–∞—á–∞—Ç—å",
  contBtn:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
  nextBtn:"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
  restartBtn:"–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞",
  level:n=>`–£—Ä–æ–≤–µ–Ω—å ${n}`,
  levelOf:(n,t)=>`–£—Ä–æ–≤–µ–Ω—å ${n} –∏–∑ ${t}`,
  time:"–í—Ä–µ–º—è",
  score:"–°—á—ë—Ç",
  levelComplete:"–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!",
  gameComplete:"–ò–≥—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!",
  hits:"–ü–æ–ø–∞–¥–∞–Ω–∏–π",
  wrong:"–ú–∏–º–æ",
  missed:"–£—à–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö",
  total:"–ò—Ç–æ–≥–æ",
  finalFeedbackTitle:"–ú–æ–ª–æ–¥–µ—Ü!",
  defaultFinalFeedback:"–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!",
  catchAll:"–ü–æ–π–º–∞–π –≤—Å–µ"
}
};
    function t(lang,key,...args){
      const dict = I18N[lang]||I18N.ru; const v = dict[key];
      return (typeof v==="function")?v(...args):(v??key);
    }

    /* ===================== –£—Ç–∏–ª–∏—Ç—ã ===================== */
    const $ = sel => document.querySelector(sel);
    const rnd = (a,b)=> a + Math.random()*(b-a);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

    function hexToRgb(hex){
      let s = (hex||'').trim();
      if(!s) return {r:255,g:215,b:0};
      if(s[0]==='#') s=s.slice(1);
      if(s.length===3) s=s.split('').map(c=>c+c).join('');
      const n=parseInt(s,16);
      return {r:(n>>16)&255, g:(n>>8)&255, b:(n)&255};
    }

    /* ===================== –ó–∞–≥—Ä—É–∑–∫–∞ cfg –ø–æ id ===================== */
    const params = new URLSearchParams(location.search);
    const GAME_ID = params.get('id');                           // —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
    const JSON_BASE = "https://nikashum93.github.io/texts/data/"; // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ

    let cfg = null;
    let LANG = 'ru'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

   (async function boot(){
  if(!GAME_ID){
    showFatal("No id", "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–ø—Ä–æ—Å–∞ (?id=...).");
    return;
  }
  try{
    const url = `${JSON_BASE}${encodeURIComponent(GAME_ID)}.json?v=${Date.now()}`;
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    cfg = await res.json();
  }catch(e){
    showFatal("Load error", `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}\n–ü—Ä–æ–≤–µ—Ä—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é –≤ texts/data.`);
    return;
  }

  LANG = (cfg.language || 'ru').toLowerCase();

  // üõ° –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ —É—Ä–æ–≤–Ω–∏
  if (!cfg.levels || !Array.isArray(cfg.levels) || cfg.levels.length === 0){
    showFatal("–ù–µ—Ç —É—Ä–æ–≤–Ω–µ–π", "–§–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ —É—Ä–æ–≤–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
    return;
  }

  // –í—Å—ë –æ–∫ ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º HUD –∏ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
  updateHUD(1, cfg.levels.length);
  showStartOverlay();
})();


      // –¶–≤–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ‚Äî –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–∞–º–∫–∞ –∑–∞–º–µ–Ω–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π, –±–µ—Ä—ë–º borderColor (–∏–ª–∏ glowColor)
const uiColor =
  (cfg.style && (cfg.style.uiColor || cfg.style.borderColor || cfg.style.glowColor))
  || '#ffd700';

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
document.documentElement.style.setProperty('--ui', uiColor);
document.documentElement.style.setProperty('--ui-soft', 'rgba('+Object.values(hexToRgb(uiColor)).join(',') + ',.14)');
document.documentElement.style.setProperty('--text-color', cfg.textColor || '#ffffff');

// –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (HUD, –º–µ–Ω—é, –∫–Ω–æ–ø–∫–∏) –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
const txtColor = (cfg.textColor || '#ffffff');
document.documentElement.style.setProperty('--text-color', txtColor);
      if (cfg.style && cfg.style.glowColor){
        document.documentElement.style.setProperty('--glow', cfg.style.glowColor);
      }

      // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫—É—Ä—Å–æ—Ä
      if (cfg.cursor) document.body.style.cursor = `url(${cfg.cursor}), auto`;
// –®—Ä–∏—Ñ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
if (cfg.font) {
  document.body.style.fontFamily = `${cfg.font}, system-ui, sans-serif`;
}
      updateHUD(1, (cfg.levels||[]).length||0);
      showStartOverlay();
    })();

    /* ===================== HUD / –û–≤–µ—Ä–ª–µ–∏ ===================== */
    const hudLevel = $('#hudLevel');
    const hudTimer = $('#hudTimer');
    const hudScore = $('#hudScore');

   function updateHUD(current, total){
  const title = cfg && cfg.levels && cfg.levels[current-1] ? (cfg.levels[current-1].target || "") : "";
  if (title) {
    if ((cfg.language||'') === 'math') {
      hudLevel.innerHTML = `${t(LANG,'level', current)}: \\(${title}\\)`;
      MathJax.typesetPromise([hudLevel]);
    } else {
      hudLevel.textContent = `${t(LANG,'level', current)}: ${title}`;
    }
  } else {
    hudLevel.textContent = `${t(LANG,'level', current)}`;
  }
}
    function showFatal(title, message){
      const ov = document.createElement('div');
      ov.className = 'overlay';
      ov.innerHTML = `
        <div class="panel">
          <h2>${title}</h2>
          <p style="white-space:pre-wrap">${message}</p>
        </div>`;
      document.body.appendChild(ov);
    }

    let overlayNode = null;

  function showStartOverlay(){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';
  const total = (cfg.levels||[]).length||0;
  const firstTarget = (cfg.levels[0] && cfg.levels[0].target) ? String(cfg.levels[0].target) : "";

  const catchAll = t(LANG,'catchAll');
  const targetLine = firstTarget
    ? ((cfg.language||'') === 'math'
        ? `<p>${catchAll}: \\(${firstTarget}\\)</p>`
        : `<p>${catchAll}: ${firstTarget}</p>`)
    : '';

  overlayNode.innerHTML = `
    <div class="panel">
      <h2>${t(LANG,'startTitle')}</h2>
      <p style="opacity:.9">${t(LANG,'levelOf', 1, total)}</p>
      ${targetLine}
      <div class="row">
        <button id="btnStart">${t(LANG,'startBtn')}</button>
      </div>
    </div>`;
  document.body.appendChild(overlayNode);

  if ((cfg.language||'') === 'math' && firstTarget){
    MathJax.typesetPromise([overlayNode]);
  }

  $('#btnStart').addEventListener('click', ()=>{
    overlayNode.remove();
    startGame();
  }, { once: true });
}

function showLevelCompleteOverlay(current, total, onNext){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';

  overlayNode.innerHTML = `
    <div class="panel">
      <h2>${t(LANG,'levelComplete')}</h2>
      <p style="opacity:.9">${t(LANG,'levelOf', current, total)}</p>
      <div style="margin:10px 0; text-align:left">
        <div>${t(LANG,'hits')}: <b>${hits}</b></div>
        <div>${t(LANG,'wrong')}: <b>${wrongClicks}</b></div>
        <div>${t(LANG,'missed')}: <b>${missedCorrect}</b></div>
        <div>${t(LANG,'total')}: <b>${score}</b></div>
      </div>
      <div class="row" style="margin-top:14px">
        <button id="btnNext">${t(LANG,'nextBtn')}</button>
      </div>
    </div>`;

  document.body.appendChild(overlayNode);

  $('#btnNext').addEventListener('click', ()=>{
    overlayNode.remove();
    onNext && onNext();
  }, { once:true });
}

    function showGameCompleteOverlay(stats){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';

  const custom = (cfg.finalFeedback || cfg.feedback || "").trim();
  const fbTitle = t(LANG,'finalFeedbackTitle');
  const fbText = custom || t(LANG,'defaultFinalFeedback');

  overlayNode.innerHTML = `
    <div class="panel">
      <h2>${t(LANG,'gameComplete')}</h2>
      <p style="margin:6px 0 6px; font-size:18px; color:var(--ui)">${fbTitle}</p>
      <p style="white-space:pre-wrap">${fbText}</p>

      <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left">
        <div>${t(LANG,'hits')}: <b>${stats.hits}</b></div>
        <div>${t(LANG,'wrong')}: <b>${stats.wrong}</b></div>
        <div>${t(LANG,'missed')}: <b>${stats.missed}</b></div>
        <div>${t(LANG,'total')}: <b>${stats.total}</b></div>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="btnRestart">${t(LANG,'restartBtn')}</button>
      </div>
    </div>`;
  document.body.appendChild(overlayNode);

  $('#btnRestart').addEventListener('click', ()=> location.reload(), { once:true });
}


    /* ===================== –ì–µ–π–º–ø–ª–µ–π ===================== */
    const game = $('#game');
    const popSound = $('#popSound');
    const winSound = $('#winSound');

    let score = 0;
    let currentLevel = 0;
    let running = false;

    let levelTimerHandle = null;
    let spawnerHandle = null;

    let hits = 0;
    let wrongClicks = 0;     // ¬´–º–∏–º–æ¬ª ‚Äî –ø–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
    let missedCorrect = 0;   // —É–ø–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —É—à—ë–ª –≤–Ω–∏–∑

    // –ö–æ–º–±–æ (streak): —Ä–∞—Å—Ç—ë—Ç –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏—è—Ö, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ ¬´–º–∏–º–æ¬ª
    let streak = 0;

    function computeSpeedParams(S){
      const s = clamp(Number(S||5), 1, 10);
      // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è: –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞ 1, –±—ã—Å—Ç—Ä–æ –Ω–∞ 10
      const vel = 0.65 + (s-1) * (6.2-0.65)/9;   // ~0.65..6.2 px/–∫–∞–¥—Ä
      // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞: 1 ‚Äî —Ä–µ–¥–∫–∏–π —Å–ø–∞–≤–Ω, 10 ‚Äî —á–∞—Å—Ç—ã–π
      const spawn = 1700 - (s-1) * (1350)/9;     // ~1700ms ‚Üí ~350ms
      // –ë–∞–∑–∞ –æ—á–∫–æ–≤: —Å–∫–æ—Ä–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´—Ü–µ–Ω—É¬ª –æ–¥–Ω–æ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è
      const basePts = 8 + (s-1) * (50-8)/9;      // ~8..50
      return { vel, spawn, basePts: Math.round(basePts) };
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ cfg
    let SPEED = { vel: 1.5, spawn: 1000, basePts: 20 };

    function startGame(){
      // –û–±–Ω–æ–≤–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ cfg.speed
      SPEED = computeSpeedParams(cfg?.speed ?? 5);

      // –†–µ—Å–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
      score = 0; hits = 0; wrongClicks = 0; missedCorrect = 0; streak = 0;
      hudScore.textContent = '0';

      // –†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Ç–∞—Å—É–µ–º –∫–æ–ø–∏—é
      if (cfg.randomLevels && Array.isArray(cfg.levels)) {
        cfg.levels = shuffleCopy(cfg.levels);
      }

      currentLevel = 0;
      running = true;
      startLevel();
    }

    function shuffleCopy(arr){
      const a = (arr||[]).slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function startLevel(){
      currentLevel++;
      const levels = Array.isArray(cfg.levels) ? cfg.levels : [];
      if(currentLevel > levels.length){
        running = false;
        fireworks();
        try{ winSound.currentTime=0; winSound.play(); }catch(_){}
        showGameCompleteOverlay({hits, wrong:wrongClicks, missed: missedCorrect, total: score});
        return;
      }

      updateHUD(currentLevel, levels.length);
      const lv = levels[currentLevel-1];

      // –¢–∞–π–º–µ—Ä —É—Ä–æ–≤–Ω—è
      let timeLeft = Math.max(5, Number(lv.timer || 30));
      hudTimer.textContent = timeLeft.toString().padStart(2,'0');
      if (levelTimerHandle) clearInterval(levelTimerHandle);
      levelTimerHandle = setInterval(()=>{
        if(!running) return;
        timeLeft--;
        hudTimer.textContent = timeLeft.toString().padStart(2,'0');
        if(timeLeft <= 0){
          clearInterval(levelTimerHandle);
          if (spawnerHandle) clearInterval(spawnerHandle);
          // –ü–æ—á–∏—Å—Ç–∏–º —Å—Ü–µ–Ω—É
          document.querySelectorAll('.item').forEach(n=>n.remove());
          // –ú–∏–Ω–∏-—Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ –∏ –ø–µ—Ä–µ—Ö–æ–¥
          fireworks(5);
          try{ winSound.currentTime=0; winSound.play(); }catch(_){}
          showLevelCompleteOverlay(currentLevel, levels.length, ()=> startLevel());
        }
      }, 1000);

      // –°–ø–∞–≤–Ω
      if (spawnerHandle) clearInterval(spawnerHandle);
      const pool = [
        ...(lv.correct||[]).map(v=>({val:v, good:true})),
        ...(lv.wrong||[]).map(v=>({val:v, good:false}))
      ];
      const delay = clamp(SPEED.spawn, 300, 2200);
      spawnerHandle = setInterval(()=>{
        if(!running) return;
        const obj = pool[Math.floor(Math.random()*pool.length)] || {val:'?', good:false};
        drop(obj);
      }, delay);
    }

    /* ===================== –≠–ª–µ–º–µ–Ω—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–∞–¥–µ–Ω–∏–µ/–∫–ª–∏–∫ ===================== */
    function drop(obj){
      const STYLE = cfg.style || {};
      const FONT = cfg.font || 'Rubik';
      const FONT_SIZE = Number(cfg.fontSize || 24);
      const TEXT_COLOR = cfg.textColor || '#ffffff';

      const el = document.createElement('div');
      el.className = `item shape-${STYLE.shape || 'rounded'} ${STYLE.shadow?'fx-shadow':''} ${STYLE.fx3d?'fx-3d':''} ${STYLE.glow?'fx-glow':''} ${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;
      el.dataset.good = obj.good ? '1' : '0';
      el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

      // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
      const bg = document.createElement('div');
      bg.className = 'bg';
      const content = document.createElement('div');
      content.className = 'content';
      el.appendChild(bg); el.appendChild(content);

      // –§–æ–Ω —Ä–∞–º–∫–∏: –ª–∏–±–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –ª–∏–±–æ —Ü–≤–µ—Ç (—Å—Ç—Ä–æ–≥–æ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ)
      const bgImg = (STYLE.bgImage||'').trim();
      const bgCol = STYLE.bgColor || 'transparent';

      if (bgImg) {
        bg.style.backgroundImage = `url(${bgImg})`;
        bg.style.backgroundColor = 'transparent';           // –Ω–µ —Å–º–µ—à–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
      } else {
        bg.style.backgroundImage = 'none';
        bg.style.backgroundColor = bgCol;                   // —á–∏—Å—Ç—ã–π —Ü–≤–µ—Ç
      }

      // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω-—Å–ª–æ—è
      bg.style.opacity = String(clamp(Number(STYLE.opacity ?? 1), 0, 1));

      // –†–∞–º–∫–∞ (–≥—Ä–∞–Ω–∏—Ü–∞) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
      if (STYLE.borderOn && STYLE.borderWidth>0){
        bg.style.borderColor = STYLE.borderColor || '#fff';
        bg.style.borderWidth = `${parseInt(STYLE.borderWidth,10)}px`;
      } else {
        bg.style.borderWidth = '0px';
      }

      // –ö–æ–Ω—Ç–µ–Ω—Ç: –∫–∞—Ä—Ç–∏–Ω–∫–∞/–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞/—Ç–µ–∫—Å—Ç
      if(/^https?:\/\//i.test(obj.val)){
        const img = document.createElement('img');
        img.src = obj.val;
        content.appendChild(img);
      } else if ((cfg.language||'') === 'math'){
        const span = document.createElement('span');
        span.textContent = `\\(${obj.val}\\)`;
        span.style.color = TEXT_COLOR;
        content.appendChild(span);
      } else {
        const span = document.createElement('span');
        span.textContent = String(obj.val);
        span.style.color = TEXT_COLOR;
        span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
        span.style.fontSize = `${FONT_SIZE}px`;
        content.appendChild(span);
      }

      // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
      const gw = game.clientWidth;
      const startX = Math.max(16, Math.min(gw-220, rnd(0, gw-220)));
      el.style.left = startX + 'px';
      el.style.top = '-160px';

      game.appendChild(el);

      // –ü–æ–¥–≥–æ–Ω—è–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç + –≤–æ–∑–¥—É—Ö
      fitGeometryBox(el);

      // –ê–≤—Ç–æ—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞
      autoFitText(el, FONT_SIZE, 12);

      // –ï—Å–ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º ‚Äî –ø–µ—Ä–µ—Ç–∞–π–ø—Å–µ—Ç–∏—Ç—å –∏ –µ—â—ë —Ä–∞–∑ –ø–æ–¥—Ä–æ–≤–Ω—è—Ç—å
      if ((cfg.language||'') === 'math'){
        MathJax.typesetPromise([el]).then(()=> fitGeometryBox(el));
      }

      // –ü–∞–¥–µ–Ω–∏–µ
      const vel = SPEED.vel;
      const swayAmp = rnd(6, 22);
      const swayFreq = rnd(0.003, 0.008);
      let y = -160;
      let t = 0;
      let alive = true;

      function step(){
        if(!alive) return;
        y += vel; t += 1;
        const dx = Math.sin(t*swayFreq) * swayAmp;
        el.style.top = y+'px';
        el.style.transform = `translateX(${dx}px)`;
        if(y > game.clientHeight + 200){
          alive = false;
          if (el.dataset.good === '1') {
            missedCorrect++;
          }
          el.remove();
          return;
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);

      // –ö–ª–∏–∫
      el.addEventListener('click', ()=>{
        if(!alive) return;

        if(el.dataset.good === '1'){
          // –û—á–∫–∏
          streak++;
          const comboMult = 1 + (streak-1)*0.25;             // —Ä–∞—Å—Ç—É—â–µ–µ –∫–æ–º–±–æ –±–µ–∑ –ø–æ—Ç–æ–ª–∫–∞
          const pts = Math.round(SPEED.basePts * comboMult);  // —Å–∫–æ—Ä–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ –±–∞–∑—É
          score += pts; hits++;
          hudScore.textContent = String(score);

          popScore(el, `+${pts}`);
          playPop(el);
          alive = false;
          el.classList.add('caught');
          setTimeout(()=> el.remove(), 380);
        } else {
          // –ú–∏–º–æ: –Ω–µ –≤—ã—á–∏—Ç–∞–µ–º –æ—á–∫–∏, –Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ—Ä–∏—é –∏ –¥–∞—ë–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
          wrongClicks++;
          streak = 0;
          bg.style.filter = 'brightness(2) saturate(1.6) hue-rotate(-30deg)';
          setTimeout(()=> bg.style.filter = 'none', 220);
        }
      });
    }

    /* ===================== –ì–µ–æ–º–µ—Ç—Ä–∏—è/–∞–≤—Ç–æ—Ñ–∏—Ç ===================== */
    function fitGeometryBox(el){
      const STYLE = cfg.style || {};
      const shape = STYLE.shape || 'rounded';
      const content = el.querySelector('.content');

      // –°–±—Ä–æ—Å–∏–º, —á—Ç–æ–±—ã –∏–∑–º–µ—Ä–∏—Ç—å ¬´–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π¬ª —Ä–∞–∑–º–µ—Ä
      el.style.width = ''; el.style.height='';

      const r = content.getBoundingClientRect();

      // –í–æ–∑–¥—É—Ö –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∫–∞
      const hasImageFrame = Boolean((STYLE.bgImage||'').trim());
      const padX = hasImageFrame ? 30 : 22;
      const padY = hasImageFrame ? 24 : 18;

      let W = Math.ceil(r.width + padX*2);
      let H = Math.ceil(r.height + padY*2);

      // –ö—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞ ‚Äî –¥–µ–ª–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –±–æ–∫—Å, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –±—ã–ª–∞ ¬´–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è¬ª, –Ω–µ –ø—Ä–∏–ø–ª—é—Å–Ω—É—Ç–∞—è
      if (shape === 'circle' || shape === 'diamond' || shape === 'star'){
        const S = Math.max(W, H);
        W = H = Math.ceil(S + 16); // —á—É—Ç—å –≤–æ–∑–¥—É—Ö–∞ —Å–≤–µ—Ä—Ö—É
      }

      el.style.width = W + 'px';
      el.style.height = H + 'px';
    }

    function autoFitText(el, startPx, minPx){
      const span = el.querySelector('.content span');
      if(!span) return;
      let fs = startPx;
      const pad = 18;
      const maxW = el.clientWidth - pad*2;
      const maxH = el.clientHeight - pad*2;

      const fits = ()=> {
        const rr = span.getBoundingClientRect();
        return (rr.width <= maxW && rr.height <= maxH);
      };

      while (fs > minPx){
        span.style.fontSize = fs + 'px';
        if (fits()) break;
        fs -= 1;
      }
    }

    /* ===================== –≠—Ñ—Ñ–µ–∫—Ç—ã / –æ—á–∫–∏ / —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ ===================== */
    function playPop(el){
      try{ popSound.currentTime = 0; popSound.play(); }catch(_){}
      const r = el.getBoundingClientRect();
      for(let i=0;i<14;i++){
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = (r.left + r.width/2) + 'px';
        s.style.top  = (r.top  + r.height/2) + 'px';
        const angle = Math.random() * Math.PI * 2;
        const dist = 40 + Math.random()*70;
        s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
        s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
        s.style.animationDuration = (0.9 / (SPEED.basePts/12)) + 's';
        document.body.appendChild(s);
        setTimeout(()=> s.remove(), 1000);
      }
    }

    function popScore(el, text){
      const r = el.getBoundingClientRect();
      const node = document.createElement('div');
      node.className = 'score-float';
      node.style.left = (r.left + r.width/2) + 'px';
      node.style.top  = (r.top + 8) + 'px';
      node.style.color = 'var(--ui)';
      node.textContent = text;
      document.body.appendChild(node);
      setTimeout(()=> node.remove(), 900);
    }

    function fireworks(count=16){
      const W = window.innerWidth, H = window.innerHeight;
      for(let k=0;k<count;k++){
        const x = Math.random()*W*0.8 + W*0.1;
        const y = Math.random()*H*0.5 + H*0.1;
        const parts = 24;
        for(let i=0;i<parts;i++){
          const p = document.createElement('div');
          p.className='firework';
          p.style.left = x+'px'; p.style.top = y+'px';
          const angle = (Math.PI*2) * (i/parts) + Math.random()*0.2;
          const dist = 60 + Math.random()*120;
          p.style.setProperty('--tx', (Math.cos(angle)*dist)+'px');
          p.style.setProperty('--ty', (Math.sin(angle)*dist)+'px');
          p.style.background = `hsl(${Math.floor(Math.random()*360)},90%,70%)`;
          document.body.appendChild(p);
          setTimeout(()=> p.remove(), 900);
        }
      }
    }
  </script>
</body>
</html>
