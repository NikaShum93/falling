<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falling Items ‚Äî Game</title>
<style>
  :root{
    --glow:#00f0ff;
  }
  html,body{height:100%}
  body{
    margin:0;
    background:#0d0d0d;
    color:#fff;
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  #game{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
  }

  /* HUD */
  .hud{
    position:fixed; left:12px; top:12px; right:12px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    font-weight:700; z-index:10; pointer-events:none;
  }
  .badge{
    pointer-events:none;
    background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:10px 14px;
    box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 18px rgba(255,215,0,.08) inset;
  }
  .levelTitle{color:#ffd700}
  .timer{min-width:110px; text-align:center}
  .score{min-width:110px; text-align:center}

  /* –ø–∞–¥–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç = –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .item{
    position:absolute;
    top:-140px;
    left:0;
    transform:translateZ(0);
    will-change:transform, top, left;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:120px;
    min-height:80px;
    padding:0; /* padding –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ .content, —á—Ç–æ–±—ã —Ñ–æ–Ω –Ω–µ ¬´–µ–ª–∏¬ª –∫–ª–∏–ø—ã */
    user-select:none;
    cursor:pointer;
  }
  /* —Ñ–æ–Ω-—Å–ª–æ–π (–∫–ª–∏–ø–∞–µ—Ç—Å—è, –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å) */
  .item .bg{
    position:absolute; inset:0;
    background:#222;
    opacity:1;
    border:0 solid #fff; /* –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–∑ JS */
    box-shadow:none;     /* —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ JS */
    transition:filter .15s ease;
  }
  /* —Å–ª–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–≤–µ—Ä—Ö (–Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è) */
  .item .content{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    padding:20px 26px; /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
    max-width:320px;   /* –∑–∞—â–∏—Ç–Ω—ã–π –º–∞–∫—Å–∏–º—É–º –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
    max-height:220px;
    text-align:center;
    line-height:1.15;
  }
  .item .content span{
    display:inline-block;
    font-weight:800;
    white-space:nowrap;
  }
  .item .content img{
    display:block;
    max-width:180px;
    max-height:140px;
    object-fit:contain;
    pointer-events:none;
  }

  /* –§–ò–ì–£–†–´ ‚Äî clip-path —Ç–æ–ª—å–∫–æ –∫ bg, –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–æ–≤–Ω—ã–º */
  .shape-rect .bg{ border-radius:10px }
  .shape-rounded .bg{ border-radius:20px }
  .shape-circle .bg{ border-radius:50% }
  .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
  .shape-star .bg{ clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%) }

  /* –≠–§–§–ï–ö–¢–´ (–ø—Ä–∏–º–µ–Ω—è–µ–º –∫ bg) */
  .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
  .fx-3d .bg{ box-shadow:
      7px 7px 20px rgba(0,0,0,.5),
      inset -5px -5px 12px rgba(255,255,255,.22) }
  .fx-glow .bg{ box-shadow:0 0 18px var(--glow, #00f0ff) }
  .fx-border .bg{ border-style:solid }

  /* –∫–ª–∏–∫-–ø–æ–ø */
  .caught{ animation:pop .45s ease forwards }
  @keyframes pop{
    0%{ transform:scale(1); opacity:1 }
    50%{ transform:scale(1.15); opacity:1 }
    100%{ transform:scale(0.85); opacity:0 }
  }

  /* –±–ª—ë—Å—Ç–∫–∏ */
  .sparkle{
    position:absolute;
    width:6px; height:6px; border-radius:50%;
    background:rgba(255,255,255,.9);
    pointer-events:none;
    animation:spark 0.9s forwards;
    filter:drop-shadow(0 0 6px #fff);
    z-index:5;
  }
  @keyframes spark{
    from{ opacity:1; transform:translate(0,0) scale(1) }
    to{ opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
  }

  /* —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω */
  .overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.9));
    color:#fff; z-index:20; gap:18px;
  }
  .overlay .panel{
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:20px 26px;
    text-align:center;
    box-shadow:0 0 26px rgba(255,215,0,.1);
  }
  .overlay button{
    background:linear-gradient(90deg,#ffbf00,#ffd700);
    color:#000; border:0; border-radius:10px; font-weight:900; padding:12px 16px; cursor:pointer;
  }
</style>
</head>
<body>

<div class="hud">
  <div class="badge levelTitle" id="hudLevel">–£—Ä–æ–≤–µ–Ω—å</div>
  <div class="badge timer" id="hudTimer">00</div>
  <div class="badge score" id="hudScore">0</div>
</div>

<div id="game"></div>

<audio id="popSound" src="pop.mp3" preload="auto"></audio>

<!-- MathJax –¥–ª—è –º–∞—Ç. —Ñ–æ—Ä–º—É–ª -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
(async function(){

  // ===== utils =====
  const $ = sel => document.querySelector(sel);
  const rnd = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  // ===== –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ =====
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id){ alert('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id'); return; }

  const jsonUrl = `https://nikashum93.github.io/texts/data/${id}.json`;
  let cfg;
  try{
    const res = await fetch(jsonUrl, { cache:'no-store' });
    cfg = await res.json();
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message);
    return;
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const SPEED = clamp(Number(cfg.speed ?? 5), 1, 10); // 1‚Äì10
  const FONT = cfg.font || 'Rubik';
  const FONT_SIZE = Number(cfg.fontSize || 24);
  const TEXT_COLOR = cfg.textColor || '#ffffff';
  const STYLE = cfg.style || {};
  const CURSOR = cfg.cursor || '';

  // –ü–æ–¥–≥—Ä—É–∑–∏–º —à—Ä–∏—Ñ—Ç
  const gf = document.createElement('link');
  gf.rel = 'stylesheet';
  gf.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(FONT).replace(/%20/g,'+')}%3Awght@400;700&display=swap`;
  document.head.appendChild(gf);

  // –ö—É—Ä—Å–æ—Ä
  if(CURSOR) document.body.style.cursor = `url(${CURSOR}), auto`;

  // –†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π
  const levels = Array.isArray(cfg.levels) ? [...cfg.levels] : [];
  if(cfg.randomLevels){
    for(let i=levels.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [levels[i], levels[j]] = [levels[j], levels[i]];
    }
  }

  const game = $('#game');
  const popSound = $('#popSound');
  const hudLevel = $('#hudLevel');
  const hudTimer = $('#hudTimer');
  const hudScore = $('#hudScore');

  let score = 0;
  let current = 0;
  let levelTimerHandle = null;
  let spawnerHandle = null;
  let running = true;

  startLevel();

  // ===== —Å—Ç–∞—Ä—Ç —É—Ä–æ–≤–Ω—è =====
  function startLevel(){
    if(current >= levels.length){ showFinish(); return; }
    const lv = levels[current];
    hudLevel.textContent = `–£—Ä–æ–≤–µ–Ω—å ${current+1}: ${lv.target || ''}`;

    // —Ç–∞–π–º–µ—Ä —É—Ä–æ–≤–Ω—è
    let timeLeft = Math.max(5, Number(lv.timer || 30));
    hudTimer.textContent = timeLeft.toString().padStart(2,'0');
    if(levelTimerHandle) clearInterval(levelTimerHandle);
    levelTimerHandle = setInterval(()=>{
      if(!running) return;
      timeLeft--;
      hudTimer.textContent = timeLeft.toString().padStart(2,'0');
      if(timeLeft <= 0){
        clearInterval(levelTimerHandle);
        clearInterval(spawnerHandle);
        // –ù–µ–º–Ω–æ–≥–æ –æ—á–∏—Å—Ç–∏–º —Å—Ü–µ–Ω—É
        document.querySelectorAll('.item').forEach(n=>n.remove());
        current++;
        startLevel();
      }
    }, 1000);

    // —Å–ø–∞–≤–Ω
    if(spawnerHandle) clearInterval(spawnerHandle);
    const pool = [
      ...(lv.correct||[]).map(v=>({val:v, good:true})),
      ...(lv.wrong||[]).map(v=>({val:v, good:false}))
    ];
    const baseDelay = 1200; // –±–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞
    const delay = clamp(baseDelay / (SPEED/5), 280, 3000); // –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º SPEED
    spawnerHandle = setInterval(()=>{
      if(!running) return;
      const obj = pool[Math.floor(Math.random()*pool.length)];
      drop(obj);
    }, delay);
  }

  // ===== —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–∞–¥–µ–Ω–∏–µ =====
  function drop(obj){
    const el = document.createElement('div');
    el.className = `item shape-${STYLE.shape || 'rounded'} ${STYLE.shadow?'fx-shadow':''} ${STYLE.fx3d?'fx-3d':''} ${STYLE.glow?'fx-glow':''} ${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;
    el.dataset.good = obj.good ? '1' : '0';
    el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

    // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    const bg = document.createElement('div');
    bg.className = 'bg';
    const content = document.createElement('div');
    content.className = 'content';
    el.appendChild(bg); el.appendChild(content);

    // —Ñ–æ–Ω-—Å–ª–æ–π
    const bgImg = (STYLE.bgImage||'').trim();
    const bgCol = STYLE.bgColor || 'transparent';
    bg.style.background = bgImg ? `url(${bgImg}) center/contain no-repeat, ${bgCol}` : bgCol;
    bg.style.opacity = clamp(Number(STYLE.opacity ?? 1), 0, 1);
    if(STYLE.borderOn && STYLE.borderWidth>0){
      bg.style.borderColor = STYLE.borderColor || '#fff';
      bg.style.borderWidth = `${parseInt(STYLE.borderWidth,10)}px`;
    } else {
      bg.style.borderWidth = '0px';
    }

    // –∫–æ–Ω—Ç–µ–Ω—Ç
    if(/^https?:\/\//i.test(obj.val)){
      const img = document.createElement('img');
      img.src = obj.val;
      content.appendChild(img);
    } else if((cfg.language||'') === 'math'){
      // MathJax
      const span = document.createElement('span');
      span.textContent = `\\(${obj.val}\\)`;
      content.appendChild(span);
      // –æ—Ç—Ä–∏—Å—É–µ–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
    } else {
      const span = document.createElement('span');
      span.textContent = String(obj.val);
      span.style.color = TEXT_COLOR;
      span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
      span.style.fontSize = `${FONT_SIZE}px`;
      content.appendChild(span);
    }

    // –ü–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä—Ç–∞
    const gw = game.clientWidth;
    const startX = Math.max(16, Math.min(gw-180, rnd(0, gw-180)));
    el.style.left = startX + 'px';
    el.style.top = '-160px';

    // –ö—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ¬´–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏¬ª ‚Äî –ø–æ–¥—Ä–∞–≤–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç
    game.appendChild(el);
    fitGeometryBox(el);

    // –ê–≤—Ç–æ-—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞ (—É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –≤–ª–∞–∑–∏—Ç)
    autoFitText(el, FONT_SIZE, 12);

    // MathJax typeset, –µ—Å–ª–∏ –Ω–∞–¥–æ
    if((cfg.language||'') === 'math') {
      MathJax.typesetPromise([el]).then(()=> {
        fitGeometryBox(el);
      });
    }

    // –ø–∞–¥–µ–Ω–∏–µ
    const vel = 1.2 + SPEED * 0.9;       // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
    const swayAmp = rnd(8, 22);          // –Ω–µ–±–æ–ª—å—à–æ–µ –∫–∞—á–∞–Ω–∏–µ
    const swayFreq = rnd(0.003, 0.008);  // —á–∞—Å—Ç–æ—Ç–∞
    let y = -140;
    let t = 0;
    let alive = true;

    function step(){
      if(!alive) return;
      y += vel; t += 1;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if(y > game.clientHeight + 200){
        alive = false; el.remove();
        return;
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    // –∫–ª–∏–∫
    el.addEventListener('click', ()=>{
      if(!alive) return;
      if(el.dataset.good === '1'){
        score++; hudScore.textContent = score;
        playPop(el);
        alive = false;
        el.classList.add('caught');
        setTimeout(()=> el.remove(), 400);
      } else {
        // ¬´—à—Ç—Ä–∞—Ñ¬ª: –≤—Å–ø—ã—à–∫–∞
        bg.style.filter = 'brightness(2) saturate(1.6)';
        setTimeout(()=> bg.style.filter = 'none', 220);
      }
    });
  }

  // ===== –≥–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä (–∫–≤–∞–¥—Ä–∞—Ç –¥–ª—è –∫—Ä—É–≥–∞/—Ä–æ–º–±–∞/–∑–≤–µ–∑–¥—ã) =====
  function fitGeometryBox(el){
    const shape = STYLE.shape || 'rounded';
    const content = el.querySelector('.content');
    const rect = content.getBoundingClientRect();
    const padX = 0, padY = 0;

    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    el.style.width = (rect.width + padX) + 'px';
    el.style.height = (rect.height + padY) + 'px';

    if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
      const size = Math.max(rect.width, rect.height) + 30; // –Ω–µ–º–Ω–æ–≥–æ –≤–æ–∑–¥—É—Ö–∞
      el.style.width = size + 'px';
      el.style.height = size + 'px';
    }
  }

  // ===== –∞–≤—Ç–æ-—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏–ª—Å—è =====
  function autoFitText(el, startPx, minPx){
    const span = el.querySelector('.content span');
    if(!span) return;
    let fs = startPx;
    const maxW = el.clientWidth - 24;
    const maxH = el.clientHeight - 24;

    const measure = ()=>{
      const r = span.getBoundingClientRect();
      return (r.width <= maxW && r.height <= maxH);
    };
    // –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ‚Äî —É–º–µ–Ω—å—à–∞–µ–º
    while(fs > minPx){
      span.style.fontSize = fs + 'px';
      if(measure()) break;
      fs -= 1;
    }
  }

  // ===== —ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ =====
  function playPop(el){
    try{ popSound.currentTime = 0; popSound.play(); }catch(_){}
    const r = el.getBoundingClientRect();
    for(let i=0;i<14;i++){
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.left = (r.left + r.width/2) + 'px';
      s.style.top  = (r.top  + r.height/2) + 'px';
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*70;
      s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
      s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
      s.style.animationDuration = (0.9 / (SPEED/5)) + 's';
      document.body.appendChild(s);
      setTimeout(()=> s.remove(), 1000);
    }
  }

  // ===== —Ñ–∏–Ω–∞–ª =====
  function showFinish(){
    const ov = document.createElement('div');
    ov.className = 'overlay';
    ov.innerHTML = `
      <div class="panel">
        <div style="font-size:22px; color:#ffd700; font-weight:900; margin-bottom:8px">–§–∏–Ω–∏—à! üéâ</div>
        <div style="opacity:.9; margin-bottom:10px">–°—á—ë—Ç: <b>${score}</b></div>
        <button id="btnAgain">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
      </div>
    `;
    document.body.appendChild(ov);
    $('#btnAgain').onclick = ()=> location.reload();
  }

})();
</script>
</body>
</html>
