<!-- =======================================================================
=  main.html ‚Äî –ò–ì–†–ê FALLING ITEMS (–ö–ì–ë). –ü–û–õ–ù–´–ô –§–ê–ô–õ.                     =
=  –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –∏–∑: https://nikashum93.github.io/texts/data/<id>.json  =
=  –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω, —Å—Ç–∞—Ä—Ç-–æ–≤–µ—Ä–ª–µ–π –ø–æ —Ü–µ–Ω—Ç—Ä—É, UI-—Ü–≤–µ—Ç –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫.           =
======================================================================= -->
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Falling Items ‚Äî Game</title>
<style>
  :root{
    --ui:#ffd700;
    --glow:#00f0ff;
    --hudGlass: rgba(0,0,0,.45);
    --hudBorder: rgba(255,255,255,.12);
    --hudShadow: rgba(0,0,0,.35);
  }
  html,body{height:100%}
  body{
    margin:0;
    background:transparent;           /* ‚Üê —Å—Ü–µ–Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è */
    color:#fff;
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  #game{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
  }

  /* HUD */
  .hud{
    position:fixed; left:12px; top:12px; right:12px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    font-weight:700; z-index:10; pointer-events:none;
  }
  .badge{
    pointer-events:none;
    background:var(--hudGlass);
    border:1px solid var(--hudBorder);
    border-radius:12px;
    padding:10px 14px;
    box-shadow:0 8px 24px var(--hudShadow), 0 0 18px rgba(255,215,0,.08) inset;
  }
  .levelTitle{color:var(--ui)}
  .timer{min-width:110px; text-align:center}
  .score{min-width:110px; text-align:center}

  /* –ø–∞–¥–∞—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç = –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .item{
    position:absolute;
    top:-140px;
    left:0;
    transform:translateZ(0);
    will-change:transform, top, left;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:80px;
    min-height:60px;
    padding:0; /* padding –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ .content */
    user-select:none;
    cursor:pointer;
  }
  /* —Ñ–æ–Ω-—Å–ª–æ–π (–∫–ª–∏–ø–∞–µ—Ç—Å—è, –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å; –ù–ï–¢ —á—ë—Ä–Ω–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞) */
  .item .bg{
    position:absolute; inset:0;
    background:transparent;            /* ‚Üê —á–∏—Å—Ç–æ; —Ü–≤–µ—Ç/–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞—ë–º –∏–∑ JS */
    opacity:1;
    border:0 solid transparent;        /* –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–∑ JS */
    box-shadow:none;                   /* —ç—Ñ—Ñ–µ–∫—Ç—ã –∏–∑ JS */
    transition:filter .15s ease;
  }
  /* —Å–ª–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ–≤–µ—Ä—Ö (–Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è) */
  .item .content{
    position:relative; z-index:1;
    display:flex; align-items:center; justify-content:center;
    padding:20px 26px; /* –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ pad */
    max-width:420px;   /* —Ä–∞–∑—É–º–Ω—ã–π –º–∞–∫—Å–∏–º—É–º */
    max-height:280px;
    text-align:center;
    line-height:1.15;
  }
  .item .content span{
    display:inline-block;
    font-weight:800;
    white-space:nowrap;
  }
  .item .content img{
    display:block;
    max-width:220px;
    max-height:170px;
    object-fit:contain;
    pointer-events:none;
  }

  /* –§–ò–ì–£–†–´ ‚Äî clip-path —Ç–æ–ª—å–∫–æ –∫ bg, –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–æ–≤–Ω—ã–º */
  .shape-rect .bg{ border-radius:10px }
  .shape-rounded .bg{ border-radius:20px }
  .shape-circle .bg{ border-radius:50% }
  .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
  .shape-star .bg{ clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%) }

  /* –≠–§–§–ï–ö–¢–´ (–ø—Ä–∏–º–µ–Ω—è–µ–º –∫ bg) */
  .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.5) }
  .fx-3d .bg{ box-shadow:
      7px 7px 20px rgba(0,0,0,.5),
      inset -5px -5px 12px rgba(255,255,255,.22) }
  .fx-glow .bg{ box-shadow:0 0 18px var(--glow, #00f0ff) }
  .fx-border .bg{ border-style:solid }

  /* –∫–ª–∏–∫-–ø–æ–ø */
  .caught{ animation:pop .45s ease forwards }
  @keyframes pop{
    0%{ transform:scale(1); opacity:1 }
    50%{ transform:scale(1.15); opacity:1 }
    100%{ transform:scale(0.85); opacity:0 }
  }

  /* –±–ª—ë—Å—Ç–∫–∏ */
  .sparkle{
    position:absolute;
    width:6px; height:6px; border-radius:50%;
    background:rgba(255,255,255,.9);
    pointer-events:none;
    animation:spark 0.9s forwards;
    filter:drop-shadow(0 0 6px #fff);
    z-index:5;
  }
  @keyframes spark{
    from{ opacity:1; transform:translate(0,0) scale(1) }
    to{ opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
  }

  /* —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
  .startOverlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:30;
    background: rgba(0,0,0,.0); /* –ø—Ä–æ–∑—Ä–∞—á–Ω–æ, —Ç.–∫. –∏–≥—Ä–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —á—É–∂–æ–≥–æ —Ñ–æ–Ω–∞ */
  }
  .startPanel{
    background: rgba(0,0,0,.55);
    border:1px solid var(--hudBorder);
    border-radius:16px;
    padding:22px 26px;
    text-align:center;
    box-shadow:0 0 26px rgba(255,215,0,.1);
    color:#fff;
    display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center;
    min-width:280px;
  }
  .startTitle{ font-size:22px; color:var(--ui); font-weight:900 }
  .startBtn{
    background:linear-gradient(90deg,#ffbf00,#ffd700);
    color:#000; border:0; border-radius:10px; font-weight:900; padding:12px 16px; cursor:pointer;
    margin-top:6px;
  }
</style>
</head>
<body>

<div class="hud" aria-hidden="true">
  <div class="badge levelTitle" id="hudLevel">–£—Ä–æ–≤–µ–Ω—å</div>
  <div class="badge timer" id="hudTimer">00</div>
  <div class="badge score" id="hudScore">0</div>
</div>

<div id="game" aria-live="polite" aria-atomic="true"></div>

<audio id="popSound" src="pop.mp3" preload="auto"></audio>

<!-- MathJax –¥–ª—è –º–∞—Ç. —Ñ–æ—Ä–º—É–ª -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<script>
(async function(){

  // ===== utils =====
  const $ = sel => document.querySelector(sel);
  const rnd = (a,b)=> a + Math.random()*(b-a);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

  // ===== –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ =====
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id){ alert('–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id'); return; }

  const jsonUrl = `https://nikashum93.github.io/texts/data/${encodeURIComponent(id)}.json?v=${Date.now()}`;
  let cfg;
  try{
    const res = await fetch(jsonUrl, { cache:'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    cfg = await res.json();
  }catch(e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message + '\n–ü–æ–¥–æ–∂–¥–∏—Ç–µ 30‚Äì60 —Å–µ–∫, GitHub Pages –º–æ–≥ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞—Ç—å.');
    return;
  }

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const SPEED = clamp(Number(cfg.speed ?? 5), 1, 10); // 1‚Äì10
  const FONT = cfg.font || 'Rubik';
  const FONT_SIZE = Number(cfg.fontSize || 24);
  const TEXT_COLOR = cfg.textColor || '#ffffff';
  const STYLE = cfg.style || {};
  const CURSOR = cfg.cursor || '';
  const LANG = (cfg.language || 'ru');

  // –ü–æ–¥–≥—Ä—É–∑–∏–º —à—Ä–∏—Ñ—Ç
  const gf = document.createElement('link');
  gf.rel = 'stylesheet';
  gf.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(FONT).replace(/%20/g,'+')}%3Awght@400;700&display=swap`;
  document.head.appendChild(gf);

  // –ö—É—Ä—Å–æ—Ä
  if(CURSOR) document.body.style.cursor = `url(${CURSOR}), auto`;

  // –¶–≤–µ—Ç UI
  const uiColor = (STYLE.uiColor || STYLE.borderColor || STYLE.glowColor || '#ffd700');
  document.documentElement.style.setProperty('--ui', uiColor);
  document.documentElement.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  const game = $('#game');
  const popSound = $('#popSound');
  const hudLevel = $('#hudLevel');
  const hudTimer = $('#hudTimer');
  const hudScore = $('#hudScore');

  let score = 0;
  let current = 0;
  let levelTimerHandle = null;
  let spawnerHandle = null;
  let running = false;

  // –†–∞–Ω–¥–æ–º —É—Ä–æ–≤–Ω–µ–π (–æ—Å—Ç–∞–≤–∏–ª –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ ‚Äî –Ω–æ —Ç—É—Ç —É–≤–∞–∂–∞–µ–º —Ñ–ª–∞–≥)
  const levels = Array.isArray(cfg.levels) ? [...cfg.levels] : [];
  if(cfg.randomLevels){
    for(let i=levels.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [levels[i], levels[j]] = [levels[j], levels[i]];
    }
  }

  // –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
  makeStartOverlay();

  function makeStartOverlay(){
    const ov = document.createElement('div');
    ov.className = 'startOverlay';
    ov.innerHTML = `
      <div class="startPanel" role="dialog" aria-modal="true">
        <div class="startTitle">${i18n('–°—Ç–∞—Ä—Ç –∏–≥—Ä—ã', 'Start game', '„Ç≤„Éº„É†ÈñãÂßã')}</div>
        <div style="opacity:.95">${i18n('–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å', 'Tap to start', '„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñãÂßã')}</div>
        <button class="startBtn" id="btnStart">${i18n('–ù–∞—á–∞—Ç—å', 'Start', 'ÈñãÂßã')}</button>
      </div>
    `;
    document.body.appendChild(ov);
    $('#btnStart').addEventListener('click', async ()=>{
      try{ await unlockAudio(); }catch(_){}
      ov.remove();
      startLevel();
    }, { once:true });
  }

  async function unlockAudio(){
    try{
      popSound.currentTime = 0;
      await popSound.play().catch(()=>{});
      popSound.pause();
      popSound.currentTime = 0;
    }catch(_){}
  }

  function i18n(ru,en,ja){
    switch(LANG){
      case 'en': return en;
      case 'ja': return ja;
      default: return ru;
    }
  }

  // ===== —Å—Ç–∞—Ä—Ç —É—Ä–æ–≤–Ω—è =====
  function startLevel(){
    running = true;

    if(current >= levels.length){ showFinish(); return; }
    const lv = levels[current];
    hudLevel.textContent = `${i18n('–£—Ä–æ–≤–µ–Ω—å','Level','„É¨„Éô„É´')} ${current+1}: ${lv.target || ''}`;

    // —Ç–∞–π–º–µ—Ä —É—Ä–æ–≤–Ω—è
    let timeLeft = Math.max(5, Number(lv.timer || 30));
    hudTimer.textContent = timeLeft.toString().padStart(2,'0');
    if(levelTimerHandle) clearInterval(levelTimerHandle);
    levelTimerHandle = setInterval(()=>{
      if(!running) return;
      timeLeft--;
      hudTimer.textContent = timeLeft.toString().padStart(2,'0');
      if(timeLeft <= 0){
        clearInterval(levelTimerHandle);
        clearInterval(spawnerHandle);
        document.querySelectorAll('.item').forEach(n=>n.remove());
        current++;
        startLevel();
      }
    }, 1000);

    // —Å–ø–∞–≤–Ω
    if(spawnerHandle) clearInterval(spawnerHandle);
    const pool = [
      ...(lv.correct||[]).map(v=>({val:v, good:true})),
      ...(lv.wrong||[]).map(v=>({val:v, good:false}))
    ];
    const baseDelay = 1200; // –±–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞
    const delay = clamp(baseDelay / (SPEED/5), 280, 3000); // –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º SPEED
    spawnerHandle = setInterval(()=>{
      if(!running) return;
      const obj = pool[Math.floor(Math.random()*pool.length)];
      drop(obj);
    }, delay);
  }

  // ===== —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–∞–¥–µ–Ω–∏–µ =====
  function drop(obj){
    const el = document.createElement('div');
    el.className =
      `item shape-${STYLE.shape || 'rounded'} ` +
      `${STYLE.shadow?'fx-shadow':''} ` +
      `${STYLE.fx3d?'fx-3d':''} ` +
      `${STYLE.glow?'fx-glow':''} ` +
      `${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;
    el.dataset.good = obj.good ? '1' : '0';
    el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

    // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    const bg = document.createElement('div');
    bg.className = 'bg';
    const content = document.createElement('div');
    content.className = 'content';
    content.style.padding = clamp(Number(STYLE.pad ?? 22), 0, 120) + 'px';
    el.appendChild(bg); el.appendChild(content);

    // —Ñ–æ–Ω-—Å–ª–æ–π (–≤–∞–∂–Ω–æ: –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –Ω–µ —Ä–∏—Å—É–µ–º —Ü–≤–µ—Ç)
    const bgImg = (STYLE.bgImage||'').trim();
    const bgCol = (STYLE.bgColor || 'transparent');
    if(bgImg){
      bg.style.background = `url(${bgImg}) center/contain no-repeat`; // –¢–û–õ–¨–ö–û –∫–∞—Ä—Ç–∏–Ω–∫–∞
    }else{
      bg.style.background = bgCol; // –¢–û–õ–¨–ö–û —Ü–≤–µ—Ç
    }
    bg.style.opacity = clamp(Number(STYLE.opacity ?? 1), 0, 1);
    if(STYLE.borderOn && STYLE.borderWidth>0){
      bg.style.borderColor = STYLE.borderColor || uiColor;
      bg.style.borderWidth = `${parseInt(STYLE.borderWidth,10)}px`;
    } else {
      bg.style.borderWidth = '0px';
      bg.style.borderColor = 'transparent';
    }

    // –∫–æ–Ω—Ç–µ–Ω—Ç
    if(/^https?:\/\//i.test(obj.val)){
      const img = document.createElement('img');
      img.src = obj.val;
      content.appendChild(img);
    } else if((cfg.language||'') === 'math'){
      // MathJax
      const span = document.createElement('span');
      span.textContent = `\\(${obj.val}\\)`;
      content.appendChild(span);
      // –æ—Ç—Ä–∏—Å—É–µ–º –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
    } else {
      const span = document.createElement('span');
      span.textContent = String(obj.val);
      span.style.color = TEXT_COLOR;
      span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
      span.style.fontSize = `${FONT_SIZE}px`;
      content.appendChild(span);
    }

    // –ü–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä—Ç–∞
    const gw = game.clientWidth;
    const startX = Math.max(16, Math.min(gw-180, rnd(0, gw-180)));
    el.style.left = startX + 'px';
    el.style.top = '-160px';

    // –ù–∞ —Å—Ü–µ–Ω—É, –ø–æ—Ç–æ–º –≥–µ–æ–º.–ø–æ–¥–≥–æ–Ω–∫–∞
    game.appendChild(el);

    // –ê–≤—Ç–æ-—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞/–∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
    // (—Å–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–≤–∏–º —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É)
    fitGeometryBox(el, /*squareFor=*/STYLE.shape);

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞ (—É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –≤–ª–∞–∑–∏—Ç)
    autoFitText(el, FONT_SIZE, 12, STYLE.shape);

    // MathJax typeset, –µ—Å–ª–∏ –Ω–∞–¥–æ
    if((cfg.language||'') === 'math') {
      MathJax.typesetPromise([el]).then(()=> {
        fitGeometryBox(el, STYLE.shape);
        autoFitText(el, FONT_SIZE, 12, STYLE.shape);
      });
    }

    // –ø–∞–¥–µ–Ω–∏–µ
    const vel = 1.2 + SPEED * 0.9;       // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
    const swayAmp = rnd(8, 22);          // –Ω–µ–±–æ–ª—å—à–æ–µ –∫–∞—á–∞–Ω–∏–µ
    const swayFreq = rnd(0.003, 0.008);  // —á–∞—Å—Ç–æ—Ç–∞
    let y = -140;
    let t = 0;
    let alive = true;

    function step(){
      if(!alive) return;
      y += vel; t += 1;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if(y > game.clientHeight + 200){
        alive = false;
        // —à—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ
        if(el.dataset.good === '1'){
          score = Math.max(0, score - 5);
          hudScore.textContent = score;
        }
        el.remove();
        return;
      }
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);

    // –∫–ª–∏–∫
    el.addEventListener('click', ()=>{
      if(!alive) return;
      if(el.dataset.good === '1'){
        score++; hudScore.textContent = score;
        playPop(el);
        alive = false;
        el.classList.add('caught');
        setTimeout(()=> el.remove(), 400);
      } else {
        // —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª–∏–∫
        score = Math.max(0, score - 1);
        hudScore.textContent = score;
        // ¬´—à—Ç—Ä–∞—Ñ¬ª: –≤—Å–ø—ã—à–∫–∞
        bg.style.filter = 'brightness(2) saturate(1.6) hue-rotate(-30deg)';
        setTimeout(()=> bg.style.filter = 'none', 220);
      }
    });
  }

  // ===== –≥–µ–æ–º–µ—Ç—Ä–∏—è —Ñ–∏–≥—É—Ä (–∫–≤–∞–¥—Ä–∞—Ç –¥–ª—è –∫—Ä—É–≥–∞/—Ä–æ–º–±–∞/–∑–≤–µ–∑–¥—ã), –æ—Ç—Å—Ç—É–ø—ã –∏ –∞–≤—Ç–æ—Ñ–∏—Ç —Ñ–æ–Ω–∞
  function fitGeometryBox(el, shape){
    const content = el.querySelector('.content');
    const bg = el.querySelector('.bg');

    // –∏–∑–º–µ—Ä–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç
    const rect = content.getBoundingClientRect();
    // –∏—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã = –∫–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑ ¬´—Å–∂–∞—Ç–∏—è¬ª
    let W = rect.width;
    let H = rect.height;

    // –µ—Å–ª–∏ —Ñ–∏–≥—É—Ä–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è ‚Äî –¥–µ–ª–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç + —á—É—Ç—å –≤–æ–∑–¥—É—Ö–∞
    if(shape === 'circle' || shape === 'diamond' || shape === 'star'){
      const size = Math.max(W, H) + 30; // +30 –≤–æ–∑–¥—É—Ö–∞ –≤–æ–∫—Ä—É–≥
      W = size;
      H = size;
    } else {
      // –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å + –Ω–µ–º–Ω–æ–≥–æ –≤–æ–∑–¥—É—Ö–∞
      W = Math.max(W + 10, 80);
      H = Math.max(H + 10, 60);
    }

    el.style.width = W + 'px';
    el.style.height = H + 'px';

    // —Ñ–æ–Ω-–∫–∞—Ä—Ç–∏–Ω–∫–∞ —É–∂–µ —Å—Ç–æ–∏—Ç –∫–∞–∫ contain; —Ü–≤–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç bg
    // –Ω–∏–∫–∞–∫–∏—Ö —á—ë—Ä–Ω—ã—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: bg –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é transparent
  }

  // ===== –∞–≤—Ç–æ-—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏–ª—Å—è =====
  function autoFitText(el, startPx, minPx, shape){
    const span = el.querySelector('.content span');
    if(!span) return;
    let fs = startPx;

    const content = el.querySelector('.content');
    const bg = el.querySelector('.bg');

    // –ø–æ—Å–ª–µ fitGeometryBox —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
    const maxW = el.clientWidth - 12; // –Ω–µ–º–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞
    const maxH = el.clientHeight - 12;

    const measure = ()=>{
      const r = span.getBoundingClientRect();
      return (r.width <= maxW && r.height <= maxH);
    };

    while(fs > minPx){
      span.style.fontSize = fs + 'px';
      if(measure()) break;
      fs -= 1;
    }
  }

  // ===== —ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ =====
  function playPop(el){
    try{ popSound.currentTime = 0; popSound.play(); }catch(_){}
    const r = el.getBoundingClientRect();
    for(let i=0;i<14;i++){
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.style.left = (r.left + r.width/2) + 'px';
      s.style.top  = (r.top  + r.height/2) + 'px';
      const angle = Math.random() * Math.PI * 2;
      const dist = 40 + Math.random()*70;
      s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
      s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
      s.style.animationDuration = (0.9 / (SPEED/5)) + 's';
      document.body.appendChild(s);
      setTimeout(()=> s.remove(), 1000);
    }
  }

  // ===== —Ñ–∏–Ω–∞–ª =====
  function showFinish(){
    const ov = document.createElement('div');
    ov.className = 'startOverlay';
    ov.innerHTML = `
      <div class="startPanel">
        <div class="startTitle">${i18n('–§–∏–Ω–∏—à! üéâ','Finish! üéâ','„Éï„Ç£„Éã„ÉÉ„Ç∑„É•! üéâ')}</div>
        <div style="opacity:.9; margin-bottom:6px">${i18n('–°—á—ë—Ç','Score','„Çπ„Ç≥„Ç¢')}: <b>${score}</b></div>
        <button class="startBtn" id="btnAgain">${i18n('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ','Play again','„ÇÇ„ÅÜ‰∏ÄÂ∫¶')}</button>
      </div>
    `;
    document.body.appendChild(ov);
    $('#btnAgain').onclick = ()=> location.reload();
  }

})();
</script>
</body>
</html>
